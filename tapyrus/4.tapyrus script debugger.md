# Tapyrus script debugger

最終更新 2023/07/08 Shigeichiro yamasaki

安土さんがTapyrusスクリプトのデバッガーをつくってくれました．
ぜひ利用してください
[https://github.com/chaintope/tapyrusrb/wiki/Script#script-debugger](https://github.com/chaintope/tapyrusrb/wiki/Script#script-debugger)

##  使い方

tapyrus core がインストールされていれば使えます．

```
$ tapyrus-script-debugger
Enter scriptPubkey: <Enter your scriptPubkey with hex format>
Enter scriptSig: <Enter your scriptSig with hex format>
Enter tx: <Enter your tx, if you have a signature verification opcode, like `OP_CHECKSIG`>
Enter index of the input: <Enter your input index>
The Script is ready to be executed; 
you can step execution it by putting the Enter key.
> 
```

[bitcoin scriptの仕様](https://en.bitcoin.it/wiki/Script)

[Tapyrus script の仕様](https://github.com/chaintope/tapyrus-core/blob/master/doc/tapyrus/script.md)

### tapyrusrb でデバッグしたいスクリプトを得る

```bash
irb
```

Ruby インタープリタで実行

```ruby
require 'tapyrus'
include Tapyrus
include Tapyrus::Opcodes

# サンプルスクリプト
#  3 + 4 = 7 の確認

script=Tapyrus::Script.new << OP_3 << OP_4 <<  OP_ADD << OP_7 << OP_EQUAL
# 3 + 4 = 7 が成功することの確認
script.run
=> true
```

#### script_pubkey と script_sig に分割する

3 と + 4 = 7 に分割

```ruby
# + 4 = 7  でロックされている
script_pubkey=(Tapyrus::Script.new << OP_4 <<  OP_ADD << OP_7 << OP_EQUAL).to_hex
=> "54935787"

# 3  でロックを解除する
script_sig=(Tapyrus::Script.new << OP_3).to_hex
=> "53"
```

##### tapyrus-script-debugger

shell から実行

この場合，tx や index は指定しないので， enter を入れればよい

```bash
$ tapyrus-script-debugger
Enter scriptPubkey: 54935787
4 OP_ADD 7 OP_EQUAL
Enter scriptSig: 53
3
Enter tx: 
The Script is ready to be executed; you can step execution it by putting the Enter key.
> 
APPLY 3
+---------------+
| Current Stack |
+---------------+
| 03            |
+---------------+
> 
APPLY 4
+---------------+
| Current Stack |
+---------------+
| 04            |
| 03            |
+---------------+
> 
APPLY OP_ADD
+---------------+
| Current Stack |
+---------------+
| 07            |
+---------------+
> 
APPLY 7
+---------------+
| Current Stack |
+---------------+
| 07            |
| 07            |
+---------------+
> 
APPLY OP_EQUAL
+---------------+
| Current Stack |
+---------------+
| 01            |
+---------------+
> 
Execution finished.
```


### secret hash の場合

ハッシュの原像を入れるとロックが解除される

```ruby
# 原像
secret='HTLC_test'
# ハッシュ値
secret_hash=Tapyrus.sha256(secret)
# ハッシュ値の検証 secret_hash = SHA256(secret)
ts=Tapyrus::Script.new << secret.bth << OP_SHA256 << secret_hash << OP_EQUAL
ts.run
=> true
```

#### script_pubkey と script_sig に分割する


```ruby
# secret_hash = SHA256(X)
script_pubkey=(Tapyrus::Script.new  << OP_SHA256 << secret_hash << OP_EQUAL).to_hex
=> "a820996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e35787"

# secret
script_sig =(Tapyrus::Script.new  <<  secret.bth).to_hex
=> "0948544c435f74657374"
```

##### tapyrus-script-debugger

shell から実行

この場合，tx や index は指定しないので， enter を入れればよい

```bash
$ tapyrus-script-debugger
Enter scriptPubkey: a820996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e35787
OP_SHA256 996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e357 OP_EQUAL
Enter scriptSig: 0948544c435f74657374
48544c435f74657374
Enter tx: 
The Script is ready to be executed; you can step execution it by putting the Enter key.
> 
PUSH 48544c435f74657374
+--------------------+
|   Current Stack    |
+--------------------+
| 48544c435f74657374 |
+--------------------+
> 
APPLY OP_SHA256
+------------------------------------------------------------------+
|                          Current Stack                           |
+------------------------------------------------------------------+
| 996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e357 |
+------------------------------------------------------------------+
> 
PUSH 996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e357
+------------------------------------------------------------------+
|                          Current Stack                           |
+------------------------------------------------------------------+
| 996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e357 |
| 996bf59473947d9906275f427ecb318371514db2ffb8e9d8517b5e45cb65e357 |
+------------------------------------------------------------------+
> 
APPLY OP_EQUAL
+---------------+
| Current Stack |
+---------------+
| 01            |
+---------------+
> 
Execution finished.
```

### トランザクションの署名を含むスクリプトの検証

OP_CHECKSIG などを含む場合

```ruby
script_pubkey = locked_tx.out[0].script_pubkey.to_hex
=> "a914b0eee905795630943ed0bf58e447d231db3ff4ee87"

script_sig = unlock_tx.inputs[0].script_sig.to_hex
=> "004730440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701473044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e014c695221032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e72922102f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d21035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c353ae"

tx = unlock_tx.to_hex
=> "0100000001a0b42c98fabc39e06b6ab5cb5288f4b9460751801dc087dfff9fd05cc61378df00000000fc004730440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701473044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e014c695221032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e72922102f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d21035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c353aeffffffff01401f0000000000001976a9143b8050a0d309b26c604b22f06e14f614985bd62388ac00000000"
```

### tapyrus-script-debugger の実行

シェルから 16進数形式でデータを入力する

scriptPubkey と scriptSig と tx の16進形式が必要

```bash
tapyrus-script-debugger
Enter scriptPubkey: a914b0eee905795630943ed0bf58e447d231db3ff4ee87
OP_HASH160 b0eee905795630943ed0bf58e447d231db3ff4ee OP_EQUAL
Enter scriptSig: 004730440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701473044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e014c695221032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e72922102f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d21035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c353ae
0 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 5221032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e72922102f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d21035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c353ae
Enter tx: 010000000100000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0150c30000000000001976a9147dd164c8fde4679f938ea269c96d135524114b2e88ac00000000
Enter index of the input: 0
The Script is ready to be executed; you can step execution it by putting the Enter key.
> 
APPLY 0
+---------------+
| Current Stack |
+---------------+

+---------------+
> 
PUSH 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
PUSH 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
PUSH 5221032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e72922102f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d21035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c353ae
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                                                   Current Stack                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 5221032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e72922102f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d21035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c353ae |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01                                                                     |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701                                                                     |

+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
> 
APPLY OP_HASH160
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| b0eee905795630943ed0bf58e447d231db3ff4ee                                                                                                       |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
PUSH b0eee905795630943ed0bf58e447d231db3ff4ee
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| b0eee905795630943ed0bf58e447d231db3ff4ee                                                                                                       |
| b0eee905795630943ed0bf58e447d231db3ff4ee                                                                                                       |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
APPLY OP_EQUAL
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 01                                                                                                                                             |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
APPLY 2
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 02                                                                                                                                             |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
PUSH 032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e7292
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e7292                                                                             |
| 02                                                                                                                                             |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
PUSH 02f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 02f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d                                                                             |
| 032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e7292                                                                             |
| 02                                                                                                                                             |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
PUSH 035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c3
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c3                                                                             |
| 02f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d                                                                             |
| 032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e7292                                                                             |
| 02                                                                                                                                             |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
APPLY 3
+------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                                 Current Stack                                                                  |
+------------------------------------------------------------------------------------------------------------------------------------------------+
| 03                                                                                                                                             |
| 035a5d7e83fac0cc5f03f88d9c06453114f170e903968322372f769ad5a6a5e7c3                                                                             |
| 02f0b922a5c2fe55b39ef70666f73959442133d1c1daa382c90bd2c3dda66b534d                                                                             |
| 032f04706a999dc831bacf23f84554b0eb026a79bd76a204449a91401d963e7292                                                                             |
| 02                                                                                                                                             |
| 3044022037aafc3a25de9a4e420a1f946e1f688ccf6a7f67b83a8272af829361767b2bbe02203cb1e5e1ea2e18fd3e9d8573a62cb06e053f63a371d8f6f4bf304961f2b4af0e01 |
| 30440220417978edb425afbd473e057fbbf5af7b5bdd732a24cff4ca32d23040189d4800022017daa1898e9a0f3a84069d2d15416b037121429ff89d3e6a3880cae00a72ca5701 |

+------------------------------------------------------------------------------------------------------------------------------------------------+
> 
APPLY OP_CHECKMULTISIG
+---------------+
| Current Stack |
+---------------+

+---------------+
> 
Execution finished.
```

