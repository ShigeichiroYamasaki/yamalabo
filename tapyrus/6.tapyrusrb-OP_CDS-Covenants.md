# tapyrusrb OP_CDS によるCovenantsの実現

最終更新 2023/07/07 Shigeichiro Yamasaki

## bitcoinの課題

bitcoinスクリプトは，output の宛先や金額を参照することができない．
これは，スクリプトでスマートコントラクトを作成するときに問題になる．

例えば，スクリプトを使って，トランザクションの送金先やその金額を指定したい場合がそれに該当する．

## Covenants

Covenantsは，スクリプトでトランザクションのアウトプットを検証することで、ロックされたUTXOの送金先や送金額などを自由に変更できないようにする方法．

オリジナルの bitcoin にはない，`OP_CDS (OP_CHECKDATASIG)` というオペコードの追加で Covenants が実現できるようになる．

#### OP_CDS

署名、メッセージおよび公開鍵を受け取り、メッセージに対する署名を検証する
Scriptの中でトランザクション以外のデータに対して署名の検証ができる

```
<sig> <msg> <pubKey> OP_CHECKDATASIG
```

* <sig> が <msg> <pubKey> で検証して成功すれば true になる

#### Covenants の実現方法

* UTXO は P2SH (Covenants) でロックされている．
* このUTXOをアンロックするトランザクションのテンプレート（未署名）をシリアライズする → これを **preimage** と呼ぶ
* このアンロックトランザクションの output には指定する送金先や金額が入っている．
* `<msg>` をこの preimage にし，`<sig>` を preimage への署名とする
* 実際に UTXO をアンロックするトランザクションを作成する
  * アンロックトランザクションの output は，指定するアドレスと金額にする
  * redeem Script の内容
    * `OP_
