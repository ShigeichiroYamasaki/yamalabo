# tapyrusrb OP_CDS によるCovenantsの実現

最終更新 2023/07/07 Shigeichiro Yamasaki

## bitcoinの課題

bitcoinスクリプトは，output の宛先や金額を参照することができない．
これは，スクリプトでスマートコントラクトを作成するときに問題になる．

例えば，スクリプトを使って，トランザクションの送金先やその金額を指定したい場合がそれに該当する．

```
    ---------------        ---------------
    |input |output|        |input |output| 
    |      | UTXO | -----> |      | 宛先  |
    |      | ロック|        |      | 金額  |
    ---------------        ---------------
               ↓              ↑     ↑
             P2SH  ------->   スクリプト
```

## Covenants

Covenantsは，スクリプトでトランザクションのアウトプットを検証することで、ロックされたUTXOの送金先や送金額などを自由に変更できないようにする方法．

オリジナルの bitcoin にはない，`OP_CDS (OP_CHECKDATASIG)` というオペコードの追加で Covenants が実現できるようになる．

#### OP_CDS

署名、メッセージおよび公開鍵を受け取り、メッセージに対する署名を検証する
Scriptの中でトランザクション以外のデータに対して署名の検証ができる

```
<sig> <msg> <pubKey> OP_CHECKDATASIG
```

* <sig> が <msg> <pubKey> で検証して成功すれば true になる

#### Covenants の実現方法

* UTXO は P2SH (Covenants) でロックされている．（単純化のため，ロックされた金額は一定とする）
* このUTXOをアンロックするトランザクションのテンプレート（未署名）をシリアライズする → これを **preimage** と呼ぶ
* このアンロックトランザクションの output には指定する送金先や金額が入っている．
* `<msg>` をこの preimage にし，`<sig>` を preimage への署名とする
* 実際に UTXO をアンロックするトランザクションを作成する
  * アンロックトランザクションの output は，指定するアドレスと金額にする（`<preimage>` と同じ構造のトランザクションになる）
  * redeem Script の内容
    1. `OP_CHECKSIG` で `<pubKey>` と `<sig>` を使いトランザクションを検証
    2. `OP_CDS` で `<pubKey>` と `<sig>` を使い `<preimage>` を検証
    3. `<preimage>` の送金先と金額を検証


#### preimage のシリアライズ方法

署名対象をトランザクションの output 部分に限定し，トランザクションの署名対象を

|     フィールド                    |  内容                      |
|:--                       | :--                    |
|nVersion  |(4-byte little endian)|
|hashPrevouts |(32-byte hash)|
|nSequence |(32-byte)|
|outpoint |(32-byte hash + 4-byte little endian)|
|scriptCode of the input |(serialized as scripts inside CTxOuts)|
|value of the output |(8-byte little endian)|
|nSequence of the input |(4-byte little endian)|
|hashOutputs |(32-byte hash)|
|nLocktime  |(4-byte little endian)|
|sighash type of the signature| (4-byte little endian)|
