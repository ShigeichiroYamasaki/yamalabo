# 3. bitcoin core の詳細-2

2024/06/13  更新 Shigeichiro Yamasaki

## 各種トランザクションの構成を一連の流れで演習します

ubuntu での実施を前提にします．


1.  3 種類のoutput (P2PKH,  P2WPKH,  P2TR)を持つトランザクション TX1 をブロードキャストする

```
(UTXOの資金)--> TX1 -+-->0.0002BTC VOUT:1 -->TX3(P2PKH) --> 0.00018BTC
                    +-->0.0002BTC VOUT:2 
                    +-->0.0002BTC VOUT:3 -->TX5(P2WPKH)--> 0.00018BTC
                    +-->0.0002BTC VOUT:4 
                    +-->0.0002BTC VOUT:5 -->TX7(P2TR)  --> 0.00018BTC
                    +-->おつり
```

## 目次

* [シェル変数の復元](#RESTORE)
* [アドレス情報の確認](#ADDRESS)
* [6種類のUTXOの確認](#UTXO)
* P2PKH
* P2WPKH
* P2TR

* [descriptor の確認](#IMPORT)

##  <a id="RESTORE">シェル変数の復元</a>

前回の演習の最後で保存していたシェル変数のバックアップファイルをシェルに評価させて復元します．

以下は例です．

自分のバックアップファイルから復元してください

```bash
TARO="tb1qd3la0q64a5qt5l4aka00jq495ry7d7gws84kf8"
BOB="tb1qctzkewtgryz548ajasuf526nfmdu5qum3alec6"
BP2PK_ADDROB="0226e09f8d39f0329ffc996076d5b8cdab14e4e1f71daf9cdeb2fbf31c2e0b70fa"
P2PKH_ADDR="n3ExacD1dFiMLL37u4j5YsR1SBcqi7qCFA"
SIGNER1="tb1qvd9dl3hvtap455l74f4l2fhw0sflwjduljz33n"
SIGNER2="tb1qwyxcedp2rjt4uxpvs6nrp62la8rsx2rk7u5gfl"
SIGNER3="tb1qd5d453dkaqh4kjs5xq574y4pq0pk8w8n7du8a6"
PUBKEY1="0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6"
PUBKEY2="03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280"
PUBKEY3="02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da"
P2SH='{
  "address": "2NFV3cvYv7Lo9LRdwaWmC2Anusn81G4cLvZ",
  "redeemScript": "52210222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe62103db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd502802102fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da53ae",
  "descriptor": "sh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#qvpxamev"
}'
P2SH_ADDR="2NFV3cvYv7Lo9LRdwaWmC2Anusn81G4cLvZ"
P2SH_REDEEMSCRIPT="52210222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe62103db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd502802102fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da53ae"
P2SH_DESCRIPTOR="sh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#qvpxamev"
P2WPKH_ADDR="tb1q6zy2jxjry280wq64m2gvl9sfnvhvy4t3w05ljv"
P2WSH='{
  "address": "tb1q4d6dwjfuklrkc3qh4u6np5shtl57rxkdmej4n8c4sarggh992cas33t5p0",
  "redeemScript": "52210222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe62103db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd502802102fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da53ae",
  "descriptor": "wsh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#lfmqcn4l"
}'
P2WSH_ADDR="tb1q4d6dwjfuklrkc3qh4u6np5shtl57rxkdmej4n8c4sarggh992cas33t5p0"
P2WSH_REDEEMSCRIPT="52210222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe62103db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd502802102fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da53ae"
P2WSH_DESCRIPTOR="wsh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#lfmqcn4l"
P2TR_ADDR="tb1prg0ygugk6wmqlmd5hvl46nywmmckqhu6eqdymttxt2tt8s238sqssm7krw"
UNSIGNED_TX="02000000012ed86ea54823f1b390b3473a576a4dcf2352e2336f3c003025164b24aadf16f60000000000fdffffff06204e0000000000001976a914ee4c59a05db9e4f2449346061a064f90dd59239688ac204e00000000000017a914f3efef8aa6faf6e9bea495d8eb27767e7bd333d487204e000000000000160014d088a91a43228ef70355da90cf96099b2ec25571204e000000000000220020ab74d7493cb7c76c4417af3530d2175fe9e19acdde65599f158746845ca5563b204e0000000000002251201a1e447116d3b60fedb4bb3f5d4c8edef1605f9ac81a4dad665a96b3c1513c01b0650d00000000001600146c7fd78355ed00ba7ebdb75ef902a5a0c9e6f90e00000000"
SIGNED_TX_HEX="020000000001012ed86ea54823f1b390b3473a576a4dcf2352e2336f3c003025164b24aadf16f60000000000fdffffff06204e0000000000001976a914ee4c59a05db9e4f2449346061a064f90dd59239688ac204e00000000000017a914f3efef8aa6faf6e9bea495d8eb27767e7bd333d487204e000000000000160014d088a91a43228ef70355da90cf96099b2ec25571204e000000000000220020ab74d7493cb7c76c4417af3530d2175fe9e19acdde65599f158746845ca5563b204e0000000000002251201a1e447116d3b60fedb4bb3f5d4c8edef1605f9ac81a4dad665a96b3c1513c01b0650d00000000001600146c7fd78355ed00ba7ebdb75ef902a5a0c9e6f90e02473044022036c2b90918a45669bf5ba7795d0515ed5bf39484f4a5cce5da0af8e14b9865e502200e003fe97f4874f2398da6c94d0a0217ad2c8f0946d1c2a3782de01111bdbc840121035701c8785279c4ca4eb9e792428404e609b2f6a07f2b7e13b781c2d02c752def00000000"
SENT_TXID="557adafc853f70a405a9e271ab4b5e8b308049ba18792361d2d82c0317271c33"
```

## <a id="ADDRESS">アドレス情報の確認</a>

### P2PKHアドレス

```bash
bitcoin-core.cli getaddressinfo $P2PKH_ADDR
=>
{
  "address": "n3ExacD1dFiMLL37u4j5YsR1SBcqi7qCFA",
  "scriptPubKey": "76a914ee4c59a05db9e4f2449346061a064f90dd59239688ac",
  "ismine": true,
  "solvable": true,
  "desc": "pkh([c4317781/44h/1h/0h/0/2]02f892126df2459ca403ee963b92e3fe25355780d4192be8569e1a544553068fcf)#7udsu0qd",
  "parent_desc": "pkh([c4317781/44h/1h/0h]tpubDDMz7udSzrtsvFo3LEnVxz5HEaPyRgajwwU7Fr1F55Xkxmbu9NPAjeLK6vvsDYB6eqU7Phd22kLD8jHnCUhT9YqDpAZ3HTfNLawsMeY6Wwr/0/*)#pqj50jhx",
  "iswatchonly": false,
  "isscript": false,
  "iswitness": false,
  "pubkey": "02f892126df2459ca403ee963b92e3fe25355780d4192be8569e1a544553068fcf",
  "iscompressed": true,
  "ischange": false,
  "timestamp": 1716908333,
  "hdkeypath": "m/44h/1h/0h/0/2",
  "hdseedid": "0000000000000000000000000000000000000000",
  "hdmasterfingerprint": "c4317781",
  "labels": [
    "pkh_user"
  ]
}
```


### P2SHアドレス

```bash
bitcoin-core.cli getaddressinfo $P2SH_ADDR
=>
{
  "address": "2NFV3cvYv7Lo9LRdwaWmC2Anusn81G4cLvZ",
  "scriptPubKey": "a914f3efef8aa6faf6e9bea495d8eb27767e7bd333d487",
  "ismine": false,
  "solvable": false,
  "iswatchonly": false,
  "isscript": true,
  "iswitness": false,
  "ischange": false,
  "labels": [
  ]
}

```



### P2WPKHアドレス

```bash
bitcoin-core.cli getaddressinfo $P2WPKH_ADDR
=>
{
  "address": "tb1q6zy2jxjry280wq64m2gvl9sfnvhvy4t3w05ljv",
  "scriptPubKey": "0014d088a91a43228ef70355da90cf96099b2ec25571",
  "ismine": true,
  "solvable": true,
  "desc": "wpkh([c4317781/84h/1h/0h/0/24]032bd958132aaed2ea27cd8b1d3e31f4dba13543d3ef1bc9c55b6491934a4fd550)#d93g0dad",
  "parent_desc": "wpkh([c4317781/84h/1h/0h]tpubDDThUseTsE7BrL9L7K6cNLBfSjLa8zdMVuqEfsiDjgv8WtkG3VScT9HJ8sKAfcWG8NoXD25bd5h8rNwGSep2frEdVtGfQm4n8mQYPjh2DHh/0/*)#w9yrknfc",
  "iswatchonly": false,
  "isscript": false,
  "iswitness": true,
  "witness_version": 0,
  "witness_program": "d088a91a43228ef70355da90cf96099b2ec25571",
  "pubkey": "032bd958132aaed2ea27cd8b1d3e31f4dba13543d3ef1bc9c55b6491934a4fd550",
  "ischange": false,
  "timestamp": 1716908333,
  "hdkeypath": "m/84h/1h/0h/0/24",
  "hdseedid": "0000000000000000000000000000000000000000",
  "hdmasterfingerprint": "c4317781",
  "labels": [
    "wpkh_user"
  ]
}

```


### P2WSHアドレス

```bash
bitcoin-core.cli getaddressinfo $P2WSH_ADDR
=>
{
  "address": "tb1q4d6dwjfuklrkc3qh4u6np5shtl57rxkdmej4n8c4sarggh992cas33t5p0",
  "scriptPubKey": "0020ab74d7493cb7c76c4417af3530d2175fe9e19acdde65599f158746845ca5563b",
  "ismine": false,
  "solvable": false,
  "iswatchonly": false,
  "isscript": true,
  "iswitness": true,
  "witness_version": 0,
  "witness_program": "ab74d7493cb7c76c4417af3530d2175fe9e19acdde65599f158746845ca5563b",
  "ischange": false,
  "labels": [
  ]
}

```


### P2TRアドレス

```bash
bitcoin-core.cli getaddressinfo $P2TR_ADDR
=>
{
  "address": "tb1prg0ygugk6wmqlmd5hvl46nywmmckqhu6eqdymttxt2tt8s238sqssm7krw",
  "scriptPubKey": "51201a1e447116d3b60fedb4bb3f5d4c8edef1605f9ac81a4dad665a96b3c1513c01",
  "ismine": true,
  "solvable": true,
  "desc": "tr([c4317781/86h/1h/0h/0/1]10b5af06b4098b86c401aef6794e481e77477da30dabd11b20526a16475d6916)#vna06urd",
  "parent_desc": "tr([c4317781/86h/1h/0h]tpubDD5feT2A4eyTwqutfWYMVVcMdFpu7kLo4bTqBDD9pH2A7reog3sdc1nwNKSxS3qC6jatg6Fq8xZFi9MEEUwWceqXWxoG5V87xtgVf4Mrpac/0/*)#cvtldceg",
  "iswatchonly": false,
  "isscript": true,
  "iswitness": true,
  "witness_version": 1,
  "witness_program": "1a1e447116d3b60fedb4bb3f5d4c8edef1605f9ac81a4dad665a96b3c1513c01",
  "ischange": false,
  "timestamp": 1716908333,
  "hdkeypath": "m/86h/1h/0h/0/1",
  "hdseedid": "0000000000000000000000000000000000000000",
  "hdmasterfingerprint": "c4317781",
  "labels": [
    "tr_user"
  ]
}
```

## <a id="UTXO">6種類の UTXO の確認</a>


```bash
UTXOS=`bitcoin-core.cli listunspent`
```

### UTXOを一つずつ確認

各UTXOの "desc" の値を確認
各UTXOの "address" の値を確認

pkh(), wpkh(), tr() のUTXOを見つける

```bash
echo $UTXOS|jq '.[0].desc'
=>
"pkh([c4317781/44h/1h/0h/0/2]02f892126df2459ca403ee963b92e3fe25355780d4192be8569e1a544553068fcf)#7udsu0qd"

echo $UTXOS|jq '.[0].address'
=>
"n3ExacD1dFiMLL37u4j5YsR1SBcqi7qCFA"

echo $UTXOS|jq '.[1].desc'
=>
"wpkh([c4317781/84h/1h/0h/0/31]035701c8785279c4ca4eb9e792428404e609b2f6a07f2b7e13b781c2d02c752def)#glp2qarz"

echo $UTXOS|jq '.[1].address'
=>
"tb1qd3la0q64a5qt5l4aka00jq495ry7d7gws84kf8"

...

echo $UTXOS|jq '.[9].desc'
=>
"tr([c4317781/86h/1h/0h/1/0]1f0c6f9ded2359813cce076b53005a229b3d8a2caeb617a0adabf73b26f8391b)#6hch3ltl"

echo $UTXOS|jq '.[9].address'
=>
"tb1pj56xf3utuyzkf687xhtj69cf8g6yh4pvee5k9d4g9y2hd4387fvqv22cju"
```

### アドレスを確認してUTXOを決定する

* P2PKH のUTXO はこの例では インデックス 0

```bash
echo $P2PKH_ADDR
=>
n3ExacD1dFiMLL37u4j5YsR1SBcqi7qCFA

UTXO_P2PKH=`echo $UTXOS|jq '.[0]'`

echo $UTXO_P2PKH
=>
{ "txid": "557adafc853f70a405a9e271ab4b5e8b308049ba18792361d2d82c0317271c33", "vout": 0, "address": "n3ExacD1dFiMLL37u4j5YsR1SBcqi7qCFA", "label": "pkh_user", "scriptPubKey": "76a914ee4c59a05db9e4f2449346061a064f90dd59239688ac", "amount": 0.00020000, "confirmations": 615, "spendable": true, "solvable": true, "desc": "pkh([c4317781/44h/1h/0h/0/2]02f892126df2459ca403ee963b92e3fe25355780d4192be8569e1a544553068fcf)#7udsu0qd", "parent_descs": [ "pkh(tpubD6NzVbkrYhZ4WMdAbdLz46exTnUp5Q3K7voVX1AZ26FqvuHfGfKZ6XdreuQzvhzoCCX4ayjsSx7xSXVaxn1pxr1qbix2SYYMLNxbgtifkMT/44h/1h/0h/0/*)#75tfa5h9" ], "safe": true }
```


* P2WPKH のUTXOは この例では インデックス 8 

```bash
echo $P2WPKH_ADDR
=>
tb1q6zy2jxjry280wq64m2gvl9sfnvhvy4t3w05ljv


UTXO_P2WPKH=`echo $UTXOS|jq '.[8]'`

echo $UTXO_P2WPKH
=>
{ "txid": "557adafc853f70a405a9e271ab4b5e8b308049ba18792361d2d82c0317271c33", "vout": 2, "address": "tb1q6zy2jxjry280wq64m2gvl9sfnvhvy4t3w05ljv", "label": "wpkh_user", "scriptPubKey": "0014d088a91a43228ef70355da90cf96099b2ec25571", "amount": 0.00020000, "confirmations": 615, "spendable": true, "solvable": true, "desc": "wpkh([c4317781/84h/1h/0h/0/24]032bd958132aaed2ea27cd8b1d3e31f4dba13543d3ef1bc9c55b6491934a4fd550)#d93g0dad", "parent_descs": [ "wpkh(tpubD6NzVbkrYhZ4WMdAbdLz46exTnUp5Q3K7voVX1AZ26FqvuHfGfKZ6XdreuQzvhzoCCX4ayjsSx7xSXVaxn1pxr1qbix2SYYMLNxbgtifkMT/84h/1h/0h/0/*)#w3yerj76" ], "safe": true }
```

* P2TR のUTXOは この例では インデックス 9

```bash
echo $P2TR_ADDR
=>
tb1prg0ygugk6wmqlmd5hvl46nywmmckqhu6eqdymttxt2tt8s238sqssm7krw


UTXO_P2TR=`echo $UTXOS|jq '.[9]'`

echo $UTXO_P2TR
=>
{ "txid": "963749a3ce3b770157c3b05c2b29715e0e5cf2a1e8e34aab5f39d5e6a7ae8737", "vout": 0, "address": "tb1pj56xf3utuyzkf687xhtj69cf8g6yh4pvee5k9d4g9y2hd4387fvqv22cju", "scriptPubKey": "5120953464c78be10564e8fe35d72d17093a344bd42cce6962b6a8291576d627f258", "amount": 0.00697768, "confirmations": 22, "spendable": true, "solvable": true, "desc": "tr([c4317781/86h/1h/0h/1/0]1f0c6f9ded2359813cce076b53005a229b3d8a2caeb617a0adabf73b26f8391b)#6hch3ltl", "parent_descs": [ "tr(tpubD6NzVbkrYhZ4WMdAbdLz46exTnUp5Q3K7voVX1AZ26FqvuHfGfKZ6XdreuQzvhzoCCX4ayjsSx7xSXVaxn1pxr1qbix2SYYMLNxbgtifkMT/86h/1h/0h/1/*)#0l0qwhcu" ], "safe": true }
```

## P2PKH

### P2PKH タイプのUTXOの確認


トランザクションIDとVOUT と金額の確認

```bash
TXID_PKH=`echo $UTXO_PKH|jq -r .txid`

echo $TXID_PKH
=>
557adafc853f70a405a9e271ab4b5e8b308049ba18792361d2d82c0317271c33

VOUT_PKH=`echo $UTXO_PKH|jq -r .vout`

echo $VOUT_PKH
=>
0

AMOUNT_PKH=`echo $UTXO_PKH|jq -r .amount`

echo $AMOUNT_PKH
=>
0.00020000
```

* 送金先はTAROとします

```bash
echo $TARO
=>
tb1qd3la0q64a5qt5l4aka00jq495ry7d7gws84kf8
```

* 送金金額

FEE 0.00002
AMOUNTは 0.0002-0.00002 = 0.00018

### P2PKH トランザクションの作成

```bash
INPUT_PKH="[{\"txid\":\"$TXID_PKH\",\"vout\": $VOUT_PKH}]"
OUTPUT_PKH="[{\"$TARO\": 0.00018}]"
```

未署名のトランザクション

```bash
UNSIGNED_TX=`bitcoin-core.cli createrawtransaction "'$INPUT_PKH $OUTPUT_PKH'"`
```

### 送金先と金額

送金先は BOB

送金金額は UTXOの金額 - 手数料とします．

手数料は， 0.00002 BTC

```bash
bitcoin-core.cli getnewaddress 
=>
tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue
```

送金金額：0.00088-0.00002=0.00086

### 6つのinputを持つ未署名のトランザクションの作成

P2PK, P2PKH, P2SH, P2WPKH, P2WSH, P2TR の順で作成する

```bash
bitcoin-core.cli createrawtransaction  '[{"txid":"08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c","vout":0},{"txid":"6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2","vout":0},{"txid":"a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41","vout":0},{"txid":"aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a","vout":0},{"txid":"89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e","vout":0}]'  '[{"tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue": 0.00086}]'
=>
02000000059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c70080000000000ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a0000000000ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa00000000000ffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b00000000
```

### トランザクションへの署名

実際の運用では，マルチシグは複数の主体のワレットで順番に署名する必要があります。

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c70080000000000ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a0000000000ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa00000000000ffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b00000000
=>
{
  "hex": "020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000",
  "complete": true
}
```

### 作成したトランザクションの構造

```bash
bitcoin-core.cli decoderawtransaction 020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000
=>
{
  "txid": "11f36ca7c4840c2cd24dd58d061bd30ccad3a8e0885920dd6daca9c855372756",
  "hash": "bd8acb3055541202a3de6fb53dfa5fe1d82e00b334ab7223884f9aa68c1f06f6",
  "version": 2,
  "size": 1040,
  "vsize": 767,
  "weight": 3068,
  "locktime": 0,
  "vin": [
    {
      "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
      "vout": 0,
      "scriptSig": {
        "asm": "304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd[ALL]",
        "hex": "47304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01"
      },
      "sequence": 4294967295
    },
    {
      "txid": "6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2",
      "vout": 0,
      "scriptSig": {
        "asm": "30440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf0834[ALL] 0222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701",
        "hex": "4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701"
      },
      "sequence": 4294967295
    },
    {
      "txid": "a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41",
      "vout": 0,
      "scriptSig": {
        "asm": "0 304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa[ALL] 304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f[ALL] 52210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae",
        "hex": "0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae"
      },
      "sequence": 4294967295
    },
    {
      "txid": "aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f01",
        "031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b"
      ],
      "sequence": 4294967295
    },
    {
      "txid": "89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "",
        "304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d68501",
        "30440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b468001",
        "52210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae"
      ],
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00086000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 bcbc428f81a3c209f316e03fc46751ccd294709b",
        "desc": "addr(tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue)#qxp8yjj5",
        "hex": "0014bcbc428f81a3c209f316e03fc46751ccd294709b",
        "address": "tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}

```

### 署名済のトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000
=>
11f36ca7c4840c2cd24dd58d061bd30ccad3a8e0885920dd6daca9c855372756
```










## <a id="IMPORT"> </a>descriptor の確認

### ワレットの確認

* ワレットの一覧

現在は eve だけになっているはずです．

そうでないときには，こまでアドレス生成を行ったワレット１つだけになるよう，他のワレットを unload してください．

```bash
bitcoin-core.cli listwallets

# 複数ロードされている場合
[
  "eve"
]
```

### ワレットにインポート済の descriptor の確認

* ワレットに格納されている descriptor 確認

```bash
bitcoin-core.cli listdescriptors

=>
{
  "wallet_name": "eve",
  "descriptors": [
    {
      "desc": "pkh([c4317781/44h/1h/0h]tpubDDMz7udSzrtsvFo3LEnVxz5HEaPyRgajwwU7Fr1F55Xkxmbu9NPAjeLK6vvsDYB6eqU7Phd22kLD8jHnCUhT9YqDpAZ3HTfNLawsMeY6Wwr/0/*)#pqj50jhx",
      "timestamp": 1716908333,
      "active": true,
      "internal": false,
      "range": [
        0,
        1002
      ],
      "next": 3,
      "next_index": 3
    },
    {
      "desc": "pkh([c4317781/44h/1h/0h]tpubDDMz7udSzrtsvFo3LEnVxz5HEaPyRgajwwU7Fr1F55Xkxmbu9NPAjeLK6vvsDYB6eqU7Phd22kLD8jHnCUhT9YqDpAZ3HTfNLawsMeY6Wwr/1/*)#s5h4j887",
      "timestamp": 1716908334,
      "active": true,
      "internal": true,
      "range": [
        0,
        999
      ],
      "next": 0,
      "next_index": 0
    },
    {
      "desc": "sh(wpkh([c4317781/49h/1h/0h]tpubDDVfYvvwZwjhGRjPtev3Gi2Ka6QiEpGrBQJNvU1HgTGRtSyJDh46octbCZAL8octtDqC7d9eTp4QQnANz2eUhKYAb9iGnDsH2xB19e8ajgn/0/*))#dfqz4377",
      "timestamp": 1716908333,
      "active": true,
      "internal": false,
      "range": [
        0,
        999
      ],
      "next": 0,
      "next_index": 0
    },
    {
      "desc": "sh(wpkh([c4317781/49h/1h/0h]tpubDDVfYvvwZwjhGRjPtev3Gi2Ka6QiEpGrBQJNvU1HgTGRtSyJDh46octbCZAL8octtDqC7d9eTp4QQnANz2eUhKYAb9iGnDsH2xB19e8ajgn/1/*))#cgw5dwtp",
      "timestamp": 1716908334,
      "active": true,
      "internal": true,
      "range": [
        0,
        999
      ],
      "next": 0,
      "next_index": 0
    },
    {
      "desc": "tr([c4317781/86h/1h/0h]tpubDD5feT2A4eyTwqutfWYMVVcMdFpu7kLo4bTqBDD9pH2A7reog3sdc1nwNKSxS3qC6jatg6Fq8xZFi9MEEUwWceqXWxoG5V87xtgVf4Mrpac/0/*)#cvtldceg",
      "timestamp": 1716908333,
      "active": true,
      "internal": false,
      "range": [
        0,
        1001
      ],
      "next": 2,
      "next_index": 2
    },
    {
      "desc": "tr([c4317781/86h/1h/0h]tpubDD5feT2A4eyTwqutfWYMVVcMdFpu7kLo4bTqBDD9pH2A7reog3sdc1nwNKSxS3qC6jatg6Fq8xZFi9MEEUwWceqXWxoG5V87xtgVf4Mrpac/1/*)#fcw7sdfs",
      "timestamp": 1716908334,
      "active": true,
      "internal": true,
      "range": [
        0,
        999
      ],
      "next": 0,
      "next_index": 0
    },
    {
      "desc": "wpkh([c4317781/84h/1h/0h]tpubDDThUseTsE7BrL9L7K6cNLBfSjLa8zdMVuqEfsiDjgv8WtkG3VScT9HJ8sKAfcWG8NoXD25bd5h8rNwGSep2frEdVtGfQm4n8mQYPjh2DHh/0/*)#w9yrknfc",
      "timestamp": 1716908333,
      "active": true,
      "internal": false,
      "range": [
        0,
        1031
      ],
      "next": 32,
      "next_index": 32
    },
    {
      "desc": "wpkh([c4317781/84h/1h/0h]tpubDDThUseTsE7BrL9L7K6cNLBfSjLa8zdMVuqEfsiDjgv8WtkG3VScT9HJ8sKAfcWG8NoXD25bd5h8rNwGSep2frEdVtGfQm4n8mQYPjh2DHh/1/*)#l3pztxeq",
      "timestamp": 1716908334,
      "active": true,
      "internal": true,
      "range": [
        0,
        999
      ],
      "next": 0,
      "next_index": 0
    }
  ]
}

```


### importdescriptors コマンド

タイムスタンプにもとづいて過去のブロックチェーン内の descriptor の検索を行います．（あまり古いタイムスタンプを指定すると時間がかかります）

最初に（IBD開始前に）ブロックチェーンの起動パラメータで blockfilterindex=1 を指定しておけば，大幅に高速化されます．

* importdescriptors コマンドの引数

```
Arguments:
1. requests                                 (json array, required) Data to be imported
     [
       {                                    (json object)
         "desc": "str",                     (string, required) Descriptor to import.
         "active": bool,                    (boolean, optional, default=false) Set this descriptor to be the active descriptor for the corresponding output type/externality
         "range": n or [n,n],               (numeric or array, optional) If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import
         "next_index": n,                   (numeric, optional) If a ranged descriptor is set to active, this specifies the next index to generate addresses from
         "timestamp": timestamp | "now",    (integer / string, required) Time from which to start rescanning the blockchain for this descriptor, in UNIX epoch time
                                            Use the string "now" to substitute the current synced blockchain time.
                                            "now" can be specified to bypass scanning, for outputs which are known to never have been used, and
                                            0 can be specified to scan the entire blockchain. Blocks up to 2 hours before the earliest timestamp
                                            of all descriptors being imported will be scanned as well as the mempool.
         "internal": bool,                  (boolean, optional, default=false) Whether matching outputs should be treated as not incoming payments (e.g. change)
         "label": "str",                    (string, optional, default="") Label to assign to the address, only allowed with internal=false. Disabled for ranged descriptors
       },
       ...
     ]

```

* UNIX時間の例

2024年1月１日0時０分０秒 → 1704034800

### 秘密鍵のインポート


### P2SH の  descriptor をインポート

```bash
echo $P2SH_DESCRIPTOR

=>
sh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#qvpxamev
```

現在はこのdescriptor をインポートしようとすると，秘密鍵が無いという理由でエラーになります

```bash
bitcoin-core.cli importdescriptors "[{\"desc\": \"$P2SH_DESCRIPTOR\", \"timestamp\": 1704034800,  \"active\": false,  \"watchonly\": true}]"

=>
[
  {
    "success": false,
    "error": {
      "code": -4,
      "message": "Cannot import descriptor without private keys to a wallet with private keys enabled"
    }
  }
]
```

### P2WSH の descriptor をインポート

```bash
echo $P2WSH_DESCRIPTOR

=>
wsh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#lfmqcn4l
```

現在はこのdescriptor をインポートしようとすると，秘密鍵が無いという理由でエラーになります

```bash
bitcoin-core.cli importdescriptors '[{"desc": "wsh(multi(2,0222e8217169108c253501bbc0c12b1afdf7d90f7ffcab3c977ccd0720b396bfe6,03db5794dee648c57f6bc4eecac49328c57541737767ad066fd2149aaa5dd50280,02fed05b945310ab915bec26e8a8ef4489ccea88af9cb111a46d2be9aeb027e7da))#lfmqcn4l",   "timestamp": 1704034800, "watchonly": true}]'

=>
[
  {
    "success": false,
    "error": {
      "code": -4,
      "message": "Cannot import descriptor without private keys to a wallet with private keys enabled"
    }
  }
]
```
