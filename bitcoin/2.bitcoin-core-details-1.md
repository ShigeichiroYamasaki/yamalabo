# 2. bitcoin core の詳細

2024/06/06  更新 Shigeichiro Yamasaki


* [メーリングリスト bitcoin-dev](https://lists.linuxfoundation.org/mailman/listinfo/bitcoin-dev)
* [Slack: https://bitcoincore.slack.com/](https://bitcoincore.slack.com/)
* [BIP](https://github.com/bitcoin/bips)

## インストールすべきツール

### Ruby 言語

[Ruby インストール方法](https://github.com/ShigeichiroYamasaki/yamalabo/blob/master/ruby/ruby.md)



## 各種トランザクションの構成を一連の流れで演習します

以下のように，合計で８個のトランザクションを作成します．

ubuntu での実施を前提にします．

```

(UTXOの資金)--> TX1 -+-->0.0002BTC VOUT:0 -->TX2(P2PK)  --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:1 -->TX3(P2PKH) --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:2 -->TX4(P2SH)  --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:3 -->TX5(P2WPKH)--> 0.00018BTC-+
                    +-->0.0002BTC VOUT:4 -->TX6(P2WSH) --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:5 -->TX7(P2TR)  --> 0.00018BTC-+--> TX8
                    +-->おつり
```

0. 事前にsignetのfaucet から0.002 BTC 以上のビットコインを得ておきます。
1. TX1 faucetから得たUTXOをinputとして 7個のoutputを持つトランザクション (TX1) を作成し，署名して，ブロードキャストする
2. 6個のUTXOを利用して，6個のトランザクション (TX2 ~ TX7) を作成しそれぞれ署名して，ブロードキャストする

    ★ (TX2 ~ TX7) はそれぞれP2PK, P2PKH, P2SH, P2WPKH, P2WSH の5つのタイプのoutputを持つ
3. 6個のタイプの異なるUTXOをinputとして，１個のUTXOにまとめるトランザクション TX8 を作成する
    ★ P2SH, P2WSH のUTXOをワレットに認識させる必要があります。


## 目次

* [ descriptor ワレットの作成](#DESC)
* [6種類のアドレスの生成](#ADDR)
* [TX1: 7つのUTXOを生成する](#TX1)
* [TX3: P2PKH トランザクションの作成](#TX3)
* [TX4: P2SH トランザクションの作成](#TX4)
* [TX5: P2WPKH トランザクションの作成](#TX5)
* [TX6: P2WSH トランザクションの作成](#TX6)
* [TX7: P2TR トランザクションの作成](#TX7)
* [TX2: P2PK トランザクションの作成](#TX2)
* [TX8: 6種類の UTXO を inputとするトランザクションの作成](#TX8)


##  <a id="DESC"> </a>descriptor ワレットの作成

### UTXOの所有と discriptor

当初，ブロックチェーン上のデジタル資産であるUTXOの所有の概念は，主体の秘密鍵による計算能力の証明（デジタル署名など）中心に構成されていました．

しかし P2SH などのスクリプトへの送金の概念の登場によって秘密鍵だけでは所有の概念を表現できなくなりました．

そこで，自分が所有するUTXOを定義するために [BIP380](https://github.com/bitcoin/bips/blob/master/bip-0380.mediawiki) で output script descriptor という言語が提案されました．

### output script descriptor

output script descriptorは，Scirpt Experession、Key Expression，チェックサムの３要素で構成されています．

* Script Expression

    Bitcoinのスクリプトに直接対応する式。これらの式は関数として記述され、引数を取る

* Key Expression

    Script Expressionの引数としてよく使われる式に、Key Expressionがある。これは公開鍵または秘密鍵と、オプションとしてその鍵のオリジンに関する情報を表す

* チェックサム

  * hexエンコードされた公開鍵
  * WIFエンコードされた秘密鍵
  * xpubエンコードされた拡張公開鍵、もしくはxprvエンコードされた拡張秘密鍵

### descriptor の例

* 2-of-3 多重署名でロックされた P2SHタイプの output を表現する Descriptor の例

```json
sh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#c968pfza
```

* 2-of-3 多重署名でロックされた P2WSHタイプの output を表現する Descriptor の例

```json
wsh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#04tn9tty
```

### descriptor ワレットの作成

```
bitcoin-core.cli createwallet <ワレット名> <秘密鍵の無効化> <空ワレット> <パスフレーズ> <再利用禁止> <descripterの有効化> <起動時にロード> <外部署名の許可>
```

```bash
bitcoin-core.cli createwallet eve
bitcoin-core.cli createwallet alice 
```

```bash
bitcoin-core.cli listwallets

[
  "alice",
  "eve"
]
```

ワレットのアンロード

```bash
bitcoin-core.cli unloadwallet alice

bitcoin-core.cli listwallets

[
  "eve"
]

```

ワレットの情報

```bash
bitcoin-core.cli getwalletinfo
{
  "walletname": "eve",
  "walletversion": 169900,
  "format": "sqlite",
  "balance": 0.00000000,
  "unconfirmed_balance": 0.00000000,
  "immature_balance": 0.00000000,
  "txcount": 0,
  "keypoolsize": 4000,
  "keypoolsize_hd_internal": 4000,
  "paytxfee": 0.00000000,
  "private_keys_enabled": true,
  "avoid_reuse": false,
  "scanning": false,
  "descriptors": true,
  "external_signer": false,
  "blank": false,
  "birthtime": 1716908333,
  "lastprocessedblock": {
    "hash": "000000139bf3a0de1ae4acd7a7c0fc0fd02258f0665220eb2556d1b3ff9108b0",
    "height": 197570
  }
}

```

### 最初のアドレス（最初のUTXOの所有者）の生成

```bash
ALICE=`bitcoin-core.cli getnewaddress alice`

#確認
echo $ALICE
tb1qv99t3v4pck374la9k24namcetmk626sj4rmrsd
```

### faucet から aliceに入金

[signet faucet](https://signetfaucet.com/)

★ 10分後に確認 （20分以上かかることもあります）

コインの受領を待たずに，「６種類のビットコインアドレスの生成」などをすすめてください．

ちなみにコインが受領されると以下のような状態になります．

```bash
bitcoin-core.cli getbalance

0.01000000
```

## <a id="ADDR">6種類のビットコインアドレスの生成 </a>

6種類の outputのタイプへの送金には、それぞれ対応するアドレスタイプを持つ送金先アドレスが必要です。

以下に P2PK, P2PKH, P2SH, P2WPKH, P2WSH, P2TR の6タイプのアドレスを生成します．

#### getnewaddress コマンド

```bash
getnewaddress <ラベル> <アドレスタイプ>
```

アドレスタイプ

* legacy (base52アドレス）このタイプにさらに P2PKHとP2SHがあります
* bech32 (Bech32アドレス）このタイプにさらにP2WPKHとP2WSHがありあす
* p2sh-segwit (後方互換のため，Bech32アドレスをP2SHでラップしたアドレス)
* P2PK では、送金先の公開鍵がそのまま送金先アドレスになります

### P2PKアドレス

最も初期のアドレス形式です．

特別なアドレスフォーマットはなく，当事者の公開鍵がそのままアドレスになります

#### 公開鍵の確認方法

コマンドの文法

```
getaddressinfo <（自分のワレットの）ビットコインアドレス>
```


ここでは，P2WPKH として生成されたアドレスの情報から公開鍵を抜き出します．

```bash
BOB=`bitcoin-core.cli getnewaddress bob`

#確認
echo $BOB
tb1qc8yk8jz3jx4j6gpx55qrnjm54qrhexcaachwpd


bitcoin-core.cli getaddressinfo $BOB

{
  "address": "tb1qc8yk8jz3jx4j6gpx55qrnjm54qrhexcaachwpd",
  "scriptPubKey": "0014c1c963c85191ab2d2026a50039cb74a8077c9b1d",
  "ismine": true,
  "solvable": true,
  "desc": "wpkh([c4317781/84h/1h/0h/0/8]027dfa02138b7c86ad0901b4fb08718653f97e801df90110ddff322697cb107712)#npc0rxhz",
  "parent_desc": "wpkh([c4317781/84h/1h/0h]tpubDDThUseTsE7BrL9L7K6cNLBfSjLa8zdMVuqEfsiDjgv8WtkG3VScT9HJ8sKAfcWG8NoXD25bd5h8rNwGSep2frEdVtGfQm4n8mQYPjh2DHh/0/*)#w9yrknfc",
  "iswatchonly": false,
  "isscript": false,
  "iswitness": true,
  "witness_version": 0,
  "witness_program": "c1c963c85191ab2d2026a50039cb74a8077c9b1d",
  "pubkey": "027dfa02138b7c86ad0901b4fb08718653f97e801df90110ddff322697cb107712",
  "ischange": false,
  "timestamp": 1716908333,
  "hdkeypath": "m/84h/1h/0h/0/8",
  "hdseedid": "0000000000000000000000000000000000000000",
  "hdmasterfingerprint": "c4317781",
  "labels": [
    "bob"
  ]
}
```

公開鍵は  pubkey の部分です．

この公開鍵の情報を [jq コマンド](https://www.karakaram.com/notes-on-jq-command/) を利用して P2PK アドレスとしてシェル変数 P2PK_ADDR に代入しておきます

```bash
P2PK_ADDR=`bitcoin-core.cli getaddressinfo $BOB|jq -r '.pubkey'`

#確認
echo $P2PK_ADDR
027dfa02138b7c86ad0901b4fb08718653f97e801df90110ddff322697cb107712
```

### P2PKHアドレス

当事者の公開鍵のハッシュ値から生成され base52 エンコードしたアドレスです

シェル変数 P2PKH_ADDRに代入しておきます．

```bash
P2PKH_ADDR=`bitcoin-core.cli getnewaddress pkh_user legacy`

#確認
echo $P2PKH_ADDR
=>
mhAg6CF3VSE1htcQV2ShxRTsMgb2VCvqU4
```

### P2SHアドレス

当事者の公開鍵ではなく，bitcoin スクリプトのハッシュ値から生成されたアドレスです．

その典型例がマルチシグ（多重署名）用アドレスです。

#### マルチシグ用公開鍵のリストの作成

 
アドレスの生成には、n人の署名者たちの公開鍵が必要です。

ここでは P2PK と同様の方法で３人の公開鍵を生成し，シェル変数 PUBKEY1, PUBKEY2, PUBKEY3 に代入します．

```bash
SIGNER1=`bitcoin-core.cli getnewaddress signer1`
SIGNER2=`bitcoin-core.cli getnewaddress signer2`
SIGNER3=`bitcoin-core.cli getnewaddress signer3`

#確認
echo $SIGNER1
tb1qvavkv47h02fzyazh4ehr27yv2pgz4kaxc8fsfh
echo $SIGNER2
tb1qxaxs6e3sk9p60nynvdw7n5m8ea99deykdpdhj5
echo $SIGNER3
tb1qtg9shn2qdqntlu8x8uy46r2vj5er2vmjjn70z2

PUBKEY1=`bitcoin-core.cli getaddressinfo $SIGNER1|jq -r '.pubkey'`
PUBKEY2=`bitcoin-core.cli getaddressinfo $SIGNER2|jq -r '.pubkey'`
PUBKEY3=`bitcoin-core.cli getaddressinfo $SIGNER3|jq -r '.pubkey'`

#確認
echo $PUBKEY1
=> 
"0222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d0"
echo $PUBKEY2
=>
"031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa6"
echo $PUBKEY3
=>
"03b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda2"
```

#### マルチシグアドレスの生成

 m of n マルチシグ（n人の公開鍵の中でm人の署名があれば成功する署名）のためのアドレス生成です。
 
コマンドの文法

```
createmultisig <必要署名数 m> '[<公開鍵1>,<公開鍵2>,...,<公開鍵n>]' <アドレスタイプ>
```

 <アドレスタイプ> の指定によって　P2SH　と　P2WSH　が区別されます。

アドレスタイプ:  P2SH＝"legacy", P2SHのSegWitラップ="p2sh-segwit", P2WSH="bech32"

マルチシグアドレス生成結果

```json
{                            (json object)
  "address" : "str",         (string) The value of the new multisig address.
  "redeemScript" : "hex",    (string) The string value of the hex-encoded redemption script.
  "descriptor" : "str"       (string) The descriptor for this multisig
}
```

2 of 3 の場合

```bash
P2SH=`bitcoin-core.cli createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" legacy`

#確認
echo $P2SH
=>
{ "address": "2N1RNSz42napit7vTh8ofvHw9bLhUQm38ej", "redeemScript": "52210222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d021031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa62103b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda253ae", "descriptor": "sh(multi(2,0222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d0,031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa6,03b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda2))#u0g002xf" }
```

ここでは，シェル変数 P2SH_ADDRに生成したアドレスを代入しておきます

```bash
P2SH_ADDR=`echo $P2SH|jq -r '.address'`

#確認
echo $P2SH_ADDR
=>
2N1RNSz42napit7vTh8ofvHw9bLhUQm38ej
```

#### P2SH redeemScript

P2SHのアウトプットをアンロックするには、redeemScriptが必要です

上記のマルチシグアドレス生成時に対応する redeemscriptも生成されています．

シェル変数 P2SH_REDEEMSCRIPT にその内容を代入しておきます

```bash
P2SH_REDEEMSCRIPT=`echo $P2SH|jq -r '.redeemScript'`

#確認
echo $P2SH_REDEEMSCRIPT
=>
52210222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d021031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa62103b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda253ae
```

#### P2SH descriptor

* P2SH でロックされているUTXOをアンロックするためには，まず第１段階として redeemscript とそのハッシュ値が必要です．

* 第２段階で，マルチシグの実際の署名を行う場所は署名者それぞれのワレットで， redeemScript に沿ってそれぞれの秘密鍵を使って署名を行います。

* それを可能にするためには、それぞれの署名者のワレットに redeemScript などの必要な情報を組み込む必要があります。

* descriptor　は、ワレットにマルチシグ署名のための情報を組み込むためのデータです。

ここでは，シェル変数 P2SH_DESCRIPTOR にその内容を代入しておきます．

```bash
P2SH_DESCRIPTOR=`echo $P2SH|jq -r '.descriptor'`

#確認
echo $P2SH_DESCRIPTOR
=>
sh(multi(2,0222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d0,031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa6,03b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda2))#u0g002xf
```

##### マルチシグアドレス生成の実際と公開鍵の提示

ここでの例では、複数のアドレスを一つのワレットで生成していますが、実際は複数の人のワレットで生成します。

上記のように、マルチシグアドレスの生成には公開鍵が必要です。

しかし、アドレスごとの公開鍵は非公開情報です。したがって、実際にマルチシグに参加する当事者がそれぞれ自分で自分の公開鍵を確認し、信頼できる第三者であるマルチシグアドレス生成者に提示する必要があります。


### P2WPKHアドレス 

Bech32アドレスの生成（受領者の公開鍵ハッシュの場合）

ここでは，シェル変数 P2WPKH_ADDR にアドレスを代入しておきます．

```bash
P2WPKH_ADDR=`bitcoin-core.cli getnewaddress wpkh_user bech32`

#確認
echo $P2WPKH_ADDR

=>
tb1qsadlntxhqp57e2wysnc08frl5g0rjwt63ask8j
```

### P2WSHアドレス

基本的にP2SHと同じです。


2 of 3 の場合

```bash
P2WSH=`bitcoin-core.cli createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" bech32`

# 確認
echo $P2WSH
=>
{ "address": "tb1qjxhegc9wkpnum669mys9thnklg3yg8g5g6cst7t9hw76r4w3zdlq368yvl", "redeemScript": "52210222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d021031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa62103b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda253ae", "descriptor": "wsh(multi(2,0222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d0,031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa6,03b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda2))#v9yn6csx" }
```

ここではシェル変数 P2WSH_ADDR に内容を代入しておきます

```bash
P2WSH_ADDR=`echo $P2WSH|jq -r '.address'`

#確認
echo $P2WSH_ADDR
=>
tb1qjxhegc9wkpnum669mys9thnklg3yg8g5g6cst7t9hw76r4w3zdlq368yvl
```


#### P2WSH redeemScript

ここではシェル変数 P2WSH_REDEEMSCRIPT にその内容を代入しておきます

```bash
P2WSH_REDEEMSCRIPT=`echo $P2WSH|jq -r '.redeemScript'`

#確認
echo $P2WSH_REDEEMSCRIPT
=>
52210222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d021031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa62103b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda253ae
```

#### P2SH descriptor

ここでは，シェル変数 P2WSH_DESCRIPTOR にその内容を代入しておきます．

```bash
P2WSH_DESCRIPTOR=`echo $P2WSH|jq -r '.descriptor'`

#確認
echo $P2WSH_DESCRIPTOR
=>
wsh(multi(2,0222d0c39ad7c4d79f262a0e00a68a8a5ec7d88003c536f111d3748a95a19ee8d0,031f236a4ed80319f1594bfec0f85c1c7726cf635d1aab6e139e6070121720cfa6,03b5f744ea3a0117b4d1cea0e9c65cb892276ba3c4aa4356239d5d7d16ef68eda2))#v9yn6csx
```

### P2TRアドレス


Bech32m アドレスの生成（受領者の公開鍵）

ここでは，シェル変数 P2TR_ADDR にアドレスを代入しておきます．

getnewaddress コマンドでラベルの設定が必要です

```bash
P2TR_ADDR=`bitcoin-core.cli getnewaddress tr_user bech32m`

#確認
echo $P2TR_ADDR
=>
tb1p4ktga0tpgca3an3aheynpf46qtnf2xn6f74n38ktxtfc6pe3x33qzu0xsv
```

## <a id="TX1"> </a>7つのUTXOを生成する

まず，１個のUTXOを７つに分割するために，７つの送金先アドレスを生成します．

★ シェル変数にアドレスを代入しています．

```bash
USER1=`bitcoin-core.cli getnewaddress user1`
USER2=`bitcoin-core.cli getnewaddress user2`
USER3=`bitcoin-core.cli getnewaddress user3`
USER4=`bitcoin-core.cli getnewaddress user4`
USER5=`bitcoin-core.cli getnewaddress user5`
USER6=`bitcoin-core.cli getnewaddress user6`
```

生成したアドレスの確認

```bash
# 確認
echo $USER1
tb1q5sggtcvwl2tpzmys596unvzqd9h72ucz6aj9l9
echo $USER2
tb1qatvr408jwwarxlaktjelczru05xl6c2957myvh
echo $USER3
tb1qzgh8wj4ctnuf84sjpxevvyvzxw0hummxrxrhy9
echo $USER4
tb1qnnzndw3zzjdavlzvejpzj3lwlyvemjn2yyej9l
echo $USER5
tb1qzjcw568mpm5xewqn2pafef8hu05erqww492850
echo $USER6
tb1qskgu2jatdtpknvth2u4htw4mw47wnlwjukv23l
```

### 使用するUTXOを確認する

この例では、"amount": 0.0100000　を持つUTXOを利用しますが，以下では自分が所持している bitcoin の金額でトランザクションを作成してください．

使用する"txid" と "vout"と "amount" と "address" の値をメモしてください

#### UTXOの例

自分のUTXOを確認してください

★★（以下は例です，必ず自分のUTXOのものをチェックしてください！）


UTXOを複数所持している場合は，amount が 0.01 以上あるものを一つ選んでください．


★★ （ここではUTXOの 金額を 0.01 BTC にしていますが，それよりも多い場合は必ずおつりの計算を間違えないようにしてください！！）

★★ （おつりの計算を間違えると，失った所持金はマイナーの報酬になり，戻ってきません）


```bash
bitcoin-core.cli listunspent

# ここでの例
=>
[
  {
    "txid": "a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff",
    "vout": 0,
    "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
    "label": "",
    "scriptPubKey": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
    "amount": 0.01000000,
    "confirmations": 100,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/0]031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33)#9wux8ep7",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  }
]

```

自分のUTXOの txid , vout, address をシェル変数に代入します

```
TXID="<txidの内容>"
VOUT="<voutの内容>"
ADDRESS="<addressの内容>"
```

上記の例の場合
★（必ず自分のUTXOのものに置き換えてください）

```bash
TXID="a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff"
VOUT="0"
ADDRESS="tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y"
```

★ この ADDRESS に指定するアドレスは，UTXOを所有している自分のアドレスで，おつりとして取り戻すためのアドレスです．

### 6+1 個のoutputを持つトランザクションを作成する

* input として使用するUTXOの txid と vout
* output は、生成した5つのアドレスです
* 6つの送金先アドレスへの送金金額は，それぞれ 0.0002 とします．
* outputにはおつり用のアドレスがさらに一つ必要です．ここではUTXOの所有者にします．

#### おつりの計算

ここではトランザクション手数料は 0.00002 とします．

0.01 - (0.0002)*6 - 0.00002 =  0.00878


### トランザクションの作成

JSON形式で input と output を作成します．

実行結果は 16進数形式です．

```bash
bitcoin-core.cli createrawtransaction "[{\"txid\":\"$TXID\",\"vout\":$VOUT}]" "[{\"$USER1\":0.0002},{\"$USER2\":0.0002},{\"$USER3\":0.0002},{\"$USER4\":0.0002},{\"$USER5\":0.0002},{\"$USER6\":0.0002},{\"$ADDRESS\":0.00878}]"

=>
0200000001ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf00000000
```

作成したトランザクションの確認

```bash
{
  "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
  "hash": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
  "version": 2,
  "size": 268,
  "vsize": 268,
  "weight": 1072,
  "locktime": 0,
  "vin": [
    {
      "txid": "a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00020000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 e45018208132700164dedd48ec2aa02da6e33b67",
        "desc": "addr(tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe)#p3vgdq3y",
        "hex": "0014e45018208132700164dedd48ec2aa02da6e33b67",
        "address": "tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 1,
      "scriptPubKey": {
        "asm": "0 b9fbf4a0356203937477ec684ab3932d429b07cb",
        "desc": "addr(tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx)#twmy7fz9",
        "hex": "0014b9fbf4a0356203937477ec684ab3932d429b07cb",
        "address": "tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 2,
      "scriptPubKey": {
        "asm": "0 d65518f36391977934d620968e20d26004951b12",
        "desc": "addr(tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r)#uj4raxft",
        "hex": "0014d65518f36391977934d620968e20d26004951b12",
        "address": "tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 3,
      "scriptPubKey": {
        "asm": "0 d721c1cffb72d43de5b0751ceec298054777b129",
        "desc": "addr(tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz)#9cyy265r",
        "hex": "0014d721c1cffb72d43de5b0751ceec298054777b129",
        "address": "tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 4,
      "scriptPubKey": {
        "asm": "0 d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "desc": "addr(tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n)#s2t6ysk2",
        "hex": "0014d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "address": "tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 5,
      "scriptPubKey": {
        "asm": "0 6224919b7470a13c87b979ad659736d8cdcf8fcb",
        "desc": "addr(tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek)#slfte7jy",
        "hex": "00146224919b7470a13c87b979ad659736d8cdcf8fcb",
        "address": "tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00878000,
      "n": 6,
      "scriptPubKey": {
        "asm": "0 4fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "desc": "addr(tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y)#ukrvlu5l",
        "hex": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}
```

### 作成したトランザクションに署名する

```bash
bitcoin-core.cli  signrawtransactionwithwallet 0200000001ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf00000000

=>
{
  "hex": "02000000000101ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf0247304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a0121031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b3300000000",
  "complete": true
}

```

署名したトランザクションの内容の確認（hex の値をコピー・ペーストする）

★ txinwitness 領域が作成されていることを確認する

```bash
bitcoin-core.cli  decoderawtransaction 02000000000101ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf0247304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a0121031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b3300000000

=>
{
  "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
  "hash": "b4254314aa0cff6758ed2d5987d6950fe24d9d290ce7f73fbfb0b38b7a3a7138",
  "version": 2,
  "size": 377,
  "vsize": 296,
  "weight": 1181,
  "locktime": 0,
  "vin": [
    {
      "txid": "a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a01",
        "031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00020000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 e45018208132700164dedd48ec2aa02da6e33b67",
        "desc": "addr(tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe)#p3vgdq3y",
        "hex": "0014e45018208132700164dedd48ec2aa02da6e33b67",
        "address": "tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 1,
      "scriptPubKey": {
        "asm": "0 b9fbf4a0356203937477ec684ab3932d429b07cb",
        "desc": "addr(tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx)#twmy7fz9",
        "hex": "0014b9fbf4a0356203937477ec684ab3932d429b07cb",
        "address": "tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 2,
      "scriptPubKey": {
        "asm": "0 d65518f36391977934d620968e20d26004951b12",
        "desc": "addr(tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r)#uj4raxft",
        "hex": "0014d65518f36391977934d620968e20d26004951b12",
        "address": "tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 3,
      "scriptPubKey": {
        "asm": "0 d721c1cffb72d43de5b0751ceec298054777b129",
        "desc": "addr(tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz)#9cyy265r",
        "hex": "0014d721c1cffb72d43de5b0751ceec298054777b129",
        "address": "tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 4,
      "scriptPubKey": {
        "asm": "0 d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "desc": "addr(tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n)#s2t6ysk2",
        "hex": "0014d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "address": "tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 5,
      "scriptPubKey": {
        "asm": "0 6224919b7470a13c87b979ad659736d8cdcf8fcb",
        "desc": "addr(tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek)#slfte7jy",
        "hex": "00146224919b7470a13c87b979ad659736d8cdcf8fcb",
        "address": "tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00878000,
      "n": 6,
      "scriptPubKey": {
        "asm": "0 4fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "desc": "addr(tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y)#ukrvlu5l",
        "hex": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}

```

### 署名したトランザクションをブロードキャストする

返り値のトランザクションIDをメモする

```bash
bitcoin-core.cli   sendrawtransaction 02000000000101ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf0247304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a0121031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b3300000000

=>
5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
```

### トランザクションを確認する

```bash
bitcoin-core.cli gettransaction 5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
```

### 10分以上経過後，UTXOのリストを確認する

UTXOが 7 に増えていることを確認します．

```bash
bitcoin-core.cli listunspent

=>
[
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 0,
    "address": "tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe",
    "label": "user1",
    "scriptPubKey": "0014e45018208132700164dedd48ec2aa02da6e33b67",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/11]039631ab36ba50c053d8de05574ee58cfd7aa641922787c1c2a326225f1fbeea47)#q25z3jjf",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 1,
    "address": "tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx",
    "label": "user2",
    "scriptPubKey": "0014b9fbf4a0356203937477ec684ab3932d429b07cb",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/12]0210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f90266436)#c9fzm06u",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 2,
    "address": "tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r",
    "label": "user3",
    "scriptPubKey": "0014d65518f36391977934d620968e20d26004951b12",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/13]035239383d7c6bd47b272c373ef02cf9b3943fc08bd218fd1522429da3c008fe88)#lwxunh7a",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 3,
    "address": "tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz",
    "label": "user4",
    "scriptPubKey": "0014d721c1cffb72d43de5b0751ceec298054777b129",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/14]0342fc43d4b46b3498b75dd5fa5bfedef1c090414cacb56c8551fe52f24e296d21)#l8n8axry",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 4,
    "address": "tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n",
    "label": "user5",
    "scriptPubKey": "0014d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/15]03c900a0f1c139eeb3e0fb30a83fd649c7d2de9fe0598641dfac080c4b0026bcd0)#emen64rw",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 5,
    "address": "tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek",
    "label": "user6",
    "scriptPubKey": "00146224919b7470a13c87b979ad659736d8cdcf8fcb",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/16]0275451ad763853e8a3f0dbc608cc354282b6a0da0eb02a0508b50b11812636bd7)#d6965ayc",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 6,
    "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
    "label": "",
    "scriptPubKey": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
    "amount": 0.00878000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/0]031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33)#9wux8ep7",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  }
]
```

### UTXO のメモとシェル変数への代入


作成した7つのUTXOは，それぞれ順にP2PK,　P2PKH，P2SH，P2WPKH，P2WSHの作成実験のために使います。

この後，7個のUTXOからそれぞれ P2PK, P2PKH, P2SH, P2WPKH, P2WSH, P2TR の6つのタイプのoutputを持つ6個のトランザクションを作成し，それぞれ署名して，ブロードキャストします．

UTXO のトランザクションID： 5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
  vout:0 ~ 6

```
UTXO_TXID="<UTXO の txid>"
```

```bash
UTXO_TXID="5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f"
UTXO_VOUT0=0
UTXO_VOUT1=1
UTXO_VOUT2=2
UTXO_VOUT3=3
UTXO_VOUT4=4
UTXO_VOUT5=5
```

## <a id="TX3">TX3: P2PKH トランザクションの作成 </a>

* txid: UTXO_TXID
* vout: 1
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018


送金先アドレスを legacy なP2PKH アドレスにすればよい

```bash
echo $P2PKH_ADDR

=>
mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J
```

### input(UTXO)　のJSON形式の例

```bash
echo "[{\"txid\":\"$UTXO_TXID\",\"vout\":1}]"

=>
[{"txid":"5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f","vout":1}]
```

### output のJSON形式の例

```bash
echo "[{\"$P2PKH_ADDR\": 0.00018}]"

=>
[{"mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J": 0.00018}]
```

### 未署名トランザクションの作成

```bash
P2PKHTX=`bitcoin-core.cli createrawtransaction  "[{\"txid\":\"$UTXO_TXID\",\"vout\":1}]" "[{\"$P2PKH_ADDR\": 0.00018}]"`

echo $P2PKHTX
=>
02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac00000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
SIGNED_P2PKHTX=`bitcoin-core.cli signrawtransactionwithwallet $P2PKHTX`

echo $SIGNED_P2PKHTX
=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac0247304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201210210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f9026643600000000",
  "complete": true
}

SIGNED_P2PKHTX_HEX=`echo $SIGNED_P2PKHTX|jq -r '.hex'`

echo $SIGNED_P2PKHTX_HEX
=>
020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac0247304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201210210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f9026643600000000
```

### 作成したトランザクションの確認

voutのタイプを確認してください

```bash
bitcoin-core.cli decoderawtransaction $SIGNED_P2PKHTX_HEX

=>
{
  "txid": "f66f7c67f0e2edab7d27d316662c31a9a5f33fe68dd9725854fe04bb7f23563f",
  "hash": "71b473bae78c2a006cb9825a72d53775ff2c3792c973a5fb7ef7f6b6db1f1512",
  "version": 2,
  "size": 194,
  "vsize": 113,
  "weight": 449,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 1,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201",
        "0210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f90266436"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "OP_DUP OP_HASH160 d0c58609bfeafe97668feab8f356eccc78346c05 OP_EQUALVERIFY OP_CHECKSIG",
        "desc": "addr(mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J)#x69lw56d",
        "hex": "76a914d0c58609bfeafe97668feab8f356eccc78346c0588ac",
        "address": "mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J",
        "type": "pubkeyhash"
      }
    }
  ]
}
```

### P2PKHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction $SIGNED_P2PKHTX_HEX

=>
f66f7c67f0e2edab7d27d316662c31a9a5f33fe68dd9725854fe04bb7f23563f
```

このトランザクションIDを シェル変数 P2PKH_TXID に代入しておきます

```bash
P2PKH_TXID="f66f7c67f0e2edab7d27d316662c31a9a5f33fe68dd9725854fe04bb7f23563f"
```

--
## <a id="TX4">TX4: P2SH トランザクションの作成 </a>

* txid: UTXO_TXID
* vout: 2
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018

### input(UTXO)　のJSON形式の例

```bash
echo "[{\"txid\":\"$UTXO_TXID\",\"vout\":2}]"

=>
[{"txid":"5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f","vout":2}]
```

### output のJSON形式の例

送金先を P2SH アドレスにする

```bash
echo "[{\"$P2SH_ADDR\":0.00018}]"

=>
[{"2N9kJJFdQvdD1gYAuirNVNFvsZcFcKtULCS":0.00018}]
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction  "[{\"txid\":\"$UTXO_TXID\",\"vout\":2}]" "[{\"$P2SH_ADDR\":0.00018}]"

=>
02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0200000000fdffffff01504600000000000017a914b501ac4f16dab232dee9cd0747e1892e2bfea8238700000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0200000000fdffffff01504600000000000017a914b501ac4f16dab232dee9cd0747e1892e2bfea8238700000000

=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0200000000fdffffff01504600000000000017a914b501ac4f16dab232dee9cd0747e1892e2bfea8238702473044022049e90ab6579a9f8eede7cf5a640b9340188e664ca81ff953d9f40a6a78df73ca022038d98b1df3faa3f2fd560bd9a9909484966682bd6ee37f28759c9114581859400121035239383d7c6bd47b272c373ef02cf9b3943fc08bd218fd1522429da3c008fe8800000000",
  "complete": true
}
```

### P2SHトランザクションの確認

output の type が scripthash であることを確認

```bash
bitcoin-core.cli decoderawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0200000000fdffffff01504600000000000017a914b501ac4f16dab232dee9cd0747e1892e2bfea8238702473044022049e90ab6579a9f8eede7cf5a640b9340188e664ca81ff953d9f40a6a78df73ca022038d98b1df3faa3f2fd560bd9a9909484966682bd6ee37f28759c9114581859400121035239383d7c6bd47b272c373ef02cf9b3943fc08bd218fd1522429da3c008fe8800000000

=>
{
  "txid": "cd568cf3a8355c3be99ee47faedb68169a6dcc06c78afe71ff08a0743d1caf4b",
  "hash": "20b18a2295acb51ae6aa57249aecf81868bf983810a1b62408cb492e1863dce0",
  "version": 2,
  "size": 192,
  "vsize": 111,
  "weight": 441,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 2,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "3044022049e90ab6579a9f8eede7cf5a640b9340188e664ca81ff953d9f40a6a78df73ca022038d98b1df3faa3f2fd560bd9a9909484966682bd6ee37f28759c91145818594001",
        "035239383d7c6bd47b272c373ef02cf9b3943fc08bd218fd1522429da3c008fe88"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "OP_HASH160 b501ac4f16dab232dee9cd0747e1892e2bfea823 OP_EQUAL",
        "desc": "addr(2N9kJJFdQvdD1gYAuirNVNFvsZcFcKtULCS)#tf5mtmm4",
        "hex": "a914b501ac4f16dab232dee9cd0747e1892e2bfea82387",
        "address": "2N9kJJFdQvdD1gYAuirNVNFvsZcFcKtULCS",
        "type": "scripthash"
      }
    }
  ]
}

```

### P2SHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0200000000fdffffff01504600000000000017a914b501ac4f16dab232dee9cd0747e1892e2bfea8238702473044022049e90ab6579a9f8eede7cf5a640b9340188e664ca81ff953d9f40a6a78df73ca022038d98b1df3faa3f2fd560bd9a9909484966682bd6ee37f28759c9114581859400121035239383d7c6bd47b272c373ef02cf9b3943fc08bd218fd1522429da3c008fe8800000000

=>
cd568cf3a8355c3be99ee47faedb68169a6dcc06c78afe71ff08a0743d1caf4b
```

このトランザクションIDを シェル変数 P2SH_TXID に代入しておきます

```bash
P2SH_TXID="cd568cf3a8355c3be99ee47faedb68169a6dcc06c78afe71ff08a0743d1caf4b"
```
--
## <a id="TX5"> TX5: P2WPKH トランザクションの作成 </a>

* txid: UTXO_TXID
* vout: 3
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018




### input(UTXO)　のJSON形式の例

```bash
echo "[{\"txid\":\"$UTXO_TXID\",\"vout\":3}]"

=>
[{"txid":"5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f","vout":3}]
```

### output のJSON形式の例

送金先アドレスを　P2WPKH アドレスにすればよい

```bash
echo "[{\"$P2WPKH_ADDR\": 0.00018}]"

=>
[{"tb1qjf9kvs5k698luqwhkl9jqtdujwnwrx0250mnda": 0.00018}]
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction "[{\"txid\":\"$UTXO_TXID\",\"vout\":3}]" "[{\"$P2WPKH_ADDR\": 0.00018}]"

=>
02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0300000000fdffffff015046000000000000160014924b664296d14ffe01d7b7cb202dbc93a6e199ea00000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0300000000fdffffff015046000000000000160014924b664296d14ffe01d7b7cb202dbc93a6e199ea00000000

=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0300000000fdffffff015046000000000000160014924b664296d14ffe01d7b7cb202dbc93a6e199ea02473044022029a7aedeee023762cb76437d0c75cc3c9dbe11b810cf9157ab705c07f6f8a46a02204b7f7f4790d6f592dd64174da3a9615c71f77fcae16fb771d5b8c83445be7d9b01210342fc43d4b46b3498b75dd5fa5bfedef1c090414cacb56c8551fe52f24e296d2100000000",
  "complete": true
}
```

### P2WPKHトランザクションの確認

output "type": "witness_v0_keyhash" を確認

```bash
bitcoin-core.cli decoderawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0300000000fdffffff015046000000000000160014924b664296d14ffe01d7b7cb202dbc93a6e199ea02473044022029a7aedeee023762cb76437d0c75cc3c9dbe11b810cf9157ab705c07f6f8a46a02204b7f7f4790d6f592dd64174da3a9615c71f77fcae16fb771d5b8c83445be7d9b01210342fc43d4b46b3498b75dd5fa5bfedef1c090414cacb56c8551fe52f24e296d2100000000

=>
{
  "txid": "0bec2ecf9561b081d13d4dd6909a79114fdd3b9d9bfcc515cf9de96ccb31aa2c",
  "hash": "c77b05ac331267ea6867058c6ab3b38c5a62991f74364e3d09ef39ebd08793f7",
  "version": 2,
  "size": 191,
  "vsize": 110,
  "weight": 437,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 3,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "3044022029a7aedeee023762cb76437d0c75cc3c9dbe11b810cf9157ab705c07f6f8a46a02204b7f7f4790d6f592dd64174da3a9615c71f77fcae16fb771d5b8c83445be7d9b01",
        "0342fc43d4b46b3498b75dd5fa5bfedef1c090414cacb56c8551fe52f24e296d21"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 924b664296d14ffe01d7b7cb202dbc93a6e199ea",
        "desc": "addr(tb1qjf9kvs5k698luqwhkl9jqtdujwnwrx0250mnda)#5pufpmhq",
        "hex": "0014924b664296d14ffe01d7b7cb202dbc93a6e199ea",
        "address": "tb1qjf9kvs5k698luqwhkl9jqtdujwnwrx0250mnda",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}
```

### P2WPKHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0300000000fdffffff015046000000000000160014924b664296d14ffe01d7b7cb202dbc93a6e199ea02473044022029a7aedeee023762cb76437d0c75cc3c9dbe11b810cf9157ab705c07f6f8a46a02204b7f7f4790d6f592dd64174da3a9615c71f77fcae16fb771d5b8c83445be7d9b01210342fc43d4b46b3498b75dd5fa5bfedef1c090414cacb56c8551fe52f24e296d2100000000

=>
0bec2ecf9561b081d13d4dd6909a79114fdd3b9d9bfcc515cf9de96ccb31aa2c
```


このトランザクションIDを シェル変数 P2WPKH_TXID に代入しておきます

```bash
P2WPKH_TXID="0bec2ecf9561b081d13d4dd6909a79114fdd3b9d9bfcc515cf9de96ccb31aa2c"
```

## <a id="TX6">TX6: P2WSH トランザクションの作成 </a>

* txid: UTXO_TXID
* vout: 4
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018


送金先アドレスを P2WSH アドレスにすればよい

### input(UTXO)　のJSON形式の例

```bash
echo "[{\"txid\":\"$UTXO_TXID\",\"vout\":4}]"

=>
[{"txid":"5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f","vout":4}]
```

### output のJSON形式の例

```bash
echo "[{\"$P2WSH_ADDR\": 0.00018}]"

=>
[{"tb1q5w03kkrvsr2nvgn6gqfgjqht3x6gghjstt3g7ez0cuvahnpe500svcyx4c": 0.00018}]
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction "[{\"txid\":\"$UTXO_TXID\",\"vout\":4}]" "[{\"$P2WSH_ADDR\": 0.00018}]"

=>
02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0400000000fdffffff015046000000000000220020a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df00000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0400000000fdffffff015046000000000000220020a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df00000000

=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0400000000fdffffff015046000000000000220020a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df02473044022018131c5688a4ee91db23013f3baf71c1c793eee89469efa184b69264b4c08b080220775becbf0edb3441f04ffdb0494f0ca941aeab8bb34a3094c7d233b8b733ca31012103c900a0f1c139eeb3e0fb30a83fd649c7d2de9fe0598641dfac080c4b0026bcd000000000",
  "complete": true
}
```

### P2WSHトランザクションの確認

output の  "type": "witness_v0_scripthash"

```bash
bitcoin-core.cli decoderawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0400000000fdffffff015046000000000000220020a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df02473044022018131c5688a4ee91db23013f3baf71c1c793eee89469efa184b69264b4c08b080220775becbf0edb3441f04ffdb0494f0ca941aeab8bb34a3094c7d233b8b733ca31012103c900a0f1c139eeb3e0fb30a83fd649c7d2de9fe0598641dfac080c4b0026bcd000000000

=>
{
  "txid": "018e0a930dcefe84be09bb27387721f14f2e64e0e1b41f749eafca78c9b1c1fc",
  "hash": "d32cd19a03473ea332ddd5303fabdb963e1960ecdc5092bbc5a6883ed6f144c6",
  "version": 2,
  "size": 203,
  "vsize": 122,
  "weight": 485,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 4,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "3044022018131c5688a4ee91db23013f3baf71c1c793eee89469efa184b69264b4c08b080220775becbf0edb3441f04ffdb0494f0ca941aeab8bb34a3094c7d233b8b733ca3101",
        "03c900a0f1c139eeb3e0fb30a83fd649c7d2de9fe0598641dfac080c4b0026bcd0"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df",
        "desc": "addr(tb1q5w03kkrvsr2nvgn6gqfgjqht3x6gghjstt3g7ez0cuvahnpe500svcyx4c)#zwua7lru",
        "hex": "0020a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df",
        "address": "tb1q5w03kkrvsr2nvgn6gqfgjqht3x6gghjstt3g7ez0cuvahnpe500svcyx4c",
        "type": "witness_v0_scripthash"
      }
    }
  ]
}
```


### P2WSHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0400000000fdffffff015046000000000000220020a39f1b586c80d536227a40128902eb89b4845e505ae28f644fc719dbcc39a3df02473044022018131c5688a4ee91db23013f3baf71c1c793eee89469efa184b69264b4c08b080220775becbf0edb3441f04ffdb0494f0ca941aeab8bb34a3094c7d233b8b733ca31012103c900a0f1c139eeb3e0fb30a83fd649c7d2de9fe0598641dfac080c4b0026bcd000000000

=>
018e0a930dcefe84be09bb27387721f14f2e64e0e1b41f749eafca78c9b1c1fc
```


このトランザクションIDを シェル変数 P2WSH_TXID に代入しておきます

```bash
P2WSH_TXID="018e0a930dcefe84be09bb27387721f14f2e64e0e1b41f749eafca78c9b1c1fc"
```


## <a id="TX7">TX7: P2TR トランザクションの作成 </a>

* txid: UTXO_TXID
* vout: 5
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018

### input(UTXO)　のJSON形式の例

```bash
echo "[{\"txid\":\"$UTXO_TXID\",\"vout\":5}]"

=>
[{"txid":"5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f","vout":5}]
```

### output のJSON形式の例

送金先を P2TR アドレスにする

```bash
echo "[{\"$P2TR_ADDR\":0.00018}]"

=>
[{"tb1pzwmas3lmkrn63wtgulylmtx79fvg3x5e0d6u9g50l3y8c3k0hvxqez8qxa":0.00018}]
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction "[{\"txid\":\"$UTXO_TXID\",\"vout\":5}]" "[{\"$P2TR_ADDR\":0.00018}]"

=>
02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0500000000fdffffff01504600000000000022512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c00000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0500000000fdffffff01504600000000000022512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c00000000

=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0500000000fdffffff01504600000000000022512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c024730440220518e684b72f5cdb842c816b8d8f96a02365fd7849ae77ad4b615a9c6f2836f34022012a77259566f7f1571788e337917bb5a18764262e1de9dd4e34cd5e1edebfb5801210275451ad763853e8a3f0dbc608cc354282b6a0da0eb02a0508b50b11812636bd700000000",
  "complete": true
}
```

### P2SHトランザクションの確認

output の  "type": "witness_v1_taproot" であることを確認

```bash
bitcoin-core.cli decoderawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0500000000fdffffff01504600000000000022512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c024730440220518e684b72f5cdb842c816b8d8f96a02365fd7849ae77ad4b615a9c6f2836f34022012a77259566f7f1571788e337917bb5a18764262e1de9dd4e34cd5e1edebfb5801210275451ad763853e8a3f0dbc608cc354282b6a0da0eb02a0508b50b11812636bd700000000

=>
{
  "txid": "0903ffacbb7f212d81902d54979409610dc4b2c594a66789f35866d14f4e3dc1",
  "hash": "8dfd0de3907aff0e7d42ddab16441e9a2072410e6768b7d69208106a1526f80e",
  "version": 2,
  "size": 203,
  "vsize": 122,
  "weight": 485,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 5,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "30440220518e684b72f5cdb842c816b8d8f96a02365fd7849ae77ad4b615a9c6f2836f34022012a77259566f7f1571788e337917bb5a18764262e1de9dd4e34cd5e1edebfb5801",
        "0275451ad763853e8a3f0dbc608cc354282b6a0da0eb02a0508b50b11812636bd7"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "1 13b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c",
        "desc": "rawtr(13b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c)#k3m8lk0v",
        "hex": "512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c",
        "address": "tb1pzwmas3lmkrn63wtgulylmtx79fvg3x5e0d6u9g50l3y8c3k0hvxqez8qxa",
        "type": "witness_v1_taproot"
      }
    }
  ]
}

```

### P2SHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0500000000fdffffff01504600000000000022512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c024730440220518e684b72f5cdb842c816b8d8f96a02365fd7849ae77ad4b615a9c6f2836f34022012a77259566f7f1571788e337917bb5a18764262e1de9dd4e34cd5e1edebfb5801210275451ad763853e8a3f0dbc608cc354282b6a0da0eb02a0508b50b11812636bd700000000

=>
0903ffacbb7f212d81902d54979409610dc4b2c594a66789f35866d14f4e3dc1
```

このトランザクションIDを シェル変数 P2TR_TXID に代入しておきます

```bash
P2TR_TXID="0903ffacbb7f212d81902d54979409610dc4b2c594a66789f35866d14f4e3dc1"
```
--


## <a id="TX2">TX2: P2PK トランザクションの作成 </a>

* txid: UTXO_TXID
* vout: 0
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018

bitcoin core のAPIでは　P2PKのトランザクション作成機能は削除されているので，自分でトランザクションの内容を仕様にそって自作する必要があります。

* input が参照するUTXOのTXIDはリトルエンディアン
* ScriptPubkeyの最後の１バイトは， OP_CHECKSIG (コードは16進数で "ac")
* valueの値は送金金額の単位が 1億分の1 BTC = 1 satoshi
* valueの値は 8バイトのリトルエンディアンであることに注意が必要です。

ここでは Ruby 言語を利用します

[Ruby インストール方法](https://github.com/ShigeichiroYamasaki/yamalabo/blob/master/ruby/ruby.md)

Ruby インタープリター起動

```bash
irb

>
```

### リトルエンディアン変換

Rubyのビッグエンディアンからリトルエンディアンへの変換プログラム


```ruby
# ビッグエンディアンのデータ
> be ="00000000001de840"
# リトルエンディアンへの変換
> le=[be].pack('H*').reverse.unpack('H*')[0]
# 変換結果
"40e81d0000000000"
```

* outputのvalue: 0.00018 BTC
* 0.00018 btc=18000 satoshi 

```ruby
# 18000 は、8バイトの16進数では，0000000000003e80
> 18000.to_s(16)
=> "4650"

# 8バイトのビッグエンディアン表現にすると
> be="0000000000004650"
# リトルエンディアンに変換
> le=[be].pack('H*').reverse.unpack('H*')[0]
# 変換結果
"5046000000000000"
```

* トランザクションの構造


| フィールド    | 内容       |
|:-------- |:-------- |
| version  | 02000000 |
| inputの数  | 01       |
| input    |          |
| outputの数 | 01       |
| output   |          |
| nLocTime | 00000000 |


トランザクションデータの連結結果

```
02000000
01<input>
01<output>
00000000
```

### input (UTXO)

#### UTXO

bash

```bash
echo $UTXO_TXID

=>
5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
```

Ruby

```ruby
# トランザクションIDのビッグエンディアン
> txid_be="5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f"
# リトルエンディアンへの変換
> txid_le=[txid_be].pack('H*').reverse.unpack('H*')[0]

=> 
"0f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e"
```

| フィールド        | 内容                                                               |
|:------------ |:---------------------------------------------------------------- |
| トランザクションID   | 0f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e |
| txout index  | 0000000000                                                       |
| ScriptSigサイズ | 空                                                                |
| ScriptSig    | 空                                                                |
| nSequence    | ffffffff                                                         |

inputデータの連結

ruby

```ruby
> txout_index="0000000000"
> nSequence="ffffffff"
> input = txid_le+txout_index+nSequence

=>
"0f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0000000000ffffffff"
```

### output 

送金先アドレス

bash

```bash
echo $P2PK_ADDR

=>
0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412
```

| フィールド              | 内容                                                                 |
|:------------------ |:------------------------------------------------------------------ |
| value              | 5046000000000000                                                   |
| scriputPubKeyのバイト数 | 23                                                                 |
| scriputPubKey      | 21(公開鍵サイズ33バイトの16進数表記）                                                  |
| 送金先公開鍵             | 0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412 |
| OP_CHECKSIG        | ac                                                                 |

### outputデータの連結結果

Ruby

```ruby
> value="5046000000000000"
> bytes="23"
> scriptPubkey="21"
> pubkey="0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412"
> op_checksig="ac"

> output = value+bytes+scriptPubkey+pubkey+op_checksig

=>
"504600000000000023210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac"
```

### P2PKトランザクションの作成

ruby

```ruby
> version="02000000"
> inputs="01"
> input
> outputs="01"
> output
> nLockTime="00000000"
> transaction = version+inputs+input+outputs+output+nLockTime

=>
"02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0000000000ffffffff01504600000000000023210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac00000000"

020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff01803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac00000000
```

### 作成したトランザクションの構造の確認

ooutput の "type": "pubkey" を確認

```bash
bitcoin-core.cli decoderawtransaction 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0000000000ffffffff01504600000000000023210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac00000000

=>
{
  "txid": "265b7d4497d8d87c548132e823833070fe80969d6bec93be2cb59c9ab4877640",
  "hash": "265b7d4497d8d87c548132e823833070fe80969d6bec93be2cb59c9ab4877640",
  "version": 2,
  "size": 95,
  "vsize": 95,
  "weight": 380,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412 OP_CHECKSIG",
        "desc": "pk(0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412)#yjkajaja",
        "hex": "210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac",
        "type": "pubkey"
      }
    }
  ]
}
```

### 作成したトランザクションへの署名

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0000000000ffffffff01504600000000000023210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac00000000

=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0000000000ffffffff01504600000000000023210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac0247304402200e6b15ccbd4859fc0fc704b8192c7fd65b8816a285fc2c947da2aa116bef7ddc022036fa3626c5c92fb7319409e42f8439d5db8be39befd42ce7d173fadf7af523250121039631ab36ba50c053d8de05574ee58cfd7aa641922787c1c2a326225f1fbeea4700000000",
  "complete": true
}
```

### P2PKトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0000000000ffffffff01504600000000000023210221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412ac0247304402200e6b15ccbd4859fc0fc704b8192c7fd65b8816a285fc2c947da2aa116bef7ddc022036fa3626c5c92fb7319409e42f8439d5db8be39befd42ce7d173fadf7af523250121039631ab36ba50c053d8de05574ee58cfd7aa641922787c1c2a326225f1fbeea4700000000

=>
265b7d4497d8d87c548132e823833070fe80969d6bec93be2cb59c9ab4877640
```


このトランザクションIDを シェル変数 P2PK_TXID に代入しておきます

```bash
P2PK_TXID="265b7d4497d8d87c548132e823833070fe80969d6bec93be2cb59c9ab4877640"
```
--

## <a id="TX8">TX8: 6種類の UTXO を inputとするトランザクションの作成 </a>

### UTXOの確認

この時点で　bitcoin core のワレット機能でUTXOとして確認可能なものは　P2PK, P2PKH, P2WPKH, PtTR  のoutputだけです。

P2SH と P2WSH のUTXOは，ワレットには認識されません。

```bash
bitcoin-core.cli listunspent

=>
[
  {
    "txid": "f66f7c67f0e2edab7d27d316662c31a9a5f33fe68dd9725854fe04bb7f23563f",
    "vout": 0,
    "address": "mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J",
    "label": "user_p2pkh",
    "scriptPubKey": "76a914d0c58609bfeafe97668feab8f356eccc78346c0588ac",
    "amount": 0.00018000,
    "confirmations": 18,
    "spendable": true,
    "solvable": true,
    "desc": "pkh([937090de/44h/1h/0h/0/0]03ca43b85715c22f748684bdf20870b0b5a858a69178a21b4a957ddfcbafea57d8)#l9r8akhc",
    "parent_descs": [
      "pkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/44h/1h/0h/0/*)#gg0qedgx"
    ],
    "safe": true
  },
  {
    "txid": "0bec2ecf9561b081d13d4dd6909a79114fdd3b9d9bfcc515cf9de96ccb31aa2c",
    "vout": 0,
    "address": "tb1qjf9kvs5k698luqwhkl9jqtdujwnwrx0250mnda",
    "label": "bech32",
    "scriptPubKey": "0014924b664296d14ffe01d7b7cb202dbc93a6e199ea",
    "amount": 0.00018000,
    "confirmations": 18,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/23]028cc0c1f80aefad0aac92be01ca0f450818e4dca5e3c5b60e3849b6e5f032b9ac)#hulp44e3",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 6,
    "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
    "label": "",
    "scriptPubKey": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
    "amount": 0.00878000,
    "confirmations": 73,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/0]031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33)#9wux8ep7",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "0903ffacbb7f212d81902d54979409610dc4b2c594a66789f35866d14f4e3dc1",
    "vout": 0,
    "address": "tb1pzwmas3lmkrn63wtgulylmtx79fvg3x5e0d6u9g50l3y8c3k0hvxqez8qxa",
    "label": "",
    "scriptPubKey": "512013b7d847fbb0e7a8b968e7c9fdacde2a58889a997b75c2a28ffc487c46cfbb0c",
    "amount": 0.00018000,
    "confirmations": 11,
    "spendable": true,
    "solvable": true,
    "desc": "tr([937090de/86h/1h/0h/0/2]ca1c9ea413d7508a75862b8b400ae90b18e79cfc6578c214a6df413c7d52fd03)#6gvty8zd",
    "parent_descs": [
      "tr(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/86h/1h/0h/0/*)#fyp9rl55"
    ],
    "safe": true
  }
]

```

### bitcoin core のワレットにマルチシグ情報を登録する

P2SHとP2WSHのマルチシグアドレス生成時に生成された descriptorを利用する

* P2SHのdescriptor

```bash
echo $P2SH_DESCRIPTOR

=>
sh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#c968pfza
```

* P2WSHのdescriptor

```bash
echo $P2WSH_DESCRIPTOR

=>
wsh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#04tn9tty
```

一般的には，マルチシグは複数の主体のワレットで署名しなければなりません。
この例では，単純化のために署名に必要なすべての秘密鍵が一つのワレットに入っています。

```
importdescriptors 

[
  {                                    (json object)
    "desc": "str",                     (string, required) Descriptor to import.
    "active": bool,                    (boolean, optional, default=false) Set this descriptor to be the active descriptor for the corresponding output type/externality
    "range": n or [n,n],               (numeric or array) If a ranged descriptor is used, this specifies the end or the range (in the form [begin,end]) to import
    "next_index": n,                   (numeric) If a ranged descriptor is set to active, this specifies the next index to generate addresses from
    "timestamp": timestamp | "now",    (integer / string, required) Time from which to start rescanning the blockchain for this descriptor, in UNIX epoch time
                                       Use the string "now" to substitute the current synced blockchain time.
                                       "now" can be specified to bypass scanning, for outputs which are known to never have been used, and
                                       0 can be specified to scan the entire blockchain. Blocks up to 2 hours before the earliest timestamp
                                       of all descriptors being imported will be scanned.
    "internal": bool,                  (boolean, optional, default=false) Whether matching outputs should be treated as not incoming payments (e.g. change)
    "label": "str",                    (string, optional, default='') Label to assign to the address, only allowed with internal=false
  },
  ...
]


```

JSON形式のインポート情報(descriptor)

```bash
echo "[{\"desc\": \"$P2SH_DESCRIPTOR\", \"timestamp\": \"now\"}]"

=>
[{"desc": "sh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#c968pfza", "timestamp": "now"}]
```

```bash
bitcoin-core.cli importdescriptors "[{\"desc\": \"$P2SH_DESCRIPTOR\", \"timestamp\": \"now\", "internal": true}]"

=>
 [
  {
    "success": true
  }
]
```

```bash
bitcoin-core.cli importmulti '[{"desc": "wsh(multi(2,0380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a65,03efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b,0290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b))#ezclpasq","timestamp": "now", "watchonly": true}]'

[
  {
    "success": true
  }
]
```

### これでワレットがP2SH, P2WSH を含めたすべてのUTXOを確認できるようになる

```bash
bitcoin-core.cli listunspent
=>
[
  {
    "txid": "aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a",
    "vout": 0,
    "address": "tb1q9ejzgpj47rpt6j86c2epvzgz654caek2ga36tn",
    "label": "",
    "scriptPubKey": "00142e64240655f0c2bd48fac2b2160902d52b8ee6ca",
    "amount": 0.00018000,
    "confirmations": 4,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([b6437264/0'/0'/98']031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b)#jvqdyz33",
    "safe": true
  },

  {
    "txid": "6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2",
    "vout": 0,
    "address": "mmZSyUyxaZJJNXCviNmUcg2jJ5KfSUJMZt",
    "label": "user3",
    "scriptPubKey": "76a914424986ff15df8a17a04f2b07520f0ef1dc9b742288ac",
    "amount": 0.00018000,
    "confirmations": 12,
    "spendable": true,
    "solvable": true,
    "desc": "pkh([b6437264/0'/0'/97']0222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701)#24jv8ctw",
    "safe": true
  },
  {
    "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
    "vout": 0,
    "address": "mgX9TGp5SxT6jczaKhf6fVDUdfsg1m45wf",
    "scriptPubKey": "21027544b898d2d886a7ee733f2cf3da01bfd5d2350fedf602f4d1b78412b5f4d851ac",
    "amount": 0.00016000,
    "confirmations": 1,
    "spendable": true,
    "solvable": true,
    "desc": "pk([60d80dee/0'/0'/35']027544b898d2d886a7ee733f2cf3da01bfd5d2350fedf602f4d1b78412b5f4d851)#24lz4ah2",
    "safe": true
  },
  {
    "txid": "89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e",
    "vout": 0,
    "address": "tb1qengwkeelq2wt3hras63jy03kgpdrxag22sx0ymzugqqnu83hcqsqk3wekc",
    "label": "",
    "witnessScript": "52210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae",
    "scriptPubKey": "0020ccd0eb673f029cb8dc7d86a3223e36405a33750a540cf26c5c40013e1e37c020",
    "amount": 0.00018000,
    "confirmations": 3,
    "spendable": false,
    "solvable": true,
    "desc": "wsh(multi(2,[82c79c5c]0380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a65,[3e282d87]03efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b,[b949ba0d]0290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b))#4cr4ee97",
    "safe": true
  },
    {
    "txid": "a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41",
    "vout": 0,
    "address": "2NAJZRpUeBUycwZHrcDRKsyufsUx25Djgw2",
    "label": "",
    "redeemScript": "52210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae",
    "scriptPubKey": "a914bb1b9d3762f5964beb822227eca7896c834b777587",
    "amount": 0.00018000,
    "confirmations": 4,
    "spendable": true,
    "solvable": true,
    "desc": "sh(multi(2,[6170057b]0237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d4,[f5d793b3]03ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645,[a332ac29]0345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b))#yqy68cgc",
    "safe": true
  }
]
```

### 送金先と金額

```bash
bitcoin-core.cli getnewaddress 
=>
tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue
```

送金金額：0.00088-0.00002=0.00086

### 6つのinputを持つ未署名のトランザクションの作成

P2PK, P2PKH, P2SH,P2WPKH,P2WSH の順で作成する

```bash
bitcoin-core.cli createrawtransaction  '[{"txid":"08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c","vout":0},{"txid":"6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2","vout":0},{"txid":"a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41","vout":0},{"txid":"aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a","vout":0},{"txid":"89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e","vout":0}]'  '[{"tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue": 0.00086}]'
=>
02000000059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c70080000000000ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a0000000000ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa00000000000ffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b00000000
```

### トランザクションへの署名

実際の運用では，マルチシグは複数の主体のワレットで順番に署名する必要があります。

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c70080000000000ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a0000000000ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa00000000000ffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b00000000
=>
{
  "hex": "020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000",
  "complete": true
}
```

### 作成したトランザクションの構造

```bash
bitcoin-core.cli decoderawtransaction 020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000
=>
{
  "txid": "11f36ca7c4840c2cd24dd58d061bd30ccad3a8e0885920dd6daca9c855372756",
  "hash": "bd8acb3055541202a3de6fb53dfa5fe1d82e00b334ab7223884f9aa68c1f06f6",
  "version": 2,
  "size": 1040,
  "vsize": 767,
  "weight": 3068,
  "locktime": 0,
  "vin": [
    {
      "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
      "vout": 0,
      "scriptSig": {
        "asm": "304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd[ALL]",
        "hex": "47304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01"
      },
      "sequence": 4294967295
    },
    {
      "txid": "6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2",
      "vout": 0,
      "scriptSig": {
        "asm": "30440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf0834[ALL] 0222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701",
        "hex": "4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701"
      },
      "sequence": 4294967295
    },
    {
      "txid": "a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41",
      "vout": 0,
      "scriptSig": {
        "asm": "0 304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa[ALL] 304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f[ALL] 52210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae",
        "hex": "0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae"
      },
      "sequence": 4294967295
    },
    {
      "txid": "aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f01",
        "031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b"
      ],
      "sequence": 4294967295
    },
    {
      "txid": "89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "",
        "304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d68501",
        "30440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b468001",
        "52210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae"
      ],
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00086000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 bcbc428f81a3c209f316e03fc46751ccd294709b",
        "desc": "addr(tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue)#qxp8yjj5",
        "hex": "0014bcbc428f81a3c209f316e03fc46751ccd294709b",
        "address": "tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}

```

### 署名済のトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000
=>
11f36ca7c4840c2cd24dd58d061bd30ccad3a8e0885920dd6daca9c855372756
```
