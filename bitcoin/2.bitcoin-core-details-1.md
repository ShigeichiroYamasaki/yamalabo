# 2. bitcoin core の詳細

2025/05/18
  更新 Shigeichiro Yamasaki

* [BIP](https://github.com/bitcoin/bips)


## 各種トランザクションの構成を一連の流れで演習します

以下のように，合計で８個のトランザクションを作成します．

ubuntu で snap を使って bitcoin core をインストールした環境を前提にしますが，MacOS で HomeBrew でインストールした場合や bitcoin-qt のコンソールからの場合は適宜コマンドなどを読み替えてください．

1.  5種類のoutput (P2PKH, P2SH, P2WPKH, P2WSH, P2TR)を持つトランザクション TX1 をブロードキャストする

```
(UTXOの資金)--> TX1 -+-->0.0002 BTC VOUT:1 -->TX3(P2PKH) --> 0.00018 BTC
                    +-->0.0002 BTC VOUT:2 -->TX4(P2SH)  --> 0.00018 BTC
                    +-->0.0002 BTC VOUT:3 -->TX5(P2WPKH)--> 0.00018 BTC
                    +-->0.0002 BTC VOUT:4 -->TX6(P2WSH) --> 0.00018 BTC
                    +-->0.0002 BTC VOUT:5 -->TX7(P2TR)  --> 0.00018 BTC
                    +-->おつり
```
2. 5種類タイプの異なるUTXOをinputとするトランザクション (TX3 ~ TX7) を作成するしてブロードキャストする


## 目次

* [descriptor ワレットの作成](#DESC)
* [6種類のアドレスの生成](#ADDR)
* [TX1: 7つのUTXOを生成するトランザクションの送信](#TX1)
* [次の演習への準備](#PREP)



##  <a id="DESC"> </a>descriptor ワレットの作成

### UTXOの所有と discriptor

当初，ブロックチェーン上のデジタル資産であるUTXOの所有の概念は，主体の秘密鍵による計算能力の証明（デジタル署名など）中心に構成されていました．

しかし P2SH などのスクリプトへの送金の概念の登場によって秘密鍵だけでは所有の概念を表現できなくなりました．

そこで，自分が所有するUTXOを定義するために [BIP380](https://github.com/bitcoin/bips/blob/master/bip-0380.mediawiki) で output script descriptor という言語が提案されました．

### output script descriptor

output script descriptorは，Scirpt Experession、Key Expression，チェックサムの３要素で構成されています．

```
function([derivation-path]key)#checksum
```

* Script Expression

    Bitcoinのスクリプトに直接対応する式。これらの式は関数として記述され、引数を取る

* Key Expression

    HD ウォレットのどの部分がエクスポートされるかを説明します。この場合、それは指紋を持つシードでありd6043800、そのシードの 0 番目の子の 0 番目の子の 18 番目の子 ( 0'/0'/18') 

    Script Expressionの引数としてよく使われる式に、Key Expressionがある。これは公開鍵または秘密鍵と、オプションとしてその鍵のオリジンに関する情報を表す

* チェックサム

  * hexエンコードされた公開鍵
  * WIFエンコードされた秘密鍵
  * xpubエンコードされた拡張公開鍵、もしくはxprvエンコードされた拡張秘密鍵

### descriptor の例

* 2-of-3 多重署名でロックされた P2SHタイプの output を表現する Descriptor の例

```json
sh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#c968pfza
```

* 2-of-3 多重署名でロックされた P2WSHタイプの output を表現する Descriptor の例

```json
wsh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#04tn9tty
```

### descriptor ワレットの作成

```
bitcoin-core.cli createwallet <ワレット名> <秘密鍵の無効化> <空ワレット> <パスフレーズ> <再利用禁止> <descripterの有効化> <起動時にロード> <外部署名の許可>
```

```bash
bitcoin-core.cli createwallet eve
```

```bash
bitcoin-core.cli listwallets

=>
[
  "alice",
  "bob",
  "eve"
]
```

ワレットのアンロード

```bash
bitcoin-core.cli unloadwallet alice

bitcoin-core.cli listwallets

[
  "bob",
  "eve"
]

```

ワレットの情報

```bash
bitcoin-core.cli -rpcwallet=bob getwalletinfo

=>
{
  "walletname": "bob",
  "walletversion": 169900,
  "format": "sqlite",
  "balance": 0.00498000,
  "unconfirmed_balance": 0.00000000,
  "immature_balance": 0.00000000,
  "txcount": 2,
  "keypoolsize": 4000,
  "keypoolsize_hd_internal": 4000,
  "paytxfee": 0.00000000,
  "private_keys_enabled": true,
  "avoid_reuse": false,
  "scanning": false,
  "descriptors": true,
  "external_signer": false,
  "blank": false,
  "birthtime": 1747385736,
  "lastprocessedblock": {
    "hash": "000000000525151f8b625eeb47c38773291d1e846c62ed5e51aa4a515f5729e4",
    "height": 82783
  }
}
```

### 最初のアドレス（最初のUTXOの所有者）の生成

```bash
BOB1=`bitcoin-core.cli -rpcwallet=bob getnewaddress BOB1`

#確認
echo $BOB1
=>
tb1qezzhzk540k0clr8eelspcmae8w0pll4jft0s8x
```

### faucet から BOB1に入金

[nestnet4 faucet](https://faucet.testnet4.dev/)


* 送金完了まで 10分以上かかります（20分以上かかることもあります）
* 待ち時間がもったいないので，コインの受領完了を待たずに，以下の「６種類のビットコインアドレスの生成」などをすすめてください．

ちなみにコインが受領されると以下のような状態になります．

```bash
bitcoin-core.cli -rpcwallet=bob getbalance
=>
0.00100000
```

## <a id="ADDR">6種類のビットコインアドレスの生成 </a>

6種類の outputのタイプへの送金には、それぞれ対応するアドレスタイプを持つ送金先アドレスが必要です。

以下に P2PK, P2PKH, P2SH, P2WPKH, P2WSH, P2TR の6タイプのアドレスを生成します．

#### getnewaddress コマンド

```bash
getnewaddress <ラベル> <アドレスタイプ>
```

アドレスタイプ

* legacy (base52アドレス）このタイプにさらに P2PKHとP2SHがあります
* bech32 (Bech32アドレス）このタイプにさらにP2WPKHとP2WSHがありあす
* p2sh-segwit (後方互換のため，Bech32アドレスをP2SHでラップしたアドレス)
* P2PK では、送金先の公開鍵がそのまま送金先アドレスになります

### P2PKアドレス

最も初期のアドレス形式です．

特別なアドレスフォーマットはなく，当事者の公開鍵がそのままアドレスになります

#### 公開鍵の確認方法

コマンドの文法

```
getaddressinfo <（自分のワレットの）ビットコインアドレス>
```


ここでは，P2WPKH として生成されたアドレスの情報から公開鍵を抜き出します．

```bash
# 確認例

echo $BOB1
=>
tb1qezzhzk540k0clr8eelspcmae8w0pll4jft0s8x
```

```bash
bitcoin-core.cli -rpcwallet=bob getaddressinfo $BOB1

=>
{
  "address": "tb1qezzhzk540k0clr8eelspcmae8w0pll4jft0s8x",
  "scriptPubKey": "0014c885715a957d9f8f8cf9cfe01c6fb93b9e1ffeb2",
  "ismine": true,
  "solvable": true,
  "desc": "wpkh([9278fcb8/84h/1h/0h/0/4]0321711a085a72323f063f3fc9c41cf09da341ae10accacd0cc289c10d443fde63)#yj9fppnn",
  "parent_desc": "wpkh([9278fcb8/84h/1h/0h]tpubDDhCsJ6XGQpV4ZcobSUHAv88MtVdeYCSW3R4wccKqLHeCTv2y23vzEg948dYybSFfJcsHnXL5D79oXG2Lm3phMG6SGmZXrG4PuNWfYhp8DJ/0/*)#g3xhechk",
  "iswatchonly": false,
  "isscript": false,
  "iswitness": true,
  "witness_version": 0,
  "witness_program": "c885715a957d9f8f8cf9cfe01c6fb93b9e1ffeb2",
  "pubkey": "0321711a085a72323f063f3fc9c41cf09da341ae10accacd0cc289c10d443fde63",
  "ischange": false,
  "timestamp": 1747385736,
  "hdkeypath": "m/84h/1h/0h/0/4",
  "hdseedid": "0000000000000000000000000000000000000000",
  "hdmasterfingerprint": "9278fcb8",
  "labels": [
    "BOB1"
  ]
}
```

* 公開鍵は  JSON 構造のキー "pubkey": の部分です．

この公開鍵の情報を [jq コマンド](https://www.karakaram.com/notes-on-jq-command/) を利用して P2PK アドレスとしてシェル変数 P2PK_ADDR に代入しておきます

```bash
P2PK_ADDR=`bitcoin-core.cli -rpcwallet=bob getaddressinfo $BOB1|jq -r '.pubkey'`

#確認
echo $P2PK_ADDR
=>
0321711a085a72323f063f3fc9c41cf09da341ae10accacd0cc289c10d443fde63
```

### P2PKHアドレス

当事者の公開鍵のハッシュ値から生成され base52 エンコードしたアドレスです

シェル変数 P2PKH_ADDRに代入しておきます．

```bash
P2PKH_ADDR=`bitcoin-core.cli -rpcwallet=bob getnewaddress pkh_user legacy`

#確認
echo $P2PKH_ADDR
=>
n2yA2WM4UUiYXEZ4TFWi8AXQT12Se7HyUT
```

### P2SHアドレス

当事者の公開鍵ではなく，bitcoin スクリプトのハッシュ値から生成されたアドレスです．

その典型例がマルチシグ（多重署名）用アドレスです。

#### マルチシグ用公開鍵のリストの作成
 
アドレスの生成には、n人の署名者たちの公開鍵が必要です。

ここでは openssl を利用して ３人の秘密鍵と公開鍵を生成します

```bash
SIGNER1=`bitcoin-core.cli -rpcwallet=bob getnewaddress signer1`
SIGNER2=`bitcoin-core.cli -rpcwallet=bob getnewaddress signer2`
SIGNER3=`bitcoin-core.cli -rpcwallet=bob getnewaddress signer3`

#確認
echo $SIGNER1
=>
tb1qn7zwfp0taa8f5pqwz3d66fa6m7tn2hq8230e07
echo $SIGNER2
=>
tb1qcp3t5t5z6euc95h3zsgfxsdd8x8lz88rs2a47x
echo $SIGNER3
=>
tb1qe5yrtmgszvm5qejrt2cl964kcc79den0euk752

PUBKEY1=`bitcoin-core.cli -rpcwallet=bob getaddressinfo $SIGNER1|jq -r '.pubkey'`
PUBKEY2=`bitcoin-core.cli -rpcwallet=bob getaddressinfo $SIGNER2|jq -r '.pubkey'`
PUBKEY3=`bitcoin-core.cli -rpcwallet=bob getaddressinfo $SIGNER3|jq -r '.pubkey'`

#確認
echo $PUBKEY1
=> 
033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc085
echo $PUBKEY2
=>
020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb89467
echo $PUBKEY3
=>
031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b474
```

#### マルチシグアドレスの生成

 m of n マルチシグ（n人の公開鍵の中でm人の署名があれば成功する署名）のためのアドレス生成です。
 
コマンドの文法

```
createmultisig <必要署名数 m> '[<公開鍵1>,<公開鍵2>,...,<公開鍵n>]' <アドレスタイプ>
```

 <アドレスタイプ> の指定によって　P2SH　と　P2WSH　が区別されます。

アドレスタイプ:  P2SH＝"legacy", P2SHのSegWitラップ="p2sh-segwit", P2WSH="bech32"

マルチシグアドレス生成結果

```json
{                            (json object)
  "address" : "str",         (string) The value of the new multisig address.
  "redeemScript" : "hex",    (string) The string value of the hex-encoded redemption script.
  "descriptor" : "str"       (string) The descriptor for this multisig
}
```

2 of 3 の場合

```bash
P2SH=`bitcoin-core.cli -rpcwallet=bob createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" legacy`

#確認
echo $P2SH
=>
{ "address": "2MsYJ1mnRt6TDVc7ise2rJv2u6MyuD5ZSQ3", "redeemScript": "5221033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc08521020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb8946721031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b47453ae", "descriptor": "sh(multi(2,033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc085,020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb89467,031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b474))#rhss2k5u" }
```

ここでは，シェル変数 P2SH_ADDRに生成したアドレスを代入しておきます

```bash
P2SH_ADDR=`echo $P2SH|jq -r '.address'`

#確認
echo $P2SH_ADDR
=>
2MsYJ1mnRt6TDVc7ise2rJv2u6MyuD5ZSQ3
```

#### P2SH redeemScript

P2SHのアウトプットをアンロックするには、redeemScriptが必要です

上記のマルチシグアドレス生成時に対応する redeemscriptも生成されています．

シェル変数 P2SH_REDEEMSCRIPT にその内容を代入しておきます

```bash
P2SH_REDEEMSCRIPT=`echo $P2SH|jq -r '.redeemScript'`

#確認
echo $P2SH_REDEEMSCRIPT
=>
5221033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc08521020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb8946721031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b47453ae
```

#### P2SH descriptor

* P2SH でロックされているUTXOをアンロックするためには，まず第１段階として redeemscript とそのハッシュ値が必要です．

* 第２段階で，マルチシグの実際の署名を行う場所は署名者それぞれのワレットで， redeemScript に沿ってそれぞれの秘密鍵を使って署名を行います。

* それを可能にするためには、それぞれの署名者のワレットに redeemScript などの必要な情報を組み込む必要があります。

* descriptor　は、ワレットにマルチシグ署名のための情報を組み込むためのデータです。

ここでは，シェル変数 P2SH_DESCRIPTOR にその内容を代入しておきます．

```bash
P2SH_DESCRIPTOR=`echo $P2SH|jq -r '.descriptor'`

#確認
echo $P2SH_DESCRIPTOR
=>
sh(multi(2,033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc085,020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb89467,031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b474))#rhss2k5u
```

##### マルチシグアドレス生成の実際と公開鍵の提示

ここでの例では、複数のアドレスを一つのワレットで生成していますが、実際は複数の人のワレットで生成します。

上記のように、マルチシグアドレスの生成には公開鍵が必要です。

しかし、アドレスごとの公開鍵は非公開情報です。したがって、実際にマルチシグに参加する当事者がそれぞれ自分で自分の公開鍵を確認し、信頼できる第三者であるマルチシグアドレス生成者に提示する必要があります。


### P2WPKHアドレス 

Bech32アドレスの生成（受領者の公開鍵ハッシュの場合）

ここでは，シェル変数 P2WPKH_ADDR にアドレスを代入しておきます．

```bash
P2WPKH_ADDR=`bitcoin-core.cli -rpcwallet=bob getnewaddress wpkh_user bech32`

#確認
echo $P2WPKH_ADDR

=>
tb1q9z6g0m0c9aeq8kxrg469rx95a2m7wyc34u6yqy
```

### P2WSHアドレス

基本的にP2SHと同じです。


2 of 3 の場合

```bash
P2WSH=`bitcoin-core.cli -rpcwallet=bob createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" bech32`

# 確認
echo $P2WSH
=>
{ "address": "tb1qmaz02v4u30ufhcf9vlqrmw0dh8wshxsl4y903qxn0gr0764gu2fq5h9zya", "redeemScript": "5221033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc08521020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb8946721031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b47453ae", "descriptor": "wsh(multi(2,033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc085,020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb89467,031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b474))#h402ar9g" }
```

ここではシェル変数 P2WSH_ADDR に内容を代入しておきます

```bash
P2WSH_ADDR=`echo $P2WSH|jq -r '.address'`

#確認
echo $P2WSH_ADDR
=>
tb1qmaz02v4u30ufhcf9vlqrmw0dh8wshxsl4y903qxn0gr0764gu2fq5h9zya
```


#### P2WSH redeemScript

ここではシェル変数 P2WSH_REDEEMSCRIPT にその内容を代入しておきます

```bash
P2WSH_REDEEMSCRIPT=`echo $P2WSH|jq -r '.redeemScript'`

#確認
echo $P2WSH_REDEEMSCRIPT
=>
5221033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc08521020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb8946721031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b47453ae
```

#### P2SH descriptor

ここでは，シェル変数 P2WSH_DESCRIPTOR にその内容を代入しておきます．

```bash
P2WSH_DESCRIPTOR=`echo $P2WSH|jq -r '.descriptor'`

#確認
echo $P2WSH_DESCRIPTOR
=>
wsh(multi(2,033ed713a00519f08053686df55e37913472f929fbb530d9dd558984da6cbdc085,020ebadaa5d844e6994b3f01c242fc0a1aa583dcb23f29e7d9e2dd368c8fb89467,031b3c4b6142ef3fbedb8b1fcc541112056e6626f8932eff95b2daa9d9b637b474))#h402ar9g
```

### P2TRアドレス


Bech32m アドレスの生成（受領者の公開鍵）

ここでは，シェル変数 P2TR_ADDR にアドレスを代入しておきます．

getnewaddress コマンドでラベルの設定が必要です

```bash
P2TR_ADDR=`bitcoin-core.cli -rpcwallet=bob getnewaddress tr_user bech32m`

#確認
echo $P2TR_ADDR
=>
tb1pww0jg0400s8a7amgpr000jpfdvnjsvhggnucnxqlp63hurzn2vzq905hh9
```

## <a id="TX1"> </a>7つのUTXOを生成するトランザクションの送信


### 使用するUTXOを確認する

この例では、"amount": 0.0010000　を持つUTXOを利用しますが，以下では自分が所持している bitcoin の金額でトランザクションを作成してください．

使用する"txid" と "vout"と "amount" と "address" の値をメモしてください

#### UTXOの例

自分のUTXOを確認してください

★★（以下は例です，必ず自分のUTXOのものをチェックしてください！）


UTXOを複数所持している場合は，amount が 0.001 以上あるものを一つ選んでください．


★★ （ここではUTXOの 金額を 0.001 BTC にしていますが，それよりも多い場合は必ずおつりの計算を間違えないようにしてください！！）

★★ （おつりの計算を間違えると，失った所持金はマイナーの報酬になり，戻ってきません）


```bash
bitcoin-core.cli -rpcwallet=bob listunspent

# ここでの例
=>
[
  {
    "txid": "7da8a519a48aa705145c7b6f385cf9acbf3c3e8676c54f6f69fe46198b66c874",
    "vout": 1,
    "address": "tb1qezzhzk540k0clr8eelspcmae8w0pll4jft0s8x",
    "label": "BOB1",
    "scriptPubKey": "0014c885715a957d9f8f8cf9cfe01c6fb93b9e1ffeb2",
    "amount": 0.00500000,
    "confirmations": 1,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([9278fcb8/84h/1h/0h/0/4]0321711a085a72323f063f3fc9c41cf09da341ae10accacd0cc289c10d443fde63)#yj9fppnn",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4XyV3UcGaHzzXH21ZToEr1Kx55UU3SVR6KTnvjJMP6gDSDo8Q4ZKX2KTkPnipXsEMAz4H5RhyvGbirEFxewpuswV9NAoy226/84h/1h/0h/0/*)#50e604cn"
    ],
    "safe": true
  },
  {
    "txid": "b1494b7638eb5607cba8242fffa9287c3dc560e175e522c7137f4cb8fd611bbc",
    "vout": 0,
    "address": "tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0",
    "label": "",
    "scriptPubKey": "001491d73031b2546aa51c94aebb4aa3c4b5b377f6d7",
    "amount": 0.00100000,
    "confirmations": 2,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([9278fcb8/84h/1h/0h/0/1]029f40c4fd7601a94f1d2c350fd6d18132f54844086a7e9bf43a5488685de44664)#34993jna",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4XyV3UcGaHzzXH21ZToEr1Kx55UU3SVR6KTnvjJMP6gDSDo8Q4ZKX2KTkPnipXsEMAz4H5RhyvGbirEFxewpuswV9NAoy226/84h/1h/0h/0/*)#50e604cn"
    ],
    "safe": true
  },
  {
    "txid": "b1494b7638eb5607cba8242fffa9287c3dc560e175e522c7137f4cb8fd611bbc",
    "vout": 1,
    "address": "tb1qln4u5rsfjmcjgmlw8n4ecq252ws7skkcr9uuml",
    "label": "",
    "scriptPubKey": "0014fcebca0e0996f1246fee3ceb9c015453a1e85ad8",
    "amount": 0.00398000,
    "confirmations": 2,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([9278fcb8/84h/1h/0h/0/0]0210d8774ce4d535d68831ccb4edec1a6910a29353f20a9a2687596e9e224aee48)#ha9yqrvk",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4XyV3UcGaHzzXH21ZToEr1Kx55UU3SVR6KTnvjJMP6gDSDo8Q4ZKX2KTkPnipXsEMAz4H5RhyvGbirEFxewpuswV9NAoy226/84h/1h/0h/0/*)#50e604cn"
    ],
    "safe": true
  }
]

```

この例では，UTXOの配列の2番目(インデックは[1])のUTXOの "amount" が 0.001 BTC なので，これを使うことにします．

シェル変数への代入を使う場合は以下のようになります


```bash
UTXOS=`bitcoin-core.cli -rpcwallet=bob listunspent`
UTXO=`echo $UTXOS | jq -r '.[1]'`

# 確認
echo $UTXO

=>
{ "txid": "b1494b7638eb5607cba8242fffa9287c3dc560e175e522c7137f4cb8fd611bbc", "vout": 0, "address": "tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0", "label": "", "scriptPubKey": "001491d73031b2546aa51c94aebb4aa3c4b5b377f6d7", "amount": 0.00100000, "confirmations": 2, "spendable": true, "solvable": true, "desc": "wpkh([9278fcb8/84h/1h/0h/0/1]029f40c4fd7601a94f1d2c350fd6d18132f54844086a7e9bf43a5488685de44664)#34993jna", "parent_descs": [ "wpkh(tpubD6NzVbkrYhZ4XyV3UcGaHzzXH21ZToEr1Kx55UU3SVR6KTnvjJMP6gDSDo8Q4ZKX2KTkPnipXsEMAz4H5RhyvGbirEFxewpuswV9NAoy226/84h/1h/0h/0/*)#50e604cn" ], "safe": true }
```

自分のUTXOの txid , vout, address をシェル変数に代入します

```
TXID="<txidの内容>"
VOUT="<voutの内容>"
ADDRESS="<addressの内容>"
```

上記の例の場合
★（必ず自分のUTXOのものに置き換えてください）

```bash
TXID=`echo $UTXO|jq -r '.txid'`
VOUT=`echo $UTXO|jq -r '.vout'`
CHANGE_ADDRESS=`echo $UTXO|jq -r '.address'`

# 確認
echo $TXID
=>
b1494b7638eb5607cba8242fffa9287c3dc560e175e522c7137f4cb8fd611bbc

echo $VOUT
=>
0

echo $CHANGE_ADDRESS
=>
tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0
```

★ この CHANGE_ADDRESS に指定するアドレスは，UTXOを所有している自分のアドレスで，おつりとして取り戻すためのアドレスです．

### 5+1 個のoutputを持つトランザクションを作成する

* input として使用するUTXOの txid と vout
* output は、生成した5つのアドレスです
* 5つの送金先アドレスへの送金金額は，それぞれ 0.0001 とします．
* outputにはおつり用のアドレスがさらに一つ必要です．ここではUTXOの所有者にします．

#### おつりの計算

ここではトランザクション手数料は 0.00002 とします．

UTXOの資金を 0.001 BTC とすると

```
0.001 - (0.0001)*5 - 0.00002 =   0.00048
```

### 5種類のアウトプットを持つ未署名トランザクションの作成

JSON形式で input と output を作成し，未署名のトランザクションを作成します

P2PKH, P2SH, P2WPKH, P2WSH, P2TR の５種類です．

実行結果は 16進数形式です．

```bash
UNSIGNED_TX=`bitcoin-core.cli -rpcwallet=bob createrawtransaction "[{\"txid\":\"$TXID\",\"vout\":$VOUT}]" "[{\"$P2PKH_ADDR\":0.0001},{\"$P2SH_ADDR\":0.0001},{\"$P2WPKH_ADDR\":0.0001},{\"$P2WSH_ADDR\":0.0001},{\"$P2TR_ADDR\":0.0001},{\"$CHANGE_ADDRESS\":0.00048}]"`

# 確認
echo $UNSIGNED_TX
=>
0200000001bc1b61fdb84c7f13c722e575e160c53d7c28a9ff2f24a8cb0756eb38764b49b10000000000fdffffff0610270000000000001976a914eb4f3ff2de050b88afbbe74df54187c06bf027b488ac102700000000000017a914033a6e8b41553b9df8eb52cdf233c84632c137c087102700000000000016001428b487edf82f7203d8c345745198b4eab7e713111027000000000000220020df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e2921027000000000000225120739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c53530480bb00000000000016001491d73031b2546aa51c94aebb4aa3c4b5b377f6d700000000
```

作成したトランザクションの確認

```bash
bitcoin-core.cli decoderawtransaction $UNSIGNED_TX

=>
{
  "txid": "3084d35690cdf25702000b4af622cfba85ac0519095973bcf70d6133bb3d4cab",
  "hash": "3084d35690cdf25702000b4af622cfba85ac0519095973bcf70d6133bb3d4cab",
  "version": 2,
  "size": 265,
  "vsize": 265,
  "weight": 1060,
  "locktime": 0,
  "vin": [
    {
      "txid": "b1494b7638eb5607cba8242fffa9287c3dc560e175e522c7137f4cb8fd611bbc",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00010000,
      "n": 0,
      "scriptPubKey": {
        "asm": "OP_DUP OP_HASH160 eb4f3ff2de050b88afbbe74df54187c06bf027b4 OP_EQUALVERIFY OP_CHECKSIG",
        "desc": "addr(n2yA2WM4UUiYXEZ4TFWi8AXQT12Se7HyUT)#6c79we8h",
        "hex": "76a914eb4f3ff2de050b88afbbe74df54187c06bf027b488ac",
        "address": "n2yA2WM4UUiYXEZ4TFWi8AXQT12Se7HyUT",
        "type": "pubkeyhash"
      }
    },
    {
      "value": 0.00010000,
      "n": 1,
      "scriptPubKey": {
        "asm": "OP_HASH160 033a6e8b41553b9df8eb52cdf233c84632c137c0 OP_EQUAL",
        "desc": "addr(2MsYJ1mnRt6TDVc7ise2rJv2u6MyuD5ZSQ3)#nmxxdxu7",
        "hex": "a914033a6e8b41553b9df8eb52cdf233c84632c137c087",
        "address": "2MsYJ1mnRt6TDVc7ise2rJv2u6MyuD5ZSQ3",
        "type": "scripthash"
      }
    },
    {
      "value": 0.00010000,
      "n": 2,
      "scriptPubKey": {
        "asm": "0 28b487edf82f7203d8c345745198b4eab7e71311",
        "desc": "addr(tb1q9z6g0m0c9aeq8kxrg469rx95a2m7wyc34u6yqy)#60rmrrff",
        "hex": "001428b487edf82f7203d8c345745198b4eab7e71311",
        "address": "tb1q9z6g0m0c9aeq8kxrg469rx95a2m7wyc34u6yqy",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00010000,
      "n": 3,
      "scriptPubKey": {
        "asm": "0 df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e292",
        "desc": "addr(tb1qmaz02v4u30ufhcf9vlqrmw0dh8wshxsl4y903qxn0gr0764gu2fq5h9zya)#k8hkhjgu",
        "hex": "0020df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e292",
        "address": "tb1qmaz02v4u30ufhcf9vlqrmw0dh8wshxsl4y903qxn0gr0764gu2fq5h9zya",
        "type": "witness_v0_scripthash"
      }
    },
    {
      "value": 0.00010000,
      "n": 4,
      "scriptPubKey": {
        "asm": "1 739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c535304",
        "desc": "rawtr(739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c535304)#kxhrl33z",
        "hex": "5120739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c535304",
        "address": "tb1pww0jg0400s8a7amgpr000jpfdvnjsvhggnucnxqlp63hurzn2vzq905hh9",
        "type": "witness_v1_taproot"
      }
    },
    {
      "value": 0.00048000,
      "n": 5,
      "scriptPubKey": {
        "asm": "0 91d73031b2546aa51c94aebb4aa3c4b5b377f6d7",
        "desc": "addr(tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0)#t4u3peeg",
        "hex": "001491d73031b2546aa51c94aebb4aa3c4b5b377f6d7",
        "address": "tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}
```

### 作成したトランザクションに署名する

```bash
SIGNED_TX=`bitcoin-core.cli -rpcwallet=bob signrawtransactionwithwallet $UNSIGNED_TX`

# 確認
echo $SIGNED_TX
=>
{ "hex": "02000000000101bc1b61fdb84c7f13c722e575e160c53d7c28a9ff2f24a8cb0756eb38764b49b10000000000fdffffff0610270000000000001976a914eb4f3ff2de050b88afbbe74df54187c06bf027b488ac102700000000000017a914033a6e8b41553b9df8eb52cdf233c84632c137c087102700000000000016001428b487edf82f7203d8c345745198b4eab7e713111027000000000000220020df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e2921027000000000000225120739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c53530480bb00000000000016001491d73031b2546aa51c94aebb4aa3c4b5b377f6d70247304402204a496555b08f496645bf68725ac14b2b68c188ab7fcf39c1d4bcef0e7dbe1efc02204a7cea79fcc390a94a6c3d5f3bf3d430e8d39c6c72e4cb91572b709bc31a279d0121029f40c4fd7601a94f1d2c350fd6d18132f54844086a7e9bf43a5488685de4466400000000", "complete": true }
```

署名したトランザクションの16進数形式内容の確認（hex の値）

```bash
SIGNED_TX_HEX=`echo $SIGNED_TX|jq -r '.hex'`

# 確認
echo $SIGNED_TX_HEX
=>
02000000000101bc1b61fdb84c7f13c722e575e160c53d7c28a9ff2f24a8cb0756eb38764b49b10000000000fdffffff0610270000000000001976a914eb4f3ff2de050b88afbbe74df54187c06bf027b488ac102700000000000017a914033a6e8b41553b9df8eb52cdf233c84632c137c087102700000000000016001428b487edf82f7203d8c345745198b4eab7e713111027000000000000220020df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e2921027000000000000225120739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c53530480bb00000000000016001491d73031b2546aa51c94aebb4aa3c4b5b377f6d70247304402204a496555b08f496645bf68725ac14b2b68c188ab7fcf39c1d4bcef0e7dbe1efc02204a7cea79fcc390a94a6c3d5f3bf3d430e8d39c6c72e4cb91572b709bc31a279d0121029f40c4fd7601a94f1d2c350fd6d18132f54844086a7e9bf43a5488685de4466400000000

```

★ txinwitness 領域が作成されていることを確認する

```bash
bitcoin-core.cli decoderawtransaction $SIGNED_TX_HEX

=>
{
  "txid": "3084d35690cdf25702000b4af622cfba85ac0519095973bcf70d6133bb3d4cab",
  "hash": "13cb8295ab8a57aebb72dae68a288b5ba1a6a55ae360adc09cbeef06c532c064",
  "version": 2,
  "size": 374,
  "vsize": 293,
  "weight": 1169,
  "locktime": 0,
  "vin": [
    {
      "txid": "b1494b7638eb5607cba8242fffa9287c3dc560e175e522c7137f4cb8fd611bbc",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402204a496555b08f496645bf68725ac14b2b68c188ab7fcf39c1d4bcef0e7dbe1efc02204a7cea79fcc390a94a6c3d5f3bf3d430e8d39c6c72e4cb91572b709bc31a279d01",
        "029f40c4fd7601a94f1d2c350fd6d18132f54844086a7e9bf43a5488685de44664"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00010000,
      "n": 0,
      "scriptPubKey": {
        "asm": "OP_DUP OP_HASH160 eb4f3ff2de050b88afbbe74df54187c06bf027b4 OP_EQUALVERIFY OP_CHECKSIG",
        "desc": "addr(n2yA2WM4UUiYXEZ4TFWi8AXQT12Se7HyUT)#6c79we8h",
        "hex": "76a914eb4f3ff2de050b88afbbe74df54187c06bf027b488ac",
        "address": "n2yA2WM4UUiYXEZ4TFWi8AXQT12Se7HyUT",
        "type": "pubkeyhash"
      }
    },
    {
      "value": 0.00010000,
      "n": 1,
      "scriptPubKey": {
        "asm": "OP_HASH160 033a6e8b41553b9df8eb52cdf233c84632c137c0 OP_EQUAL",
        "desc": "addr(2MsYJ1mnRt6TDVc7ise2rJv2u6MyuD5ZSQ3)#nmxxdxu7",
        "hex": "a914033a6e8b41553b9df8eb52cdf233c84632c137c087",
        "address": "2MsYJ1mnRt6TDVc7ise2rJv2u6MyuD5ZSQ3",
        "type": "scripthash"
      }
    },
    {
      "value": 0.00010000,
      "n": 2,
      "scriptPubKey": {
        "asm": "0 28b487edf82f7203d8c345745198b4eab7e71311",
        "desc": "addr(tb1q9z6g0m0c9aeq8kxrg469rx95a2m7wyc34u6yqy)#60rmrrff",
        "hex": "001428b487edf82f7203d8c345745198b4eab7e71311",
        "address": "tb1q9z6g0m0c9aeq8kxrg469rx95a2m7wyc34u6yqy",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00010000,
      "n": 3,
      "scriptPubKey": {
        "asm": "0 df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e292",
        "desc": "addr(tb1qmaz02v4u30ufhcf9vlqrmw0dh8wshxsl4y903qxn0gr0764gu2fq5h9zya)#k8hkhjgu",
        "hex": "0020df44f532bc8bf89be12567c03db9edb9dd0b9a1fa90af880d37a06ff6aa8e292",
        "address": "tb1qmaz02v4u30ufhcf9vlqrmw0dh8wshxsl4y903qxn0gr0764gu2fq5h9zya",
        "type": "witness_v0_scripthash"
      }
    },
    {
      "value": 0.00010000,
      "n": 4,
      "scriptPubKey": {
        "asm": "1 739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c535304",
        "desc": "rawtr(739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c535304)#kxhrl33z",
        "hex": "5120739f243eaf7c0fdf776808def7c8296b272832e844f989981f0ea37e0c535304",
        "address": "tb1pww0jg0400s8a7amgpr000jpfdvnjsvhggnucnxqlp63hurzn2vzq905hh9",
        "type": "witness_v1_taproot"
      }
    },
    {
      "value": 0.00048000,
      "n": 5,
      "scriptPubKey": {
        "asm": "0 91d73031b2546aa51c94aebb4aa3c4b5b377f6d7",
        "desc": "addr(tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0)#t4u3peeg",
        "hex": "001491d73031b2546aa51c94aebb4aa3c4b5b377f6d7",
        "address": "tb1qj8tnqvdj234228y546a54g7ykkeh0akh7y35k0",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}
```

### 署名したトランザクションをブロードキャストする

返り値のトランザクションIDをメモする

```bash
SENT_TXID=`bitcoin-core.cli -rpcwallet=bob sendrawtransaction $SIGNED_TX_HEX`

#確認
echo $SENT_TXID
=>
3084d35690cdf25702000b4af622cfba85ac0519095973bcf70d6133bb3d4cab
```

### 送信したトランザクションを確認する

引数のトランザクションIDは，自分が送信したトランザクションIDです

```bash
bitcoin-core.cli -rpcwallet=bob gettransaction $SENT_TXID
```

### 10分以上経過後，UTXOのリストを確認する

UTXOの数が増えていることを確認します．

```bash
bitcoin-core.cli -rpcwallet=bob listunspent

```

## <a id="PREP"> </a>次の演習への準備

シェル変数に格納していた内容を次回の演習のために保存しておきます．

各自それぞれの環境によって内容が異なります．

確実に自分のシェル変数の内容を保管しておき，次回に再現できるようにしておきましょう．

### 次回の演習に必要となるシェル変数の値の一覧

```
SENT_TXID
SIGNED_TX
UNSIGNED_TX
UTXO
P2TR_ADDR
P2WSH_DESCRIPTOR
P2WSH_REDEEMSCRIPT
P2WSH_ADDR
P2WSH
P2WPKH_ADDR
P2SH_DESCRIPTOR
P2SH_REDEEMSCRIPT
P2SH_ADDR
P2SH
PUBKEY1
PUBKEY2
PUBKEY3
SIGNER1
SIGNER2
SIGNER3
P2PKH_ADDR
P2PK_ADDR
BOB
TARO
```

### シェル変数を再現するファイルの作成

以下のスクリプトの実行結果を テキストファイル として保存しておいてください

```bash
echo "TARO=\"$TARO\""
echo "BOB=\"$BOB\""
echo "BP2PK_ADDROB=\"$P2PK_ADDR\""
echo "P2PKH_ADDR=\"$P2PKH_ADDR\""
echo "SIGNER1=\"$SIGNER1\""
echo "SIGNER2=\"$SIGNER2\""
echo "SIGNER3=\"$SIGNER3\""
echo "PUBKEY1=\"$PUBKEY1\""
echo "PUBKEY2=\"$PUBKEY2\""
echo "PUBKEY3=\"$PUBKEY3\""
echo "P2SH='$(bitcoin-core.cli createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" legacy)'"
echo "P2SH_ADDR=\"$P2SH_ADDR\""
echo "P2SH_REDEEMSCRIPT=\"$P2SH_REDEEMSCRIPT\""
echo "P2SH_DESCRIPTOR=\"$P2SH_DESCRIPTOR\""
echo "P2WPKH_ADDR=\"$P2WPKH_ADDR\""
echo "P2WSH='$(bitcoin-core.cli createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" bech32)'"
echo "P2WSH_ADDR=\"$P2WSH_ADDR\""
echo "P2WSH_REDEEMSCRIPT=\"$P2WSH_REDEEMSCRIPT\""
echo "P2WSH_DESCRIPTOR=\"$P2WSH_DESCRIPTOR\""
echo "P2TR_ADDR=\"$P2TR_ADDR\""
echo "UNSIGNED_TX=\"$UNSIGNED_TX\""
echo "SIGNED_TX_HEX=\"$SIGNED_TX_HEX\""
echo "SENT_TXID=\"$SENT_TXID\""
```

実行結果の例（必ず自分の環境で実行してください）

自分の環境で実行した内容をテキストファイルとして保管してください．

次回の演習に必要になります．
