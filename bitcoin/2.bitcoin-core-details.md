# 2. bitcoin core の詳細

2024/05/25  更新 Shigeichiro Yamasaki

## ビットコイン開発コミュニティとBIP

* [メーリングリスト bitcoin-dev](https://lists.linuxfoundation.org/mailman/listinfo/bitcoin-dev)
* [Slack: https://bitcoincore.slack.com/](https://bitcoincore.slack.com/)
* [BIP](https://github.com/bitcoin/bips)

## 一連の流れで演習します

```

(UTXOの資金)--> TX1 -+-->0.0002BTC VOUT:0 -->TX2(P2PK)  --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:1 -->TX3(P2PKH) --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:2 -->TX4(P2SH)  --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:3 -->TX5(P2WPKH)--> 0.00018BTC-+
                    +-->0.0002BTC VOUT:4 -->TX6(P2WSH) --> 0.00018BTC-+
                    +-->0.0002BTC VOUT:5 -->TX7(P2TR)  --> 0.00018BTC-+--> TX8
                    +-->おつり
```

0. 事前にsignetのfaucet から0.002 BTC 以上のビットコインを得ておきます。
1. TX1 faucetから得たUTXOをinputとして 7個のoutputを持つトランザクション (TX1) を作成し，署名して，ブロードキャストする
2. 6個のUTXOを利用して，6個のトランザクション (TX2 ~ TX7) を作成しそれぞれ署名して，ブロードキャストする

    ★ (TX2 ~ TX7) はそれぞれP2PK, P2PKH, P2SH, P2WPKH, P2WSH の5つのタイプのoutputを持つ
3. 6個のタイプの異なるUTXOをinputとして，１個のUTXOにまとめるトランザクション TX8 を作成する
    ★ P2SH, P2WSH のUTXOをワレットに認識させる必要があります。


## 目次

* [TX1: 7つのUTXOを生成する](#TX1)
* [6種類のアドレスの生成](#ADDR)
* [TX3: P2PKH トランザクションの作成](#TX3)
* [TX4: P2SH トランザクションの作成](#TX4)
* [TX5: P2WPKH トランザクションの作成](#TX5)
* [TX6: P2WSH トランザクションの作成](#TX6)
* [TX7: P2TR トランザクションの作成](#TX7)
* [TX2: P2PK トランザクションの作成](#TX2)
* [TX8: 6種類の UTXO を inputとするトランザクションの作成](#TX8)

## <a id="TX1"> </a>TX1: 7つのUTXOを生成する

★ 以下はアドレス生成の例で，シェル変数にアドレスを代入しています．

```bash
USER1=`bitcoin-core.cli  getnewaddress user1`
USER2=`bitcoin-core.cli  getnewaddress user2`
USER3=`bitcoin-core.cli  getnewaddress user3`
USER4=`bitcoin-core.cli  getnewaddress user4`
USER5=`bitcoin-core.cli  getnewaddress user5`
USER6=`bitcoin-core.cli  getnewaddress user6`
```

生成したアドレスの確認

```bash
echo $USER1
=>
tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe

echo $USER2
...
```

### 使用するUTXOを確認する

この例では、"amount": 0.0100000　を持つUTXOを利用しますが，以下では自分が所持している bitcoin の金額でトランザクションを作成してください．

使用する"txid" と "vout"と "amount" と "address" の値をメモしてください

#### UTXOの例

自分のUTXOを確認してください

```bash
bitcoin-core.cli  listunspent
[
  {
    "txid": "a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff",
    "vout": 0,
    "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
    "label": "",
    "scriptPubKey": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
    "amount": 0.01000000,
    "confirmations": 100,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/0]031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33)#9wux8ep7",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  }
]

```

自分のUTXOの txid , vout, address をシェル変数に代入します

```bash
TXID="<txidの内容>"
VOUT="<voutの内容>"
ADDRESS="<addressの内容>"
```

```bash
TXID="a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff"
VOUT="0"
ADDRESS="tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y"
```

このアドレスは，UTXOを所有しているアドレスです．

### 6+1 個のoutputを持つトランザクションを作成する

* input として使用するUTXOの txid と vout
* output は、生成した5つのアドレスです
* 6つの送金先アドレスへの送金金額は，それぞれ 0.0002 とします．
* outputにはおつり用のアドレスがさらに一つ必要です．ここではUTXOの所有者にします．

#### おつりの計算

ここではトランザクション手数料は 0.00002 とします．

0.01 - (0.0002)*6 - 0.00002 =  0.00878


### トランザクションの作成

JSON形式で input と output を作成します．

実行結果は 16進数形式です．

```bash
bitcoin-core.cli createrawtransaction "[{\"txid\":\"$TXID\",\"vout\":$VOUT}]" "[{\"$USER1\":0.0002},{\"$USER2\":0.0002},{\"$USER3\":0.0002},{\"$USER4\":0.0002},{\"$USER5\":0.0002},{\"$USER6\":0.0002},{\"$ADDRESS\":0.00878}]"

=>
0200000001ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf00000000
```

作成したトランザクションの確認

```bash
{
  "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
  "hash": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
  "version": 2,
  "size": 268,
  "vsize": 268,
  "weight": 1072,
  "locktime": 0,
  "vin": [
    {
      "txid": "a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00020000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 e45018208132700164dedd48ec2aa02da6e33b67",
        "desc": "addr(tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe)#p3vgdq3y",
        "hex": "0014e45018208132700164dedd48ec2aa02da6e33b67",
        "address": "tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 1,
      "scriptPubKey": {
        "asm": "0 b9fbf4a0356203937477ec684ab3932d429b07cb",
        "desc": "addr(tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx)#twmy7fz9",
        "hex": "0014b9fbf4a0356203937477ec684ab3932d429b07cb",
        "address": "tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 2,
      "scriptPubKey": {
        "asm": "0 d65518f36391977934d620968e20d26004951b12",
        "desc": "addr(tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r)#uj4raxft",
        "hex": "0014d65518f36391977934d620968e20d26004951b12",
        "address": "tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 3,
      "scriptPubKey": {
        "asm": "0 d721c1cffb72d43de5b0751ceec298054777b129",
        "desc": "addr(tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz)#9cyy265r",
        "hex": "0014d721c1cffb72d43de5b0751ceec298054777b129",
        "address": "tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 4,
      "scriptPubKey": {
        "asm": "0 d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "desc": "addr(tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n)#s2t6ysk2",
        "hex": "0014d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "address": "tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 5,
      "scriptPubKey": {
        "asm": "0 6224919b7470a13c87b979ad659736d8cdcf8fcb",
        "desc": "addr(tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek)#slfte7jy",
        "hex": "00146224919b7470a13c87b979ad659736d8cdcf8fcb",
        "address": "tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00878000,
      "n": 6,
      "scriptPubKey": {
        "asm": "0 4fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "desc": "addr(tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y)#ukrvlu5l",
        "hex": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}
```

### 作成したトランザクションに署名する

```bash
bitcoin-core.cli  signrawtransactionwithwallet 0200000001ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf00000000

=>
{
  "hex": "02000000000101ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf0247304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a0121031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b3300000000",
  "complete": true
}

```

署名したトランザクションの内容の確認（hex の値をコピー・ペーストする）

★ txinwitness 領域が作成されていることを確認する

```bash
bitcoin-core.cli  decoderawtransaction 02000000000101ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf0247304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a0121031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b3300000000

=>
{
  "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
  "hash": "b4254314aa0cff6758ed2d5987d6950fe24d9d290ce7f73fbfb0b38b7a3a7138",
  "version": 2,
  "size": 377,
  "vsize": 296,
  "weight": 1181,
  "locktime": 0,
  "vin": [
    {
      "txid": "a3506132989a1c6e2aad5ba6e7ce173775ff457c6dbd54369fad982065c1cdff",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a01",
        "031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00020000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 e45018208132700164dedd48ec2aa02da6e33b67",
        "desc": "addr(tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe)#p3vgdq3y",
        "hex": "0014e45018208132700164dedd48ec2aa02da6e33b67",
        "address": "tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 1,
      "scriptPubKey": {
        "asm": "0 b9fbf4a0356203937477ec684ab3932d429b07cb",
        "desc": "addr(tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx)#twmy7fz9",
        "hex": "0014b9fbf4a0356203937477ec684ab3932d429b07cb",
        "address": "tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 2,
      "scriptPubKey": {
        "asm": "0 d65518f36391977934d620968e20d26004951b12",
        "desc": "addr(tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r)#uj4raxft",
        "hex": "0014d65518f36391977934d620968e20d26004951b12",
        "address": "tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 3,
      "scriptPubKey": {
        "asm": "0 d721c1cffb72d43de5b0751ceec298054777b129",
        "desc": "addr(tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz)#9cyy265r",
        "hex": "0014d721c1cffb72d43de5b0751ceec298054777b129",
        "address": "tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 4,
      "scriptPubKey": {
        "asm": "0 d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "desc": "addr(tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n)#s2t6ysk2",
        "hex": "0014d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
        "address": "tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00020000,
      "n": 5,
      "scriptPubKey": {
        "asm": "0 6224919b7470a13c87b979ad659736d8cdcf8fcb",
        "desc": "addr(tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek)#slfte7jy",
        "hex": "00146224919b7470a13c87b979ad659736d8cdcf8fcb",
        "address": "tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek",
        "type": "witness_v0_keyhash"
      }
    },
    {
      "value": 0.00878000,
      "n": 6,
      "scriptPubKey": {
        "asm": "0 4fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "desc": "addr(tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y)#ukrvlu5l",
        "hex": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
        "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}

```

### 署名したトランザクションをブロードキャストする

返り値のトランザクションIDをメモする

```bash
bitcoin-core.cli   sendrawtransaction 02000000000101ffcdc1652098ad9f3654bd6d7c45ff753717cee7a65bad2a6e1c9a98326150a30000000000fdffffff07204e000000000000160014e45018208132700164dedd48ec2aa02da6e33b67204e000000000000160014b9fbf4a0356203937477ec684ab3932d429b07cb204e000000000000160014d65518f36391977934d620968e20d26004951b12204e000000000000160014d721c1cffb72d43de5b0751ceec298054777b129204e000000000000160014d3cd3adb6fc3c6473f4f37fded924649d01e3f18204e0000000000001600146224919b7470a13c87b979ad659736d8cdcf8fcbb0650d00000000001600144fc4382f40f05b4da60eff2e3e30eb70261dd4bf0247304402206cc0bf729c34bf4d89d9a1ed577f6b471c0feae3c34eaba4e5f9484fa9325e14022045cde35b3627beac8ab51b67cdcc18d8bc3bc230791e31a9f37e7d9b6373e07a0121031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b3300000000

=>
5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
```

### トランザクションを確認する

```bash
bitcoin-core.cli gettransaction 5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
```

### 10分以上経過後，UTXOのリストを確認する

UTXOが 7 に増えていることを確認します．

```bash
bitcoin-core.cli listunspent

=>
[
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 0,
    "address": "tb1qu3gpsgypxfcqzex7m4ywc24q9knwxwm8lnsxpe",
    "label": "user1",
    "scriptPubKey": "0014e45018208132700164dedd48ec2aa02da6e33b67",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/11]039631ab36ba50c053d8de05574ee58cfd7aa641922787c1c2a326225f1fbeea47)#q25z3jjf",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 1,
    "address": "tb1qh8alfgp4vgpexarha35y4vun94pfkp7tv3w9yx",
    "label": "user2",
    "scriptPubKey": "0014b9fbf4a0356203937477ec684ab3932d429b07cb",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/12]0210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f90266436)#c9fzm06u",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 2,
    "address": "tb1q6e233umrjxthjdxkyztgugxjvqzf2xcj0zmz4r",
    "label": "user3",
    "scriptPubKey": "0014d65518f36391977934d620968e20d26004951b12",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/13]035239383d7c6bd47b272c373ef02cf9b3943fc08bd218fd1522429da3c008fe88)#lwxunh7a",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 3,
    "address": "tb1q6usurnlmwt2rmedsw5wwas5cq4rh0vffcvfqjz",
    "label": "user4",
    "scriptPubKey": "0014d721c1cffb72d43de5b0751ceec298054777b129",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/14]0342fc43d4b46b3498b75dd5fa5bfedef1c090414cacb56c8551fe52f24e296d21)#l8n8axry",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 4,
    "address": "tb1q60xn4km0c0ryw060xl77myjxf8gpu0ccxm8q7n",
    "label": "user5",
    "scriptPubKey": "0014d3cd3adb6fc3c6473f4f37fded924649d01e3f18",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/15]03c900a0f1c139eeb3e0fb30a83fd649c7d2de9fe0598641dfac080c4b0026bcd0)#emen64rw",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 5,
    "address": "tb1qvgjfrxm5wzsnepae0xkkt9ekmrxulr7t530xek",
    "label": "user6",
    "scriptPubKey": "00146224919b7470a13c87b979ad659736d8cdcf8fcb",
    "amount": 0.00020000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/16]0275451ad763853e8a3f0dbc608cc354282b6a0da0eb02a0508b50b11812636bd7)#d6965ayc",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  },
  {
    "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
    "vout": 6,
    "address": "tb1qflzrst6q7pd5mfswluhruv8twqnpm49lqrhs9y",
    "label": "",
    "scriptPubKey": "00144fc4382f40f05b4da60eff2e3e30eb70261dd4bf",
    "amount": 0.00878000,
    "confirmations": 8,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([937090de/84h/1h/0h/0/0]031180c3c30b662433e49e7a81049361dbbfff662cef4256fbcbee403875f43b33)#9wux8ep7",
    "parent_descs": [
      "wpkh(tpubD6NzVbkrYhZ4YbFapq62MDLBVude54h2m2seJRgt5oKqRSX52nft4uGXQrQ34XVZfZc877UTb5EzLVPJ7MYh8YB4vYXwho56sDwc5jCKhs4/84h/1h/0h/0/*)#2jvtrjwl"
    ],
    "safe": true
  }
]
```

### UTXO のメモとシェル変数への代入


作成した7つのUTXOは，それぞれ順にP2PK,　P2PKH，P2SH，P2WPKH，P2WSHの作成実験のために使います。

この後，7個のUTXOからそれぞれ P2PK, P2PKH, P2SH, P2WPKH, P2WSH, P2TR の6つのタイプのoutputを持つ6個のトランザクションを作成し，それぞれ署名して，ブロードキャストします．

UTXO のトランザクションID： 5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f
  vout:0 ~ 6

```
UTXO_TXID="<UTXO の txid>"
```

```bash
UTXO_TXID="5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f"
UTXO_VOUT0=0
UTXO_VOUT1=1
UTXO_VOUT2=2
UTXO_VOUT3=3
UTXO_VOUT4=4
UTXO_VOUT5=5
```

## <a id="ADDR"> </a>6種類のビットコインアドレスの生成

6種類の outputのタイプへの送金には、それぞれ対応するアドレスタイプを持つ送金先アドレスが必要です。

以下に P2PK, P2PKH, P2SH, P2WPKH, P2WSH, P2TR の6タイプのアドレスを生成します．

#### getnewaddress コマンド

```bash
getnewaddress <ラベル> <アドレスタイプ>
```

アドレスタイプ

* legacy (base52アドレス）このタイプにさらに P2PKHとP2SHがあります
* bech32 (Bech32アドレス）このタイプにさらにP2WPKHとP2WSHがありあす
* p2sh-segwit (後方互換のため，Bech32アドレスをP2SHでラップしたアドレス)
* P2PK では、送金先の公開鍵がそのまま送金先アドレスになります

### P2PKアドレス

最も初期のアドレス形式です．

特別なアドレスフォーマットはなく，当事者の公開鍵がそのままアドレスになります

#### 公開鍵の確認方法

コマンドの文法

```
getaddressinfo <（自分のワレットの）ビットコインアドレス>
```


ここでは，P2WPKH として生成されたアドレスの情報から公開鍵を抜き出します．

```bash
bitcoin-core.cli getnewaddress

=>
tb1qm560qy283ve0l6qwft4wp4yl3djdvyr54fgkx4

 bitcoin-core.cli getaddressinfo tb1qm560qy283ve0l6qwft4wp4yl3djdvyr54fgkx4
{
  "address": "tb1qm560qy283ve0l6qwft4wp4yl3djdvyr54fgkx4",
  "scriptPubKey": "0014dd34f011478b32ffe80e4aeae0d49f8b64d61074",
  "ismine": true,
  "solvable": true,
  "desc": "wpkh([937090de/84h/1h/0h/0/18]0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412)#7pvgkuyk",
  "parent_desc": "wpkh([937090de/84h/1h/0h]tpubDDSN9k3SmhuaiYh4reF2W1zEsi52Yi1KSyEzLqvBQD61FjJdy9prhR9UDEjSQ8P5Q7kuS8nD8E6Q9b989JPcMcfStFeqoixDUyZ7CVMgyZK/0/*)#6f8zvwrv",
  "iswatchonly": false,
  "isscript": false,
  "iswitness": true,
  "witness_version": 0,
  "witness_program": "dd34f011478b32ffe80e4aeae0d49f8b64d61074",
  "pubkey": "0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412",
  "ischange": false,
  "timestamp": 1716561807,
  "hdkeypath": "m/84h/1h/0h/0/18",
  "hdseedid": "0000000000000000000000000000000000000000",
  "hdmasterfingerprint": "937090de",
  "labels": [
    ""
  ]
}
```

公開鍵は  pubkey の部分です．

この公開鍵の情報を P2PK アドレスとしてシェル変数 P2PK_ADDR に代入しておきます

```bash
P2PK_ADDR="0221bb85f3e3d34a7a719dbb4627f8efa3c991aad3a37786c2663e7def2ceff412"
```

### P2PKHアドレス

当事者の公開鍵のハッシュ値から生成され base52 エンコードしたアドレスです

シェル変数 P2PKH_ADDRに代入しておきます．

```bash
P2PKH_ADDR=`bitcoin-core.cli getnewaddress user_p2pkh legacy`

echo $P2PKH_ADDR

=>
mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J
```

### P2SHアドレス

当事者の公開鍵ではなく，bitcoin スクリプトのハッシュ値から生成されたアドレスです．

その典型例がマルチシグ（多重署名）用アドレスです。

 #### マルチシグ用公開鍵のリストの作成
 
アドレスの生成には、n人の署名者たちの公開鍵が必要です。

ここでは P2PK と同様の方法で３人の公開鍵を生成し，シェル変数 PUBKEY1, PUBKEY2, PUBKEY3 に代入します．

```bash
bitcoin-core.cli getnewaddress

=>
tb1qpw85yzdg9tmq0h9ajymcs0z2c54tt5th2v9j4z

bitcoin-core.cli getnewaddress

=>
tb1qu7q2xlq39gr5akaawnakfws9t3zea9essr52gu

bitcoin-core.cli getnewaddress

=>
tb1q5erj2fq8n4ykncha6tjxny88wg7vlh7dkznm7x

bitcoin-core.cli getaddressinfo tb1qpw85yzdg9tmq0h9ajymcs0z2c54tt5th2v9j4z
bitcoin-core.cli getaddressinfo tb1qu7q2xlq39gr5akaawnakfws9t3zea9essr52gu
bitcoin-core.cli getaddressinfo tb1q5erj2fq8n4ykncha6tjxny88wg7vlh7dkznm7x

PUBKEY1="037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0"
PUBKEY2="0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84"
PUBKEY3="0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094"
```

#### マルチシグアドレスの生成

 m of n マルチシグ（n人の公開鍵の中でm人の署名があれば成功する署名）のためのアドレス生成です。
 
コマンドの文法

```
createmultisig <必要署名数 m> '[<公開鍵1>,<公開鍵2>,...,<公開鍵n>]' <アドレスタイプ>
```

 <アドレスタイプ> の指定によって　P2SH　と　P2WSH　が区別されます。

アドレスタイプ:  P2SH＝"legacy", P2SHのSegWitラップ="p2sh-segwit", P2WSH="bech32"

マルチシグアドレス生成結果

```json
{                            (json object)
  "address" : "str",         (string) The value of the new multisig address.
  "redeemScript" : "hex",    (string) The string value of the hex-encoded redemption script.
  "descriptor" : "str"       (string) The descriptor for this multisig
}
```

2 of 3 の場合

```bash
bitcoin-core.cli createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" legacy

=>
{
  "address": "2N9kJJFdQvdD1gYAuirNVNFvsZcFcKtULCS",
  "redeemScript": "5221037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0210210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84210359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c409453ae",
  "descriptor": "sh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#c968pfza"
}
```

ここでは，シェル変数 P2SH_ADDRに生成したアドレスを代入しておきます

```bash
P2SH_ADDR="2N9kJJFdQvdD1gYAuirNVNFvsZcFcKtULCS"
```

#### P2SH redeemScript

P2SHのアウトプットをアンロックするには、redeemScriptが必要です

上記のマルチシグアドレス生成時に対応する redeemscriptも生成されています．

シェル変数 P2SH_REDEEMSCRIPT にその内容を代入しておきます

```bash
P2SH_REDEEMSCRIPT="5221037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0210210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84210359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c409453ae"
```

#### P2SH descriptor

* P2SH でロックされているUTXOをアンロックするためには，まず第１段階として redeemscript とそのハッシュ値が必要です．

* 第２段階で，マルチシグの実際の署名を行う場所は署名者それぞれのワレットで， redeemScript に沿ってそれぞれの秘密鍵を使って署名を行います。

* それを可能にするためには、それぞれの署名者のワレットに redeemScript などの必要な情報を組み込む必要があります。

* descriptor　は、ワレットにマルチシグ署名のための情報を組み込むためのデータです。

ここでは，シェル変数 P2SH_DESCRIPTOR にその内容を代入しておきます．

```bash
P2SH_DESCRIPTOR="sh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#c968pfza"
```

##### マルチシグアドレス生成の実際と公開鍵の提示

ここでの例では、複数のアドレスを一つのワレットで生成していますが、実際は複数の人のワレットで生成します。

上記のように、マルチシグアドレスの生成には公開鍵が必要です。

しかし、アドレスごとの公開鍵は非公開情報です。したがって、実際にマルチシグに参加する当事者がそれぞれ自分で自分の公開鍵を確認し、信頼できる第三者であるマルチシグアドレス生成者に提示する必要があります。


### P2WPKHアドレス P2WPKH_ADDR にアドレスを代入しておきます．

Bech32アドレスの生成（受領者の公開鍵ハッシュの場合）

ここでは，シェル変数

```bash
P2WPKH_ADDR=`bitcoin-core.cli getnewaddress bech32`

echo $P2WPKH_ADDR

=>
tb1qjf9kvs5k698luqwhkl9jqtdujwnwrx0250mnda
```

### P2WSHアドレス

基本的にP2SHと同じです。


2 of 3 の場合

```bash
bitcoin-core.cli createmultisig 2 "[\"$PUBKEY1\",\"$PUBKEY2\",\"$PUBKEY3\"]" bech32

=>
{
  "address": "tb1q5w03kkrvsr2nvgn6gqfgjqht3x6gghjstt3g7ez0cuvahnpe500svcyx4c",
  "redeemScript": "5221037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0210210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84210359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c409453ae",
  "descriptor": "wsh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#04tn9tty"
}
```

ここではシェル変数 P2WSH_ADDR に内容を代入しておきます

```bash
P2WSH_ADDR="tb1q5w03kkrvsr2nvgn6gqfgjqht3x6gghjstt3g7ez0cuvahnpe500svcyx4c"
```


#### P2WSH redeemScript

ここではシェル変数 P2WSH_REDEEMSCRIPT にその内容を代入しておきます

```bash
P2WSH_REDEEMSCRIPT="5221037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0210210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84210359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c409453ae"
```

#### P2SH descriptor

ここでは，シェル変数 P2WSH_DESCRIPTOR にその内容を代入しておきます．

```bash
P2WSH_DESCRIPTOR="wsh(multi(2,037032106297741808e66c947dab836f3f3c28189596331e48861304674e2583d0,0210c7796ac91075ff6d4708319094707a976d265263cac42cc535104803439f84,0359ee82a3b3ec86bc8c29c149cacde7af2e00cd8952ee5767d6c221a2807c4094))#04tn9tty"
```


## <a id="TX3"> </a> TX3: P2PKH トランザクションの作成

* txid: UTXO_TXID
* vout: 1
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018


送金先アドレスを legacy なP2PKH アドレスにすればよい

```bash
echo $P2PKH_ADDR

=>
mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J
```

### input(UTXO)　のJSON形式の例

```bash
echo "[{\"txid\":\"$UTXO_TXID\",\"vout\":1}]"

=>
[{"txid":"5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f","vout":1}]
```

### output のJSON形式の例

```bash
echo "[{\"$P2PKH_ADDR\": 0.00018}]"

=>
[{"mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J": 0.00018}]
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction  "[{\"txid\":\"$UTXO_TXID\",\"vout\":1}]" "[{\"$P2PKH_ADDR\": 0.00018}]"

=>
02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac00000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
 bitcoin-core.cli signrawtransactionwithwallet 02000000010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac00000000

=>
{
  "hex": "020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac0247304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201210210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f9026643600000000",
  "complete": true
}
```

### 作成したトランザクションの確認

voutのタイプを確認してください

```bash
bitcoin-core.cli decoderawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac0247304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201210210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f9026643600000000

=>
{
  "txid": "f66f7c67f0e2edab7d27d316662c31a9a5f33fe68dd9725854fe04bb7f23563f",
  "hash": "71b473bae78c2a006cb9825a72d53775ff2c3792c973a5fb7ef7f6b6db1f1512",
  "version": 2,
  "size": 194,
  "vsize": 113,
  "weight": 449,
  "locktime": 0,
  "vin": [
    {
      "txid": "5ec355265c0dcddb3e71a1888d5b511e6afb26da9f225fca1551915576fd460f",
      "vout": 1,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201",
        "0210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f90266436"
      ],
      "sequence": 4294967293
    }
  ],
  "vout": [
    {
      "value": 0.00018000,
      "n": 0,
      "scriptPubKey": {
        "asm": "OP_DUP OP_HASH160 d0c58609bfeafe97668feab8f356eccc78346c05 OP_EQUALVERIFY OP_CHECKSIG",
        "desc": "addr(mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J)#x69lw56d",
        "hex": "76a914d0c58609bfeafe97668feab8f356eccc78346c0588ac",
        "address": "mzYqU8jSicpwstG9rA7jBrjgLVkzDPjo8J",
        "type": "pubkeyhash"
      }
    }
  ]
}
```

### P2PKHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001010f46fd7655915115ca5f229fda26fb6a1e515b8d88a1713edbcd0d5c2655c35e0100000000fdffffff0150460000000000001976a914d0c58609bfeafe97668feab8f356eccc78346c0588ac0247304402200eb66481942990514029ee4ed38ed9509bbf3eb71025957fa4ec18439d18e7820220775570382c5e47153c0a02f060b338e5729425a8942eee85d01ca36df7ba2c6201210210e44d1d3a06d365b1e641688584be544824d7fad4d79830117c532f9026643600000000

=>
6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2
```

--
## <a id="TX4"> </a> TX4: P2SH トランザクションの作成

* txid: UTXO_TXID
* vout: 2
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018

--
input に使用するUTXOは

* txid: 236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833
* vout: 2
* 送金金額は、0.00018


送金先アドレスを先に生成済の P2SH アドレスにすればよい

```bash
{
  "address": "2NAJZRpUeBUycwZHrcDRKsyufsUx25Djgw2",
  "redeemScript": "52210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae",
  "descriptor": "sh(multi(2,0237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d4,03ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645,0345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b))#valuvj2y"
}
```

### input(UTXO)　のJSON形式の例

```bash
'[{"txid":"236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833","vout":2}]' 
```

### output のJSON形式の例

```bash
'[{"2NAJZRpUeBUycwZHrcDRKsyufsUx25Djgw2":0.00018}]'
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction  '[{"txid":"236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833","vout":2}]'  '[{"2NAJZRpUeBUycwZHrcDRKsyufsUx25Djgw2":0.00018}]'
=>
020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230200000000ffffffff01504600000000000017a914bb1b9d3762f5964beb822227eca7896c834b77758700000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230200000000ffffffff01504600000000000017a914bb1b9d3762f5964beb822227eca7896c834b77758700000000
=>
{
  "hex": "0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230200000000ffffffff01504600000000000017a914bb1b9d3762f5964beb822227eca7896c834b7775870247304402200f48380f49d4c64218ffe3aa6527121717f2103ff7acc639dd1da4ddbbb5b2cf02205ab3597af25f71399bd1663e73c5ebd1815405eb9ef2d7345bd137bba4f6b1fa012103eb40f709e1c7983646cf8a9f593489936fe97e29f970a3d19d3b09df81b7e9a300000000",
  "complete": true
}
```

### P2SHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230200000000ffffffff01504600000000000017a914bb1b9d3762f5964beb822227eca7896c834b7775870247304402200f48380f49d4c64218ffe3aa6527121717f2103ff7acc639dd1da4ddbbb5b2cf02205ab3597af25f71399bd1663e73c5ebd1815405eb9ef2d7345bd137bba4f6b1fa012103eb40f709e1c7983646cf8a9f593489936fe97e29f970a3d19d3b09df81b7e9a300000000

=>
a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41
```

--
## <a id="TX5"> </a> TX5: P2WPKH トランザクションの作成

* txid: UTXO_TXID
* vout: 3
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018


送金先アドレスを　P2WPKH アドレスにすればよい

```bash
bitcoin-core.cli getnewaddress
=>
tb1q9ejzgpj47rpt6j86c2epvzgz654caek2ga36tn
```

* txid: 236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833
* vout: 3
* 送金金額は、0.00018

### input(UTXO)　のJSON形式の例

```bash
'[{"txid":"236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833","vout":3}]' 
```

### output のJSON形式の例

```bash
'[{"tb1q9ejzgpj47rpt6j86c2epvzgz654caek2ga36tn": 0.00018}]'
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction  '[{"txid":"236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833","vout":3}]' '[{"tb1q9ejzgpj47rpt6j86c2epvzgz654caek2ga36tn": 0.00018}]'
=>
020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230300000000ffffffff0150460000000000001600142e64240655f0c2bd48fac2b2160902d52b8ee6ca00000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230300000000ffffffff0150460000000000001600142e64240655f0c2bd48fac2b2160902d52b8ee6ca00000000
=>
{
  "hex": "0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230300000000ffffffff0150460000000000001600142e64240655f0c2bd48fac2b2160902d52b8ee6ca02473044022058120e37fddacdfeccce7e86a60fc624c6c6d519198d9f5e8ce569306ed466cb02207fdb57de7e725fce3dec3eb1175771fda83a002e93793475687729987e32724001210318c2a2929e4be5885c05c4819618a637b4546e8010aea3200922fe2eed71b0ca00000000",
  "complete": true
}
```
### P2WPKHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230300000000ffffffff0150460000000000001600142e64240655f0c2bd48fac2b2160902d52b8ee6ca02473044022058120e37fddacdfeccce7e86a60fc624c6c6d519198d9f5e8ce569306ed466cb02207fdb57de7e725fce3dec3eb1175771fda83a002e93793475687729987e32724001210318c2a2929e4be5885c05c4819618a637b4546e8010aea3200922fe2eed71b0ca00000000
=>
aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a
```

## <a id="TX6"> </a> TX6: P2WSH トランザクションの作成

* txid: UTXO_TXID
* vout: 4
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018


送金先アドレスを P2WSH アドレスにすればよい

```
{
  "address": "tb1qengwkeelq2wt3hras63jy03kgpdrxag22sx0ymzugqqnu83hcqsqk3wekc",
  "redeemScript": "52210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae",
  "descriptor": "wsh(multi(2,0380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a65,03efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b,0290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b))#ezclpasq"
}
```

使用するUTXO

* txid: 236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833
* vout: 4
* 送金金額は、0.00018

### input(UTXO)　のJSON形式の例

```
'[{"txid":"236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833","vout":4}]' 
```

### output のJSON形式の例

```
'[{"tb1qengwkeelq2wt3hras63jy03kgpdrxag22sx0ymzugqqnu83hcqsqk3wekc": 0.00018}]'
```

### 未署名トランザクションの作成

```bash
bitcoin-core.cli createrawtransaction  '[{"txid":"236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833","vout":4}]' '[{"tb1qengwkeelq2wt3hras63jy03kgpdrxag22sx0ymzugqqnu83hcqsqk3wekc": 0.00018}]'

=>
020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230400000000ffffffff015046000000000000220020ccd0eb673f029cb8dc7d86a3223e36405a33750a540cf26c5c40013e1e37c02000000000
```

### トランザクションへのデジタル署名（ワレットの秘密鍵を利用）

```bash
bitcoin-core.cli signrawtransactionwithwallet 020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230400000000ffffffff015046000000000000220020ccd0eb673f029cb8dc7d86a3223e36405a33750a540cf26c5c40013e1e37c02000000000
=>
{
  "hex": "0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230400000000ffffffff015046000000000000220020ccd0eb673f029cb8dc7d86a3223e36405a33750a540cf26c5c40013e1e37c02002473044022001beee68e94fb8dfe56a8a31c0668b4b1a29eb0f338b842ed67a65cb58e6930902205736678e57d9dd61759b246c3920d49236e563f007fc288126e56eba0aeb5bee012103c012a70b37fe9f1f5e11e402f9b7fc81cdbf4d6d7b48bdc1608bd8607d78c8cd00000000",
  "complete": true
}
```

### P2WSHトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230400000000ffffffff015046000000000000220020ccd0eb673f029cb8dc7d86a3223e36405a33750a540cf26c5c40013e1e37c02002473044022001beee68e94fb8dfe56a8a31c0668b4b1a29eb0f338b842ed67a65cb58e6930902205736678e57d9dd61759b246c3920d49236e563f007fc288126e56eba0aeb5bee012103c012a70b37fe9f1f5e11e402f9b7fc81cdbf4d6d7b48bdc1608bd8607d78c8cd00000000
=>
89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e
```

## <a id="TX7"> </a> TX7: P2TR トランザクションの作成

* txid: UTXO_TXID
* vout: 5
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018




## <a id="TX2"> </a> TX2: P2PK トランザクションの作成
* txid: UTXO_TXID
* vout: 0
* UTXO資金： 0.0002
* fee: 0.00002 
* 送金金額 : 0.00018

bitcoin core のAPIでは　P2PKのトランザクション作成機能は削除されているので，自分でトランザクションの内容を仕様にそって自作する必要があります。

* input が参照するUTXOのTXIDはリトルエンディアン
* ScriptPubkeyの最後の１バイトは， OP_CHECKSIG (コードは16進数で "ac")
* valueの値は送金金額の単位が 1億分の1 BTC = 1 satoshi
* valueの値は 8バイトのリトルエンディアンであることに注意が必要です。

input に使用するUTXOは

* txid: 236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833
* vout: 0
* 送金金額は、0.00016


### リトルエンディアン変換

Rubyのビッグエンディアンからリトルエンディアンへの変換プログラム

```ruby
# ビッグエンディアンのデータ
be ="00000000001de840"
# リトルエンディアンへの変換
le=[be].pack('H*').reverse.unpack('H*')[0]
# 変換結果
"40e81d0000000000"
```

* outputのvalue: 0.00016 BTC
* 0.00016 btc=16000 satoshi 

```ruby
# 16000 は、8バイトの16進数では，0000000000003e80
# 8バイトのリトルエンディアン表現にすると
be="0000000000003e80"
le=[be].pack('H*').reverse.unpack('H*')[0]
# 変換結果
"803e000000000000"
```

* トランザクション

| フィールド    | 内容       |
|:-------- |:-------- |
| version  | 02000000 |
| inputの数  | 01       |
| input    |          |
| outputの数 | 01       |
| output   |          |
| nLocTime | 00000000 |

トランザクションデータの連結結果

```
02000000
01<input>
01<output>
00000000
```

### input (UTXO)

* 236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833
* "33d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df6696823"(リトルエンディアン)
* vout:0

| フィールド        | 内容                                                               |
|:------------ |:---------------------------------------------------------------- |
| トランザクションID   | 33d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df6696823 |
| txout index  | 0000000000                                                       |
| ScriptSigサイズ | 空                                                                |
| ScriptSig    | 空                                                                |
| nSequence    | ffffffff                                                         |

inputデータの連結結果

```
33d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff
```

### output 

```
bitcoin-core.cli getnewaddress
=>
tb1qyfdlldk7pf2t0gqnmu3nzrh6yfz5l6y9ewcmyz

bitcoin-core.cli getaddressinfo tb1qyfdlldk7pf2t0gqnmu3nzrh6yfz5l6y9ewcmyz |grep pubkey
=>
  "pubkey": "0286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225",
```

| フィールド              | 内容                                                                 |
|:------------------ |:------------------------------------------------------------------ |
| value              | 803e000000000000                                                   |
| scriputPubKeyのバイト数 | 23                                                                 |
| scriputPubKey      | 21(公開鍵サイズ33バイトの16進数表記）                                                  |
| 送金先公開鍵             | 0286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225 |
| OP_CHECKSIG        | ac                                                                 |

### outputデータの連結結果

```
803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac
```

### P2PKトランザクションの作成

```
02000000
01
33d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff
01
803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac
00000000
```

### 作成したトランザクションの構造の確認

```bash
bitcoin-core.cli decoderawtransaction 020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff01803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac00000000
=>
{
  "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
  "hash": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
  "version": 2,
  "size": 95,
  "vsize": 95,
  "weight": 380,
  "locktime": 0,
  "vin": [
    {
      "txid": "236869f63d84cca47ae697f5b69f5b4b297da2535aa58cda6d7ff9dd7b47d833",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00016000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225 OP_CHECKSIG",
        "desc": "pk(0286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225)#zw9cajag",
        "hex": "210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac",
        "type": "pubkey"
      }
    }
  ]
}
```

### 作成したトランザクションへの署名

```bash
bitcoin-core.cli signrawtransactionwithwallet 020000000133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff01803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac00000000
=>
{
  "hex": "0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff01803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac024730440220163aca210506175bd5f4e792a49aeb5fe1965cbefb6bc8a55a782554878d2d340220016dfc3a249ff6e7302eceb34102834e1c07c14300556a3fb7872a3abd1cd5f70121026d01d308b663a223ef89101829c02166cdc6df56a856ebdf2cb235132b19d46900000000",
  "complete": true
}
```

### P2PKトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 0200000000010133d8477bddf97f6dda8ca55a53a27d294b5b9fb6f597e67aa4cc843df66968230000000000ffffffff01803e00000000000023210286cccece9b23c2079a9fac439efdccf5cbb04154817617ff4a4fd4668db8b225ac024730440220163aca210506175bd5f4e792a49aeb5fe1965cbefb6bc8a55a782554878d2d340220016dfc3a249ff6e7302eceb34102834e1c07c14300556a3fb7872a3abd1cd5f70121026d01d308b663a223ef89101829c02166cdc6df56a856ebdf2cb235132b19d46900000000
=>
08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c
```


## <a id="TX8"> </a> TX8: 6種類の UTXO を inputとするトランザクションの作成

### UTXOの確認

この時点で　bitcoin core のワレット機能でUTXOとして確認可能なものは　P2PK, P2PKH, P2WPKH のoutputだけです。

P2SHとP2WSHのUTXOは，ワレットには認識されません。

```bash
bitcoin-core.cli listunspent
=>
[
  {
    "txid": "aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a",
    "vout": 0,
    "address": "tb1q9ejzgpj47rpt6j86c2epvzgz654caek2ga36tn",
    "label": "",
    "scriptPubKey": "00142e64240655f0c2bd48fac2b2160902d52b8ee6ca",
    "amount": 0.00018000,
    "confirmations": 4,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([b6437264/0'/0'/98']031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b)#jvqdyz33",
    "safe": true
  },

  {
    "txid": "6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2",
    "vout": 0,
    "address": "mmZSyUyxaZJJNXCviNmUcg2jJ5KfSUJMZt",
    "label": "user3",
    "scriptPubKey": "76a914424986ff15df8a17a04f2b07520f0ef1dc9b742288ac",
    "amount": 0.00018000,
    "confirmations": 12,
    "spendable": true,
    "solvable": true,
    "desc": "pkh([b6437264/0'/0'/97']0222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701)#24jv8ctw",
    "safe": true
  },
  {
    "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
    "vout": 0,
    "address": "mgX9TGp5SxT6jczaKhf6fVDUdfsg1m45wf",
    "scriptPubKey": "21027544b898d2d886a7ee733f2cf3da01bfd5d2350fedf602f4d1b78412b5f4d851ac",
    "amount": 0.00016000,
    "confirmations": 1,
    "spendable": true,
    "solvable": true,
    "desc": "pk([60d80dee/0'/0'/35']027544b898d2d886a7ee733f2cf3da01bfd5d2350fedf602f4d1b78412b5f4d851)#24lz4ah2",
    "safe": true
  }
]
```

### bitcoin core のワレットにマルチシグ情報を登録する

P2SHとP2WSHのマルチシグアドレス生成時に生成された descriptorを利用する

* P2SHのdescriptor

```
"sh(multi(2,0237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d4,03ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645,0345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b))#valuvj2y"
```

* P2WSHのdescriptor

```
"wsh(multi(2,0380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a65,03efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b,0290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b))#ezclpasq"
```

一般的には，マルチシグは複数の主体のワレットで署名しなければなりません。
この例では，単純化のために署名に必要なすべての秘密鍵が一つのワレットに入っています。

```
importmulti <JSON形式のインポート情報(descriptor)> 
```

```bash
 bitcoin-core.cli importmulti '[{"desc": "sh(multi(2,0237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d4,03ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645,0345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b))#valuvj2y", "timestamp": "now", "watchonly": true}]'
=>
 [
  {
    "success": true
  }
]
```

```bash
bitcoin-core.cli importmulti '[{"desc": "wsh(multi(2,0380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a65,03efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b,0290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b))#ezclpasq","timestamp": "now", "watchonly": true}]'

[
  {
    "success": true
  }
]
```

### これでワレットがP2SH, P2WSH を含めたすべてのUTXOを確認できるようになる

```bash
bitcoin-core.cli listunspent
=>
[
  {
    "txid": "aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a",
    "vout": 0,
    "address": "tb1q9ejzgpj47rpt6j86c2epvzgz654caek2ga36tn",
    "label": "",
    "scriptPubKey": "00142e64240655f0c2bd48fac2b2160902d52b8ee6ca",
    "amount": 0.00018000,
    "confirmations": 4,
    "spendable": true,
    "solvable": true,
    "desc": "wpkh([b6437264/0'/0'/98']031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b)#jvqdyz33",
    "safe": true
  },

  {
    "txid": "6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2",
    "vout": 0,
    "address": "mmZSyUyxaZJJNXCviNmUcg2jJ5KfSUJMZt",
    "label": "user3",
    "scriptPubKey": "76a914424986ff15df8a17a04f2b07520f0ef1dc9b742288ac",
    "amount": 0.00018000,
    "confirmations": 12,
    "spendable": true,
    "solvable": true,
    "desc": "pkh([b6437264/0'/0'/97']0222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701)#24jv8ctw",
    "safe": true
  },
  {
    "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
    "vout": 0,
    "address": "mgX9TGp5SxT6jczaKhf6fVDUdfsg1m45wf",
    "scriptPubKey": "21027544b898d2d886a7ee733f2cf3da01bfd5d2350fedf602f4d1b78412b5f4d851ac",
    "amount": 0.00016000,
    "confirmations": 1,
    "spendable": true,
    "solvable": true,
    "desc": "pk([60d80dee/0'/0'/35']027544b898d2d886a7ee733f2cf3da01bfd5d2350fedf602f4d1b78412b5f4d851)#24lz4ah2",
    "safe": true
  },
  {
    "txid": "89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e",
    "vout": 0,
    "address": "tb1qengwkeelq2wt3hras63jy03kgpdrxag22sx0ymzugqqnu83hcqsqk3wekc",
    "label": "",
    "witnessScript": "52210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae",
    "scriptPubKey": "0020ccd0eb673f029cb8dc7d86a3223e36405a33750a540cf26c5c40013e1e37c020",
    "amount": 0.00018000,
    "confirmations": 3,
    "spendable": false,
    "solvable": true,
    "desc": "wsh(multi(2,[82c79c5c]0380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a65,[3e282d87]03efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b,[b949ba0d]0290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b))#4cr4ee97",
    "safe": true
  },
    {
    "txid": "a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41",
    "vout": 0,
    "address": "2NAJZRpUeBUycwZHrcDRKsyufsUx25Djgw2",
    "label": "",
    "redeemScript": "52210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae",
    "scriptPubKey": "a914bb1b9d3762f5964beb822227eca7896c834b777587",
    "amount": 0.00018000,
    "confirmations": 4,
    "spendable": true,
    "solvable": true,
    "desc": "sh(multi(2,[6170057b]0237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d4,[f5d793b3]03ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645,[a332ac29]0345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b))#yqy68cgc",
    "safe": true
  }
]
```

### 送金先と金額

```bash
bitcoin-core.cli getnewaddress 
=>
tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue
```

送金金額：0.00088-0.00002=0.00086

### 6つのinputを持つ未署名のトランザクションの作成

P2PK, P2PKH, P2SH,P2WPKH,P2WSH の順で作成する

```bash
bitcoin-core.cli createrawtransaction  '[{"txid":"08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c","vout":0},{"txid":"6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2","vout":0},{"txid":"a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41","vout":0},{"txid":"aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a","vout":0},{"txid":"89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e","vout":0}]'  '[{"tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue": 0.00086}]'
=>
02000000059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c70080000000000ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a0000000000ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa00000000000ffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b00000000
```

### トランザクションへの署名

実際の運用では，マルチシグは複数の主体のワレットで順番に署名する必要があります。

```bash
bitcoin-core.cli signrawtransactionwithwallet 02000000059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c70080000000000ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a0000000000ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa00000000000ffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b00000000
=>
{
  "hex": "020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000",
  "complete": true
}
```

### 作成したトランザクションの構造

```bash
bitcoin-core.cli decoderawtransaction 020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000
=>
{
  "txid": "11f36ca7c4840c2cd24dd58d061bd30ccad3a8e0885920dd6daca9c855372756",
  "hash": "bd8acb3055541202a3de6fb53dfa5fe1d82e00b334ab7223884f9aa68c1f06f6",
  "version": 2,
  "size": 1040,
  "vsize": 767,
  "weight": 3068,
  "locktime": 0,
  "vin": [
    {
      "txid": "08701c7f0d4db0dd5da01df4ad750e6819de718abe1ea32d917241a89c88379c",
      "vout": 0,
      "scriptSig": {
        "asm": "304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd[ALL]",
        "hex": "47304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01"
      },
      "sequence": 4294967295
    },
    {
      "txid": "6ae4c0efb1ff8612f649cf673450d78a565e1b5788c678f22ae28ae8711e3ec2",
      "vout": 0,
      "scriptSig": {
        "asm": "30440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf0834[ALL] 0222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701",
        "hex": "4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701"
      },
      "sequence": 4294967295
    },
    {
      "txid": "a0faa783f92fdb8bdee3e134f92ce1a163c36a4574ff494985e54665b2a70d41",
      "vout": 0,
      "scriptSig": {
        "asm": "0 304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa[ALL] 304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f[ALL] 52210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae",
        "hex": "0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53ae"
      },
      "sequence": 4294967295
    },
    {
      "txid": "aa9d14b180f967d85f579b7d90151e5f6f5c7dbf81198d2ca0411fbcb119470a",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f01",
        "031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b"
      ],
      "sequence": 4294967295
    },
    {
      "txid": "89f1855f19cf3280aa842d1cb1e38442e98a47c475a1a340813bed5536f2ec6e",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "",
        "304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d68501",
        "30440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b468001",
        "52210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae"
      ],
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00086000,
      "n": 0,
      "scriptPubKey": {
        "asm": "0 bcbc428f81a3c209f316e03fc46751ccd294709b",
        "desc": "addr(tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue)#qxp8yjj5",
        "hex": "0014bcbc428f81a3c209f316e03fc46751ccd294709b",
        "address": "tb1qhj7y9rup50pqnuckuqluge63enffguymm7j5ue",
        "type": "witness_v0_keyhash"
      }
    }
  ]
}

```

### 署名済のトランザクションのブロードキャスト

```bash
bitcoin-core.cli sendrawtransaction 020000000001059c37889ca84172912da31ebe8a71de19680e75adf41da05dddb04d0d7f1c7008000000004847304402207af64ee819d4508afd2d87845f9b0b45bfff4d3b8b48ef6254696c6594e456f8022002754510969fc71f0d1e7dbff0fb7de5c1a3791fcaa510843b41f212238069cd01ffffffffc23e1e71e88ae22af278c688571b5e568ad7503467cf49f61286ffb1efc0e46a000000006a4730440220263aa6dbd8408800e6a02c9085ea6a444b2ab78891792eb57f49f4ade581431602207a5b3f18270f2ec0de58b07d6c274954aacb627eca381e568d937411feaf083401210222e18123552767a58da9f3749a4fd014fe991be3469d0ee01618080734ec6701ffffffff410da7b26546e5854949ff74456ac363a1e12cf934e1e3de8bdb2ff983a7faa000000000fc0047304402206e60f211d72c34c16be004e756ed490c5c79d376c479c146512c2487069781c602200473c8442b507fea1b7ee7274431698278c9893a8da1b6734ca444df7b2102aa0147304402200d844c231012bcc36a0774adf8677b948dd841838ae3ebb750ed497fc2a71314022073eace5173560c9f72bef661cbf80ea8f6594bb80bd4aa0c0d8eb96cb312cc6f014c6952210237a1e78baa7be5389c51f1836fb3b52c7163ea869281559c8ac94e69898793d42103ab2e94ae215cb3bdba9269588f32c8df33c2140a554149850e01aa18b2bea645210345e92ef8d7d03efce3878360b0fc57bb82d5d291e9e483c296f409165b80121b53aeffffffff0a4719b1bc1f41a02c8d1981bf7d5c6f5f1e15907d9b575fd867f980b1149daa0000000000ffffffff6eecf23655ed3b8140a3a175c4478ae94284e3b11c2d84aa8032cf195f85f1890000000000ffffffff01f04f010000000000160014bcbc428f81a3c209f316e03fc46751ccd294709b0000000247304402200e9082682885eacee1f8c5381aa022d709af7ce2b5d36d2392c6756cd80c28ac0220358b6b255401ffcaa0d593715b85245fbe9a525a0ebe64793a41d017e816341f0121031b6f543a2a7ddd2b1358a2b1bdbef666cb302904b53dfc2f066889e914e4bb5b040047304402206267cf7c180d2f1245955fbee57ae657cba0dc82e6a253d1b8ffbc3915af3df302203e2c1d241e8c152436d7fbc01b36beca1b98e98be990b03845c4d21a62b0d685014730440220278a80c5d9cf17b6e3486788dca63262407ab4999eb79521b92e18bb5a368ee002206139aabd54bf82e3482200e1c7c6940ef67045735198dcb6d2a99ab1828b4680016952210380204524e4cf427a5a5da5826b531bc327c869230118433c5ab503544d1c1a652103efe8c25a79d87030ca57d1a630afd214bd7058563dcb35aee31f82bda571955b210290d9f66da40f2c4962b20d5a1e3ad6a3694fdfc60fef4df1126a9d54984b9e0b53ae00000000
=>
11f36ca7c4840c2cd24dd58d061bd30ccad3a8e0885920dd6daca9c855372756
```
