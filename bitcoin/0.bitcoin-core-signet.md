# 0. Bitcoin core Signet ノードの構築

2024/11/09
作成，更新 Shigeichiro Yamasaki 

## install 方法

### MacOSXの場合

[Bitcoin core ダウンロードサイト](https://bitcoincore.org/bin/)からapple のdmg 形式のインストーラをダウンロードする

#### インストーラで bitcoin core をインストールしてアプリを起動

bitcon coreは「危険なアプリ」という扱いになっています。

* ドラックアンドドロップでアプリフォルダーにインストール
* アプリを起動してみる（起動しない）
* 「システム環境設定」の「セキュリティとプライバシー」で，ロックのアイコンをクリックしてパスワード入力
*  bitcoin coreに対して「ダウンロードしたアプリケーションの実行許可」を与える

#### コマンドラインからの操作を可能にする

[homebrew がインストール済とします．](https://brew.sh/)

homebrew で bitcoin coreをインストールする

```bash
brew install bitcoin
```

#### アプリ起動

「アプリケーションフォルダ」の bitcoin core アプリ起動

--

### ubuntu 24.04LTS/の場合

#### snap でインストールする

```bash
sudo snap install bitcoin-core
```

#### bitcoind を起動してみる


```bash
bitcoin-core.daemon
```

`<control>`-c でプロセスを終了させる

#### snap で bitcoin core をインストールしたときのコマンドインターフェース

* bitcoin-core.daemon : デーモン起動 (bitcoind)
* bitcoin-core.cli : クライアント (bitcoin-cli)

--

## bitcoind 設定ファイルを編集（作成）

設定ファイル (bitcoin.conf) を編集

bitcoin.confの場所


* ubuntu でsnap でインストールした場bitcoin.conf のデフォルトの場所
    * ~/snap/bitcoin-core/common/.bitcoin/bitcoin.conf
* MacOSX でパッケージインストールしたときのbitcoin.conf のデフォルトの場所
    * ~/Library/Application Support/Bitcoin/bitcoin.conf
* ubuntu で通常インストールしたときの bitcoin.conf のデフォルトの場所
    * ~/.bitcoin/bitcoin.conf

###  bitcoin.conf を編集

MacOSX 

```bash
nano ~/Library/Application Support/Bitcoin/bitcoin.conf
```

ubuntuでsnapでインストールした場合

```bash
nano ~/snap/bitcoin-core/common/.bitcoin/bitcoin.conf
```

★ blockfilterindex=1 を追加（2024/06/07)

```
signet=1
txindex=1
daemon=1
server=1
rest=1
blockfilterindex=1 
[signet]
rpcuser=hoge
rpcpassword=hoge
rpcport=38332
port=38333
fallbackfee=0.00002
```

保存して終了

## bitcoind の起動 

ubuntu の場合

```bash
bitcoin-core.daemon &
```
同期が完了するまで時間がかかります

上記のデーモンを起動する代わりに GUI ベースの bitcoin core を利用すると，同期の状態が視覚的に確認できます．

```bash
bitcoin-core.qt 
```

★ MacOSX の場合も以下のようなコマンドで bitcoind を起動することができます．
ただし，bitcoin core アプリケーションで起動中の場合は競合状態としてエラーになります．

```bash
bitcoind &
```

★ ubuntu の場合も以下のようなコマンドで GUI のbitcoin core を起動することができます．
ただし，bitcoin-core.daemon コマンドで bitcoind を起動中の場合は競合状態としてエラーになります．

```bash
bitcoin-core.qt &
```

## bitcoin クライアントコマンド

bitcoin ノードのAPIは bitcoin btcoin クライアントコマンドを使って操作することができます．

### ubuntu で snap でインストールした場合

```bash
bitcoin-core.cli <bitcoin  コマンド>
```

### MacOSX やソースコードからコンパイルした場合

```bash
bitcoin-cli <bitcoin コマンド>
```

以下では，ubuntu を前提に説明します

## 同期状態の確認

同期したブロック高

```bash
bitcoin-core.cli getblockcount
```

ブロックチェーンの同期が完了するまでブロック高は少しずつ増えていきます。
マシンの性能に依存しますが，最近の一般的な性能のマシンならsignet の場合30分から１時間程度でしょう．

## コマンドの一覧

help でコマンドの一覧を表示させることができます

```bash
bitcoin-core.cli  help

=>
== Blockchain ==
dumptxoutset "path"
getbestblockhash
getblock "blockhash" ( verbosity )
getblockchaininfo
getblockcount
getblockfilter "blockhash" ( "filtertype" )
getblockfrompeer "blockhash" peer_id
getblockhash height
getblockheader "blockhash" ( verbose )
getblockstats hash_or_height ( stats )
getchainstates
getchaintips
getchaintxstats ( nblocks "blockhash" )
getdeploymentinfo ( "blockhash" )
getdifficulty
getmempoolancestors "txid" ( verbose )
getmempooldescendants "txid" ( verbose )
getmempoolentry "txid"
getmempoolinfo
getrawmempool ( verbose mempool_sequence )
gettxout "txid" n ( include_mempool )
gettxoutproof ["txid",...] ( "blockhash" )
gettxoutsetinfo ( "hash_type" hash_or_height use_index )
gettxspendingprevout [{"txid":"hex","vout":n},...]
importmempool "filepath" ( options )
loadtxoutset "path"
preciousblock "blockhash"
pruneblockchain height
savemempool
scanblocks "action" ( [scanobjects,...] start_height stop_height "filtertype" options )
scantxoutset "action" ( [scanobjects,...] )
verifychain ( checklevel nblocks )
verifytxoutproof "proof"

== Control ==
getmemoryinfo ( "mode" )
getrpcinfo
help ( "command" )
logging ( ["include_category",...] ["exclude_category",...] )
stop
uptime

== Mining ==
getblocktemplate {"mode":"str","capabilities":["str",...],"rules":["segwit","str",...],"longpollid":"str","data":"hex"}
getmininginfo
getnetworkhashps ( nblocks height )
getprioritisedtransactions
prioritisetransaction "txid" ( dummy ) fee_delta
submitblock "hexdata" ( "dummy" )
submitheader "hexdata"

== Network ==
addnode "node" "command" ( v2transport )
clearbanned
disconnectnode ( "address" nodeid )
getaddednodeinfo ( "node" )
getaddrmaninfo
getconnectioncount
getnettotals
getnetworkinfo
getnodeaddresses ( count "network" )
getpeerinfo
listbanned
ping
setban "subnet" "command" ( bantime absolute )
setnetworkactive state

== Rawtransactions ==
analyzepsbt "psbt"
combinepsbt ["psbt",...]
combinerawtransaction ["hexstring",...]
converttopsbt "hexstring" ( permitsigdata iswitness )
createpsbt [{"txid":"hex","vout":n,"sequence":n},...] [{"address":amount,...},{"data":"hex"},...] ( locktime replaceable )
createrawtransaction [{"txid":"hex","vout":n,"sequence":n},...] [{"address":amount,...},{"data":"hex"},...] ( locktime replaceable )
decodepsbt "psbt"
decoderawtransaction "hexstring" ( iswitness )
decodescript "hexstring"
descriptorprocesspsbt "psbt" ["",{"desc":"str","range":n or [n,n]},...] ( "sighashtype" bip32derivs finalize )
finalizepsbt "psbt" ( extract )
fundrawtransaction "hexstring" ( options iswitness )
getrawtransaction "txid" ( verbosity "blockhash" )
joinpsbts ["psbt",...]
sendrawtransaction "hexstring" ( maxfeerate maxburnamount )
signrawtransactionwithkey "hexstring" ["privatekey",...] ( [{"txid":"hex","vout":n,"scriptPubKey":"hex","redeemScript":"hex","witnessScript":"hex","amount":amount},...] "sighashtype" )
submitpackage ["rawtx",...] ( maxfeerate maxburnamount )
testmempoolaccept ["rawtx",...] ( maxfeerate )
utxoupdatepsbt "psbt" ( ["",{"desc":"str","range":n or [n,n]},...] )

== Signer ==
enumeratesigners

== Util ==
createmultisig nrequired ["key",...] ( "address_type" )
deriveaddresses "descriptor" ( range )
estimatesmartfee conf_target ( "estimate_mode" )
getdescriptorinfo "descriptor"
getindexinfo ( "index_name" )
signmessagewithprivkey "privkey" "message"
validateaddress "address"
verifymessage "address" "signature" "message"

== Wallet ==
abandontransaction "txid"
abortrescan
addmultisigaddress nrequired ["key",...] ( "label" "address_type" )
backupwallet "destination"
bumpfee "txid" ( options )
createwallet "wallet_name" ( disable_private_keys blank "passphrase" avoid_reuse descriptors load_on_startup external_signer )
createwalletdescriptor "type" ( {"internal":bool,"hdkey":"str",...} )
dumpprivkey "address"
dumpwallet "filename"
encryptwallet "passphrase"
getaddressesbylabel "label"
getaddressinfo "address"
getbalance ( "dummy" minconf include_watchonly avoid_reuse )
getbalances
gethdkeys ( {"active_only":bool,"private":bool,...} )
getnewaddress ( "label" "address_type" )
getrawchangeaddress ( "address_type" )
getreceivedbyaddress "address" ( minconf include_immature_coinbase )
getreceivedbylabel "label" ( minconf include_immature_coinbase )
gettransaction "txid" ( include_watchonly verbose )
getunconfirmedbalance
getwalletinfo
importaddress "address" ( "label" rescan p2sh )
importdescriptors requests
importmulti requests ( options )
importprivkey "privkey" ( "label" rescan )
importprunedfunds "rawtransaction" "txoutproof"
importpubkey "pubkey" ( "label" rescan )
importwallet "filename"
keypoolrefill ( newsize )
listaddressgroupings
listdescriptors ( private )
listlabels ( "purpose" )
listlockunspent
listreceivedbyaddress ( minconf include_empty include_watchonly "address_filter" include_immature_coinbase )
listreceivedbylabel ( minconf include_empty include_watchonly include_immature_coinbase )
listsinceblock ( "blockhash" target_confirmations include_watchonly include_removed include_change "label" )
listtransactions ( "label" count skip include_watchonly )
listunspent ( minconf maxconf ["address",...] include_unsafe query_options )
listwalletdir
listwallets
loadwallet "filename" ( load_on_startup )
lockunspent unlock ( [{"txid":"hex","vout":n},...] persistent )
migratewallet ( "wallet_name" "passphrase" )
newkeypool
psbtbumpfee "txid" ( options )
removeprunedfunds "txid"
rescanblockchain ( start_height stop_height )
restorewallet "wallet_name" "backup_file" ( load_on_startup )
send [{"address":amount,...},{"data":"hex"},...] ( conf_target "estimate_mode" fee_rate options )
sendall ["address",{"address":amount,...},...] ( conf_target "estimate_mode" fee_rate options )
sendmany ( "" ) {"address":amount,...} ( minconf "comment" ["address",...] replaceable conf_target "estimate_mode" fee_rate verbose )
sendtoaddress "address" amount ( "comment" "comment_to" subtractfeefromamount replaceable conf_target "estimate_mode" avoid_reuse fee_rate verbose )
sethdseed ( newkeypool "seed" )
setlabel "address" "label"
settxfee amount
setwalletflag "flag" ( value )
signmessage "address" "message"
signrawtransactionwithwallet "hexstring" ( [{"txid":"hex","vout":n,"scriptPubKey":"hex","redeemScript":"hex","witnessScript":"hex","amount":amount},...] "sighashtype" )
simulaterawtransaction ( ["rawtx",...] {"include_watchonly":bool,...} )
unloadwallet ( "wallet_name" load_on_startup )
upgradewallet ( version )
walletcreatefundedpsbt ( [{"txid":"hex","vout":n,"sequence":n,"weight":n},...] ) [{"address":amount,...},{"data":"hex"},...] ( locktime options bip32derivs )
walletdisplayaddress "address"
walletlock
walletpassphrase "passphrase" timeout
walletpassphrasechange "oldpassphrase" "newpassphrase"
walletprocesspsbt "psbt" ( sign "sighashtype" bip32derivs finalize )

== Zmq ==
getzmqnotifications
```

## bitcoinワレットの作成

bitcoin core には bitcoin ワレットの機能があります．
bitcoinを受領したり送金したりするためにはワレットが必要です．

ここではワレット名を alice としています．

自分の名前などに変更することができます．

```bash
bitcoin-core.cli createwallet alice

=>
{
  "name": "alice"
}
```

### ワレットの情報が格納されている場所

ubuntuの signet 場合

```bash
cd ~/snap/bitcoin-core/common/.bitcoin/signet/wallets

ls
=>
alice
```

### アドレスの生成

tb1 で始まる文字列があなたのアドレスです．

```bash
bitcoin-core.cli getnewaddress

=>
tb1qa0gknzlqcx2mz54myqvxl8ev3h2w6lswqw4gvj
```

★ 一つのワレットの中に，アドレスはいくつでも生成することができます．

## 生成したアドレスへのテスト用コインの入手

生成したアドレスを宛先にしてsignetの bitcoin を受け取ることができます。

以下のURLから signet ネットワークの bitcoin （無料）を入手できます．受け取れる金額は最大で 0.01 BTCです。
ただし，同じグローバルIPアドレスからは24時間に1回しか受け取ることができません．
大学などのネットワーク環境では全員が一つのグローバルIPアドレスを共有しているので，24時間に一人しか受け取ることができません．
自宅などからトライしてください．

[https://signetfaucet.com/](https://signetfaucet.com/)


