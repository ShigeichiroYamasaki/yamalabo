# 03. Eth ã‚’æ‰€æœ‰å¯èƒ½ãªã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ

2025/03/09
Shigeichiro Yamasaki

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®Eth é€é‡‘ã‚’å¯èƒ½ã«ã™ã‚‹æ–¹æ³•

1. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒ ETH ã‚’å—å–å¯èƒ½ã«ã™ã‚‹ï¼ˆé–¢æ•°ã« payableä¿®é£¾å­ã‚’ã¤ã‘ã‚‹ï¼‰
2. æ°¸ä¹…ã«ETHã‚’æ‰€æœ‰ã—ãŸã¾ã¾ã«ã—ãªã„ãŸã‚ã«ï¼Œã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒæ‰€æœ‰ã™ã‚‹ Eth ã‚’å¼•ãå‡ºã—å¯èƒ½ã«ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„
 
### hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```bash
cd ~/hardhat
mkdir payable
cd payable
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

// æ¶ˆã•ãªãã¦ã‚‚å®Ÿå®³ã¯ç„¡ã„ãŒæ¶ˆã—ã¦ãŠã

rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```
### ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã®ä½œæˆ

* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ solidity ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆ

```bash
nano contracts/EthWallet.sol
```

* ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚ˆãèª­ã‚“ã§ãã ã•ã„
  
```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EthWallet {
    address public owner;

    constructor() {
      // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰€æœ‰è€…ã¨ã—ã¦è¨­å®š
        owner = msg.sender; 
    }
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒETHã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®é–¢æ•°
    receive() external payable {
        // å—ã‘å–ã£ãŸETHã¯è‡ªå‹•çš„ã«ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ®‹é«˜ã«åŠ ç®—ã•ã‚Œã¾ã™
    }
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ ETHã‚’é é‡‘ã™ã‚‹ deposit ã¯payable é–¢æ•°
    function deposit() public payable {
    }
    // æ‰€æœ‰è€…ã®ã¿ãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ETHã‚’å¼•ãå‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹é–¢æ•°
    function withdraw(uint256 amount) public {
        require(msg.sender == owner, "only owner can withdraw");
        require(amount <= address(this).balance, "not enough Eth");
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒæ‰€æœ‰ã™ã‚‹ ETH ã‹ã‚‰æŒ‡å®šã—ãŸé‡ã®ETHã‚’æ‰€æœ‰è€…ã«è»¢é€
        payable(owner).transfer(amount);
    }
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ®‹é«˜ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
    function getBalance() public view returns (uint256) {
        return address(this).balance;
    }
}
```

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile
=>
Compiled 1 Solidity file successfully (evm target: paris).
```

## ãƒ†ã‚¹ãƒˆã®ä½œæˆ

```bash
nano test/EthWallet.js
```

```js
// hardhat tool box ã®åˆ©ç”¨
const {loadFixture} = require("@nomicfoundation/hardhat-toolbox/network-helpers");
// CHaiã®åˆ©ç”¨
const { expect } = require("chai");

async function deployEthWalletFixture() {
  // è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å–å¾—
  const [owner, addr1, addr2] = await ethers.getSigners();
  // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
  const EthWallet = await ethers.deployContract("EthWallet");
  // EthWalletãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
  return { EthWallet, owner, addr1, addr2 };
}

describe("EthWalletã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ", function () {
  it("EthWallet ã®åˆæœŸã®æ‰€æŒé‡‘ã¯ 0ETH", async function () {
    // EthWalletãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
    const {EthWallet, owner, addr1, addr2} = await loadFixture(deployEthWalletFixture);
    expect(await EthWallet.getBalance()).to.equal(0);
  });
  it("ownerã‹ã‚‰EthWalletã¸10000000WEIé€é‡‘ã™ã‚‹", async function () {
    // EthWalletãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
    const {EthWallet, owner, addr1, addr2} = await loadFixture(deployEthWalletFixture);
    await owner.sendTransaction({to: EthWallet, value: 10000000n});
    expect(await EthWallet.getBalance()).to.equal(10000000n);
  });
  it("addr1 ã‹ã‚‰ EthWalletã¸10000000WEIé€é‡‘ã™ã‚‹", async function () {
    // EthWalletãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
    const {EthWallet, owner, addr1, addr2} = await loadFixture(deployEthWalletFixture);
    await addr1.sendTransaction({to: EthWallet, value: 10000000n});
    expect(await EthWallet.getBalance()).to.equal(10000000n);
  });
  it("ownerã‹ã‚‰EthWalletã¸10000000WEIé€é‡‘ã—ã¦ ownerãŒ 5000WEIå¼•ãå‡ºã™", async function () {
    // EthWalletãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
    const {EthWallet, owner, addr1, addr2} = await loadFixture(deployEthWalletFixture);
    await owner.sendTransaction({to: EthWallet, value: 10000000n});
    await EthWallet.withdraw(5000n);
    expect(await EthWallet.getBalance()).to.equal(9995000n);
  });
});

```

### testã®å®Ÿè¡Œ

```bash
npx hardhat test 
=>

  EthWalletã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
    âœ” EthWallet ã®åˆæœŸã®æ‰€æŒé‡‘ã¯0 (295ms)
    âœ” ownerã‹ã‚‰EthWalletã¸10000000WEIé€é‡‘ã™ã‚‹
    âœ” addr1 ã‹ã‚‰ EthWalletã¸10000000WEIé€é‡‘ã™ã‚‹
    âœ” ownerã‹ã‚‰EthWalletã¸10000000WEIé€é‡‘ã—ã¦ ownerãŒ 5000WEIå¼•ãå‡ºã™


  4 passing (304ms)
```

## hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

```bash
nano ignition/modules/EthWallet.js
```

```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("EthWallet", (m) => {
  const contract = m.contract("EthWallet", []);
  return { contract };
});
```

## ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã®èµ·å‹•

```bash
npx hardhat node
```

## ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
cd ~/hardhat/payable
```

```bash
npx hardhat ignition deploy ignition/modules/EthWallet.js --network localhost

=>
Hardhat Ignition ğŸš€

Deploying [ EthWallet ]

Batch #1
  Executed EthWallet#EthWallet

[ EthWallet ] successfully deployed ğŸš€

Deployed Addresses

EthWallet#EthWallet - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```


### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

```bash
npx hardhat console --network localhost
```

* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ¥ç¶š

```js
> const [owner, addr1, addr2] = await ethers.getSigners();
> const EthWallet = await ethers.deployContract("EthWallet");
```

* EthWallet ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹

```js
> const EthWallet_addr = await EthWallet.target;
> EthWallet_addr
'0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512'
```

* sendTransaction ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ãŸ ETH ã®é€é‡‘

```js
// EthWallet ã¸ ETH ã‚’é€é‡‘ã™ã‚‹ (10000000 wei)
> await owner.sendTransaction({to: EthWallet_addr, value: 10000000n});
```

* getBalance é–¢æ•°

```js
// EthWallet ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä¿æœ‰æ®‹é«˜ã‚’è¡¨ç¤ºã™ã‚‹
> await EthWallet.getBalance()
10000000n


// ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ‰€æŒé‡‘ã‚’ 100000 ETH å¼•ãå‡ºã™
> await EthWallet.withdraw(100000)

> await EthWallet.getBalance()
9900000n
```

* deposit é–¢æ•°ï¼ˆpayableï¼‰ã‚’åˆ©ç”¨ã—ãŸETHã®é€é‡‘

```js
> await EthWallet.deposit({value: 30000});

> await EthWallet.getBalance()
9930000n
```

