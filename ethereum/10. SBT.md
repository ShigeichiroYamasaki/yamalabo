# ERC-5192 SBT (SoulBound Token) 譲渡不可能な NFT

2024/12/11
Shigeichiro Yamasaki

## ERC-5192 の仕様

[ERC-5192: Minimal Soulbound NFTs](https://eips.ethereum.org/EIPS/eip-5192)

## ERC-5192 の概要

* ERC-721 NFTを拡張し，単一のアカウントにバインドされたNFTを定義する．
* この ERC はERC-721トークンをソウルバウンドにするための最小限の interface の定義
* EIP-165 の interface 検出機能を使用する



## NFTの移転をロックする方法

* `locked(uint256 tokenId)` という名前の関数を使ってトークンのロック状態を照会できます。
* トークンがロックされている場合、すべてのEIP721関数はトークンの転送を拒否する必要があります。


## ERC5192 コントラクトのインターフェース (IERC5192)

```js
// SPDX-License-Identifier: CC0-1.0
pragma solidity ^0.8.0;

interface IERC5192 {
  /// @notice Emitted when the locking status is changed to locked.
  /// @dev If a token is minted and the status is locked, this event should be emitted.
  /// @param tokenId The identifier for a token.
  event Locked(uint256 tokenId);

  /// @notice Emitted when the locking status is changed to unlocked.
  /// @dev If a token is minted and the status is unlocked, this event should be emitted.
  /// @param tokenId The identifier for a token.
  event Unlocked(uint256 tokenId);

  /// @notice Returns the locking status of an Soulbound Token
  /// @dev SBTs assigned to zero address are considered invalid, and queries
  /// about them do throw.
  /// @param tokenId The identifier for an SBT.
  function locked(uint256 tokenId) external view returns (bool);
}
```



## hardhat プロジェクトの作成

```bash
cd ~/hardhat
mkdir sbt
cd sbt
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

// 消さなくても実害は無いが消しておく

rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## Solidity プログラム

SBT の solidity プログラム

```bash
nano contracts/sbt.sol
```

```js
// SPDX-License-Identifier: MIT
// Compatible with OpenZeppelin Contracts ^5.0.0
pragma solidity ^0.8.22;

import {ERC721} from "@openzeppelin/contracts/token/ERC721/ERC721.sol";

contract SBT is ERC721 {
    constructor() ERC721("SBT", "SBT") {}
}

```

## OpenZeppelinの ERC20 ライブラリのインストール

```bash
yarn add --dev @openzeppelin/contracts
```


##  コンパイル

```bash
npx hardhat compile
```


## テストの作成

```bash
nano test/sbt.js
```

```js
// hardhat tool box の利用
const {loadFixture} = require("@nomicfoundation/hardhat-toolbox/network-helpers");
// CHaiの利用
const { expect } = require("chai");

describe("SBTコントラクト", function () {
  async function deploySBTFixture() {
    // テスト用アカウントの取得
    const [owner, addr1, addr2] = await ethers.getSigners();
    // コントラクトをデプロイする(初期供給量 10**11)
    const JPYcoin = await ethers.deployContract("JPYcoin",[10n**11n]);
    // JPYcoinテスト用フィクスチャ
    return {JPYcoin, owner, addr1, addr2};
  }
  it("JPYcoinの総供給量をownerが所有している", async function () {
    // EthWalletテスト用フィクスチャをロードする
    const {JPYcoin, owner, addr1, addr2} = await loadFixture(deployJPYcoinFixture);
    const total = await JPYcoin.totalSupply();
    expect(await JPYcoin.balanceOf(owner.address)).to.equal(total);
  });
  it("JPYcoinの転送", async function () {
    // EthWalletテスト用フィクスチャをロードする
    const {JPYcoin, owner, addr1, addr2} = await loadFixture(deployJPYcoinFixture);
    await JPYcoin.transfer(addr1,8000000n);
    expect(await JPYcoin.balanceOf(addr1.address)).to.equal(8000000n);
    expect(await JPYcoin.balanceOf(owner.address)).to.equal(10n**11n-8000000n);
  });

});

```

### testの実行

```bash
npx hardhat test 
=>
  JPYcoinコントラクト
    ✔ JPYcoinの総供給量をownerが所有している (399ms)
    ✔ JPYcoinの転送


  2 passing (402ms)
```
