# 02. viem

2025/08/29

Shigeichiro Yamasaki

ここでは，Hardhat 3 における viem の利用方法について説明します．Hardhat 3 のインストールが完了していることを前提にします．

## EVMラッピングクライアント

EVM (Ethereum Virtual Machine) は API を備えており，EVM に対する操作はこのAPIを介して行います．

この資料では，このEVM API に対するクライアントアプリケーションのフレームワークを「EVM ラッピングクライアント」と呼ぶことにします

```
（EVMラッピングクライアント）→ http/websoket → EVM
   web3.js
   Etheres.js
   viem
```

viem は，EVMラッピングクライアントの一つです．

javaScript や TypeScript による EVMラッピングクライアントの例として，web3.js や Etheres.js などがあります．

## viem の特徴

* Etheres.js などよりもモジュール化を向上
* Ethereum の用語法をより厳密化
* パフォーマンスの向上
* TypeScript による型安全性を重視

## レファレンス

viem による実際のコーディングを行うときには，ここのレファレンスを参照してください

### [viem Docs](https://viem.sh/docs/getting-started)


## viem の基本構成

viem は，大きく分けると Client と Transport の2つ部分から構成されています．Client は，EVMのAPIを介したアクションを行う機能で，Transport は，http や WebSocket などのネットワーク通信手段です．

### Client

* Public Client
  * ブロック番号やアカウントの残高の確認のようなEVM側のアクションのためのクライアント
* Wallet Client
  * トランザクションへの署名や送出のようなワレット側のアクションのためのクライアント
* Test Client
  * 仮想的なブロックのマイニングなどのテストやシミュレーションのための機能を持つクライアント

### Transport

* HTTP Transport
  * HTTP による JSON-RPC API の通信
* WebSocket Transport
  * WebSocket による JSON-RPC API の通信
* Custom Transport
  * [EIP1193](https://eips.ethereum.org/EIPS/eip-1193) によるリクエスト機能

## Public Client

### TypeScript での import 方法

```ts
import { createPublicClient } from 'viem'
```

### 利用法

```ts
import { createPublicClient, http } from 'viem'
import { mainnet } from 'viem/chains'
 
const publicClient = createPublicClient({ 
  chain: mainnet,
  transport: http()
})
```

 createPublicClient関数 のパラメータ
  * chain: 
    * 接続するチェーン
  * transport: 
    * 使用する Transport


### Public Clientの対象と操作

#### ・アクセスリスト

* トランザクション要求に基づいてEIP-2930アクセスリストを作成

#### ・アカウント

* 残高確認
* アカウントがブロードキャスト/送信したトランザクションの数

#### ・ブロック

* ブロック番号、ハッシュ、またはタグにあるブロックに関する情報
* 最後に確認されたブロックの番号
* ブロック番号、ハッシュ、またはタグでのトランザクションの数
* オプションのブロックと状態のオーバーライドを使用して、ブロックに対する一連の呼び出しをシミュレート
* 着信ブロック番号を監視して返す
* 着信ブロックの情報を監視して返す

#### ・Calls

* 新しいメッセージ呼び出しを実行する
* ブロックの呼び出しセットをシミュレートし、オプションでアセットの変更を

#### ・チェーン

* 現在のネットワークに関連付けられたチェーンIDを返す

#### ・EIP721

* ERC-5267 仕様に基づいて、コントラクトから EIP-712 ドメインを読み取る

#### ・Fee

* 次のブロックに含まれる可能性のあるトランザクションのガスあたりの手数料の見積り (wei 単位) を返す
* トランザクションのガスを見積もる
* 次のブロックに含まれる可能性のあるトランザクションのガスあたりの最大優先手数料の見積り値（wei 単位）
* 現在の BLOB 基本料金 (wei 単位) を返します
* ガスの履歴情報のコレクションを返します
* 現在のガス価格（wei 単位）を返します

#### ・Filters & Logs

* 新しいブロック ハッシュをリッスンするためのフィルターを作成
* 新しいイベントをリッスンするためのフィルターを作成
* 新しい保留中のトランザクション ハッシュをリッスンするためのフィルターを作成
* 最後に呼び出されてからのフィルターに基づいて、ログまたはハッシュのリストを返します
* フィルターが作成されてからのイベントログのリストを返します
* 指定されたパラメータに一致するイベントログのリストを返します
* 発行されたイベント ログを監視して返します
* フィルターの破棄

#### ・Proof

* 指定されたアカウントのアカウント値とストレージ値を Merkle プルーフも含めて返します

#### ・署名関係

* メッセージが指定されたアドレスによって署名されていることを確認します
* 入力したデータが指定されたアドレスによって署名されていることを確認します

#### ・トランザクション

* nonce、ガス制限、手数料の値、トランザクション タイプを入力して、署名用のトランザクション リクエストを準備します
* ハッシュまたはブロック識別子を指定してトランザクションに関する情報を返します
* トランザクションがブロック上で処理されてから通過したブロックの数 (確認) を返します
* トランザクションハッシュを指定してトランザクション レシートを返します
* 署名されたトランザクションをネットワークに送信します。パブリッククライアントとウォレットクライアントの両方で使用できます
* トランザクションがブロックに含まれるのを待ち(1 回の確認)、その後トランザクションの受領書を返します
* 保留中のトランザクション ハッシュを監視して返します

## Wallet Client

### 対象と操作

#### ・アカウント

* ウォレットまたはクライアントが所有するアカウント アドレスのリストを返します
* ウォレットによって管理されているアカウントのリストを要求します

#### ・アセット

* ユーザーにウォレット内のトークンを追跡するよう要求します。トークンが正常に追加されたかどうかを示すブール値を返します。

#### ・Call Bundles (EIP-5792)

* 送信された呼び出しバッチのステータスを返します

#### ・チェーン

* ウォレットに EVM チェーンを追加します
* ウォレット内のターゲットチェーンを切り替えます

#### ・データ

* EIP-191 形式でEthereum 固有の署名を計算します
* 型付けされたデータに署名し、 Ethereum 固有の署名を計算します

#### ・Permissions

* ウォレットの現在の権限を取得します
* ウォレットの権限を要求します

#### ・トランザクション

* nonce、ガス制限、手数料の値、トランザクション タイプを入力して、署名用のトランザクション リクエストを準備します
* 署名されたトランザクションをネットワークに送信します
* 新しいトランザクションを作成し、署名して、ネットワークに送信します
* トランザクションに署名します

## Test Client



