# 5. ERC20 トークンの作成と利用

OpenZeppelin のライブラリを利用した ERC20トークンを処理するコントラクト

最終更新 2024/11/05  Shigeichiro Yamasaki

## ERC-20の仕様

[ERC-20: Token Standard](https://eips.ethereum.org/EIPS/eip-20)

### ERC-20 のメソッド

* name 
  * トークンの名前を返す
  * `function name() public view returns (string)`
* symbol
  * トークンのシンボルを返す
  * `function symbol() public view returns (string)`
* decimals
  * トークンが使用する 10進数の小数点以下の桁数を返す
  * `function decimals() public view returns (uint8)`
* totalSupply
  * トークンの総供給量を返す
  * `function totalSupply() public view returns (uint256)`
* balanceOf
  * アドレスのアカウントが所有しているトークンの残高を返す
  * `function balanceOf(address _owner) public view returns (uint256 balance)`
* transfer
  * 金額 _value のトークンを _to のアドレスに送る
  * `function transfer(address _to, uint256 _value) public returns (bool success)`
* transferFrom
  * 代理で _from アドレスから _to アドレス宛に金額 _value のトークンを送る
  * `function transferFrom(address _from, address _to, uint256 _value) public returns (bool success)`
* approve
  * _spender アドレスのアカウントに対して _value で指定した金額まで複数回引き出すことを承認する
  * `function approve(address _spender, uint256 _value) public returns (bool success)`
* allowance
  * _spender アドレスのアカウントが _owner アドレスの所有者のアカウントから引き出し可能な残高を返す
  * `function allowance(address _owner, address _spender) public view returns (uint256 remaining)`

### ERC-20 のイベント

* Transfer
  * トークンが転送されたときにトリガされる．新規トークンを生成したときには  _from アドレスに 0x0 をセットする
  * `event Transfer(address indexed _from, address indexed _to, uint256 _value)`
* Approval
  * approve が成功したときにトリガされる．
  * `event Approval(address indexed _owner, address indexed _spender, uint256 _value)`

## ERC-20 トークンの送金 (transfer)

* コントラクトアカウントのストレージで（key,値）構造で管理される
  * 主キーは，所有者のアドレス
  * 値は，所有者ごとのトークンの残高
* トークンの送金は，送金者と受領者の保有残高の更新
  * ETHの保有は影響しない（ガス代は必要）
  
## ERC-20 の代理送金 (approve/tranferFrom)

* トークン保有者が自分のトークンの送金権限を別のアドレスに移譲することができる
  * スマートコントラクトによるトークンの販売などに利用される
* 承認 (approve)の利用例
  * トークン保有者が承認者で
  * トークン販売コントラクトにトークンの代理送金を承認する
* 代理送金（tranferFrom）の例
  * トークン販売コントラクトに Eth でトークン購入金額が入金されると
  * トークン販売コントラクトが購入者にトークンを代理送金する


## OpenZeppelin のERC20 ライブラリ

* OpenZeppelin のAPIサイト

[https://docs.openzeppelin.com/contracts/4.x/erc20](https://docs.openzeppelin.com/contracts/4.x/erc20)


## hardhat プロジェクトの初期化

### OSのアップデート

* ubuntu

```bash
sudo apt update
sudo apt upgrade -y
```
* MacOSX

```bash
brew update
brew upgrade
```

## hardhat プロジェクトの初期構成

* ERC20 用プロジェクト・ディレクトリ

```bash
cd ~/hardhat
mkdir erc20
cd erc20
```

* node.js プロジェクトの初期化と hardhat のインストール

```bash
// プロジェクトの初期設定
npm init
// hardhat のインストール
npm install --save-dev hardhat
```

###  hardhat プロジェクトの初期化


```bash
npx hardhat init

888    888                      888 888               888
888    888                      888 888               888
888    888                      888 888               888
8888888888  8888b.  888d888 .d88888 88888b.   8888b.  888888
888    888     "88b 888P"  d88" 888 888 "88b     "88b 888
888    888 .d888888 888    888  888 888  888 .d888888 888
888    888 888  888 888    Y88b 888 888  888 888  888 Y88b.
888    888 "Y888888 888     "Y88888 888  888 "Y888888  "Y888

👷 Welcome to Hardhat v2.22.15 👷‍

? What do you want to do? … 
❯ Create a JavaScript project
  Create a TypeScript project
  Create a TypeScript project (with Viem)
  Create an empty hardhat.config.js
  Quit
```

* ▶ Create a JavaScript project を選択（キーボードの矢印キーを使って）


```bash
✔ What do you want to do? · Create a JavaScript project
✔ Hardhat project root: · /Users/shigeichiroyamasaki/hardhat/erc20
✔ Do you want to add a .gitignore? (Y/n) · y
✔ Do you want to install this sample project's dependencies with npm (@nomicfoundation/hardhat-toolbox)? (Y/n) · y


npm install --save-dev "@nomicfoundation/hardhat-toolbox@^5.0.0"

...
```

* 生成されたディレクトリの確認

```bash
tree -L 1
.
├── README.md
├── contracts
├── hardhat.config.js
├── ignition
├── node_modules
├── package-lock.json
├── package.json
└── test
```

* サンプルプログラムの削除

hardhat が自動的に作成するサンプルプログラムを削除する

```bash
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## hardhat へのOpenZeppelin のライブラリのインストール

プロジェクトルートに移動してへのOpenZeppelinコントタクトのモジュールをインストール

```bash
npm install  --save-dev @openzeppelin/contracts
```

## ERC-20 コントラクトの作成

* ここでは，仮にトークン名 JPQ とコントラクト名を JPYcoin としますが，好きな名前にしてください

```bash
nano contracts/JPYcoin.sol
```

このコントラクトは、name、symbol、initialSupply（初期供給量）を引数に取り、デプロイ時にトークンの全量をデプロイアドレスにミントします。

* 以下のコントラクトは，OpenZeppelin のサンプルを利用しています．

[https://docs.openzeppelin.com/contracts/4.x/erc20](https://docs.openzeppelin.com/contracts/4.x/erc20)

* コントラクトの継承とコンストラクタの間接的初期化

  * OpenZeppelin の ERC20 コントラクトを継承して子コントラクトを作成しています．
  * この子コントラクトのコンストラクタでは親コントラクトの初期化も必要になることに注意してください．

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract JPYcoin is ERC20 {
  // ERC20 コントラクトのコンストラクタの引数 (name, symbol,decimals)
    constructor(uint256 initialSupply) ERC20("JPYcoin", "JPQ") {
        _mint(msg.sender, initialSupply);
    }
}

```

## コントラクトのコンパイル

```bash
npx hardhat compile

=>
Compiled 6 Solidity files successfully (evm target: paris).
```

* コンパイル結果の確認

```bash
tree artifacts -L 3

artifacts
├── @openzeppelin
│   └── contracts
│       ├── interfaces
│       ├── token
│       └── utils
├── build-info
│   └── 7d27c41fc48e3990cc6a895cbc040705.json
└── contracts
    └── JPYcoin.sol
        ├── JPYcoin.dbg.json
        └── JPYcoin.json

9 directories, 3 files
```

## hardhat node の起動


* 新しいターミナルを起動してプロジェクトルートに移動

```bash
cd ~/hardhat/erc20
```

### hardhat設定ファイル hardhat.config.js の修正

* ネットワークを hardhat networkにする
* チェインIDを 31337
* マイニングの間隔を10秒に設定

```bash
nano hardhat.config.js
```

```js
require("@nomicfoundation/hardhat-toolbox");

/** @type import('hardhat/config').HardhatUserConfig */
module.exports = {
  solidity: "0.8.27",
  networks: {
    hardhat: {
      chainId: 31337,
      mining: {
        auto: false,
        interval: [10000, 11000]
      }
    },
  },
};
```

### Ethereum ローカルノードの起動

* hardhat ノードの起動

```bash
npx hardhat node
```

### hardhat ignition によるデプロイモジュールの作成

* 別のターミナルのプロジェクトルートからの操作
* scripts ディレクトリを作成
* deploy スクリプトを作成


```bash
nano ignition/modules/JPYcoin.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("JPYcoin", (m) => {
  const contract = m.contract("JPYcoin", [10**11]);
  return { contract };
});
```


### ローカルノードへのデプロイ

```bash
npx hardhat ignition deploy ignition/modules/JPYcoin.js --network localhost

```

* ログの確認

コントラクトアドレスを確認する

```js
Mined block #2
  Block: 0x4a2f1a0e507d9644c1820f2f2e22ae23b6d2996551728a3c7786a83e9770b0b1
    Base fee: 765625000
    Transaction:           0x41f22e62a47994606ab9464e9b3800c54ba29fbf0ba5c6e28aaa6eed7ad52c7b
      Contract deployment: JPYcoin
      Contract address:    0x5fbdb2315678afecb367f032d93f642f64180aa3
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            965817 of 965817
```
## コンソールからの操作

### コンソールの起動

```bash
npx hardhat console --network localhost 
```

### ERC20 コントラクトへの操作

```js
> const JPYcoin = "0x5fbdb2315678afecb367f032d93f642f64180aa3"
> const JPYcoinFactory = await ethers.getContractFactory("JPYcoin")
// 当該コントラクトアドレスのコントラクトに接続する
> const JPQ = await JPYcoinFactory.attach(JPYcoin)

// テスト用アカウント
> const [owner, addr1, addr2] = await ethers.getSigners();

// トークンの総供給量
> await JPQ.totalSupply()
100000000000n
// owner のトークン保有量
> await JPQ.balanceOf(owner)
100000000000n
> await JPQ.name()
'JPYcoin'
> await JPQ.symbol()
'JPQ'
> await JPQ.decimals()
18n
```

* トークンの送付

```js
> await JPQ.transfer(addr1,8000000)
```

* アカウントのトークン保有残高の確認

```js
> await JPQ.balanceOf(owner)
99992000000n

> await JPQ.balanceOf(addr1)
8000000n
```

* addr1 にトークン送金を承認する

```js
> await JPQ.approve(addr1,1000)

```

* addr1 に承認された owner のトークンの引き出し可能金額

```js
> await JPQ.allowance(owner, addr1)
1000n
```

* addr1 が owner の代理で addr2 にトークンを送金する

```js
> await JPQ.transferFrom(addr1,addr2,100)

```

## メタマスク

### アカウントのインポート

* `アカウントをインポート`
* 秘密鍵を入力

### トークンのインポート

* `+ トークンをインポート` をクリック
* コントラクトアドレスを入力
* トークンボタンをクリック

## Payable: Eth で支払い可能なコントラクトの作成

1. コントラクトが ETH を受取可能にする（payable修飾子）
2. コントラクトが所有する Eth を引き出し可能にする
3. コントラクトのpayable修飾子関数にETHを送金する
4. コントラクトの保有ETHを引き出してオーナーに送金する
 
### 作成

* 新しいターミナルを開いて以下を実行
* プロジェクトルートに移動

```bash
cd ~/hardhat/erc20
```

### コントラクトのコード

```bash
nano contracts/EthWallet.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EthWallet {
    address public owner;

    constructor() {
        owner = msg.sender; // コントラクトをデプロイしたアドレスを所有者として設定
    }

    // コントラクトにETHを送信するための関数
    receive() external payable {
        // 受け取ったETHは自動的にコントラクトの残高に加算されます
    }

    // コントラクトへ ETHを預金する
    function deposit() public payable {
    }

    // 所有者のみがコントラクトのETHを引き出せるようにする関数
    function withdraw(uint256 amount) public {
        require(msg.sender == owner, "Only owner can withdraw");
        require(amount <= address(this).balance, "Insufficient balance");

        // コントラクトから指定した量のETHを所有者に転送
        // payable 関数：
        payable(owner).transfer(amount);
    }

    // コントラクトの残高を確認する関数
    function getBalance() public view returns (uint256) {
        return address(this).balance;
    }
}
```

### payable修飾子の関数への etheres.js による送金

* etheres.js によるコントラクトの関数呼び出しの引数にオプションで送金金額を指定できる

例
```js
// 送金するETHをwai に単位変換する
> const amount = ethers.parseUnits("0.1", 18); 
// 送金金額のオプション化
> const options = { value: amount };
> EthWallet
```


### hardhat ignition によるデプロイモジュールの作成

```bash
nano ignition/modules/EthWallet.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("EthWallet", (m) => {
  const contract = m.contract("EthWallet", []);
  return { contract };
});
```

### ローカルノードへのデプロイ

```bash
npx hardhat ignition deploy ignition/modules/EthWallet.js --network localhost

=>
Batch #1
  Executed EthWallet#EthWallet

[ EthWallet ] successfully deployed 🚀

Deployed Addresses

JPYcoin#JPYcoin - 0x5FbDB2315678afecb367f032d93F642f64180aa3
EthWallet#EthWallet - 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
```

* ログの確認

コントラクトアドレスを確認する

```js
Mined block #1
  Block: 0x5fa6ea8f00f6a259c9abc4cf13c54590e3dc8b69a8b57ac6ca90a9ceff2fc2cd
    Base fee: 875000000
    Transaction:           0x25c5989fe41a0cee41a35b49700339a287da041490a29af6514157572de83fd9
      Contract deployment: EthWallet
      Contract address:    0x5fbdb2315678afecb367f032d93f642f64180aa3
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            313341 of 313341
```


### コンソールからの操作

* コントラクトへの接続

```js
> const EthWallet = "0x5fbdb2315678afecb367f032d93f642f64180aa3"
undefined
> const EthWalletFactory = await ethers.getContractFactory("EthWallet")
undefined
> const EW =  await EthWalletFactory.attach(EthWallet)
undefined
```

* テスト用アカウント

```js
> const [owner, addr1, addr2] = await ethers.getSigners();
```

* sendTransaction メソッドを使った ETH の送金

```js
// EthWallet へ ETH を送金する (10000000 wei)
> await owner.sendTransaction({to: EthWallet, value: 10000000})

=>
TransactionResponse {
  provider: HardhatEthersProvider {

...
}
```

* getBalance 関数

```js
// EthWallet コントラクトの保有残高を表示する
> await EW.getBalance()
10000000n


// コントラクトの所持金を引き出す
> await EW.withdraw(100000)

=>
ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
}

> await EW.getBalance()
9900000n
```

* deposit 関数（payable）を利用したETHの送金

```js
> await EW.deposit({value: 30000});

=>
ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
 }

> await EW.getBalance()
9930000n
```

## Faucet : ERC20トークンを Eth で購入するコントラクトの作成

###  Eth でトークンを販売するコントラクトの作成手順

1. コントラクトがETHを支払い可能
2. コントラクトが所有する Eth をオーナーのみが引き出し可能
2. トークンを受け取り可能
2. コントラクトが所有するトークンを transferFrom 関数を使って購入者に送る。
3. トークンとのレートは 1ETH あたりのトークン量として決める

### 作成

* 新しいターミナルを開いて以下を実行
* プロジェクトルートに移動

```bash
cd ~/hardhat/erc20
```

### コントラクトのコード

```bash
nano contracts/JPYFaucet.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// OpenZeppelinのライブラリをインポートする
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract JPYFaucet {
    JPYcoin private token;
    address public owner;
    uint256 public rate; // 1ETH あたりのトークン

    constructor(JPYcoin _token, uint256 _rate) {
        token = _token;
        rate = _rate;
        owner = msg.sender; // コントラクトをデプロイしたアドレスを所有者として設定
    }

    // コントラクトにETHを送信するための関数
    // この ETH はトークン購入の代金になるので，ETHを受領すると購入者にJPYトークンを代理送金します
    function buyTokens() public payable {
        // msg.value     呼び出しトランザクションで送金された ETH の金額（wei単位）
        require(msg.value > 0, "ETH must be greater than 0");
        // 購入トークン量の計算
        uint256 tokenAmount = msg.value * rate;
        // 売り手に十分なトークンがあるか確認
        require(token.balanceOf(owner) >= tokenAmount, "Seller does not have enough tokens");
        // 売り手から購入者へのトークン送信
        require(token.transferFrom(owner, msg.sender, tokenAmount), "Token transfer failed");
    }
    // 売り手(所有者)がETHを引き出すための関数
    function withdrawETH() public {
        require(msg.sender == owner, "Only owner can withdraw");
        payable(owner).transfer(address(this).balance);
    }
    // コントラクトの残高を確認する関数
    function getBalance() public view returns (uint256) {
        return address(this).balance;
    }
}


```

* コンパイル

```bash
npx hardhat compile
```


### hardhat ignition によるデプロイモジュールの作成

```bash
nano ignition/modules/JPYFaucet.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

const JPYcoin = "0x5fbdb2315678afecb367f032d93f642f64180aa3"

module.exports = buildModule("JPYFaucet", (m) => {
  const JPYFaucet = m.contract("JPYFaucet", [JPYcoin, 1000]);
  return { JPYFaucet };
});

```

### ローカルノードへのデプロイ

```bash
npx hardhat ignition deploy ignition/modules/JPYFaucet.js --network localhost

=>
Mined block #50
  Block: 0x277ca31e023da108c95774d21e7bff0a858eb6291e2fa3b0884af62097ae0dab
    Base fee: 1271687
    Transaction:           0x0c072e73b1668c603f58804c4c922bfbc96b1aa04ecb83edf9dbbfc433f14b35
      Contract deployment: <UnrecognizedContract>
      Contract address:    0xe7f1725e7734ce288f8367e1bb143e90bb3f0512
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            597738 of 597738
```

### コンソールからの操作

* ERC20コントラクトとトークン購入コントラクトのインスタンスとの接続

```js
> const JPYcoin = "0x5fbdb2315678afecb367f032d93f642f64180aa3"
> const JPYcoinFactory = await ethers.getContractFactory("JPYcoin")
> const JPQ = await JPYcoinFactory.attach(JPYcoin)

> const JPYFaucet = "0xe7f1725e7734ce288f8367e1bb143e90bb3f0512"
> const JPYFaucetFactory = await ethers.getContractFactory("JPYFaucet")
> const JPYF = await JPYFaucetFactory.attach(JPYFaucet)
```

* ERC20コントラクトからトークン購入コントラクトに対して代理送金を許可する（100000トークンまで）

```js
> await JPQ.approve(JPYFaucet,100000);

=>
ContractTransactionResponse {
  provider: HardhatEthersProvider {
    _hardhatProvider: LazyInitializationProviderAdapter {
...
}
```

* テスト用アドレス

```js
> const [owner, addr1, addr2] = await ethers.getSigners();
```

* トークン購入 (ETH を 10000 wei) 送金

```js
> await JPYF.buyTokens({value: 10000})

=>
ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
}
```