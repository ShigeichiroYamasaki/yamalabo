# 5. ERC20 ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆã¨åˆ©ç”¨

OpenZeppelin ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ãŸ ERC20ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡¦ç†ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ

æœ€çµ‚æ›´æ–° 2024/11/05  Shigeichiro Yamasaki

## ERC-20ã®ä»•æ§˜

[ERC-20: Token Standard](https://eips.ethereum.org/EIPS/eip-20)

### ERC-20 ã®ãƒ¡ã‚½ãƒƒãƒ‰

* name 
  * ãƒˆãƒ¼ã‚¯ãƒ³ã®åå‰ã‚’è¿”ã™
  * `function name() public view returns (string)`
* symbol
  * ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚·ãƒ³ãƒœãƒ«ã‚’è¿”ã™
  * `function symbol() public view returns (string)`
* decimals
  * ãƒˆãƒ¼ã‚¯ãƒ³ãŒä½¿ç”¨ã™ã‚‹ 10é€²æ•°ã®å°æ•°ç‚¹ä»¥ä¸‹ã®æ¡æ•°ã‚’è¿”ã™
  * `function decimals() public view returns (uint8)`
* totalSupply
  * ãƒˆãƒ¼ã‚¯ãƒ³ã®ç·ä¾›çµ¦é‡ã‚’è¿”ã™
  * `function totalSupply() public view returns (uint256)`
* balanceOf
  * ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰€æœ‰ã—ã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ®‹é«˜ã‚’è¿”ã™
  * `function balanceOf(address _owner) public view returns (uint256 balance)`
* transfer
  * é‡‘é¡ _value ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ _to ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ã‚‹
  * `function transfer(address _to, uint256 _value) public returns (bool success)`
* transferFrom
  * ä»£ç†ã§ _from ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ _to ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã«é‡‘é¡ _value ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ã‚‹
  * `function transferFrom(address _from, address _to, uint256 _value) public returns (bool success)`
* approve
  * _spender ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ _value ã§æŒ‡å®šã—ãŸé‡‘é¡ã¾ã§è¤‡æ•°å›å¼•ãå‡ºã™ã“ã¨ã‚’æ‰¿èªã™ã‚‹
  * `function approve(address _spender, uint256 _value) public returns (bool success)`
* allowance
  * _spender ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ _owner ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ‰€æœ‰è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰å¼•ãå‡ºã—å¯èƒ½ãªæ®‹é«˜ã‚’è¿”ã™
  * `function allowance(address _owner, address _spender) public view returns (uint256 remaining)`

### ERC-20 ã®ã‚¤ãƒ™ãƒ³ãƒˆ

* Transfer
  * ãƒˆãƒ¼ã‚¯ãƒ³ãŒè»¢é€ã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ã•ã‚Œã‚‹ï¼æ–°è¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ãŸã¨ãã«ã¯  _from ã‚¢ãƒ‰ãƒ¬ã‚¹ã« 0x0 ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
  * `event Transfer(address indexed _from, address indexed _to, uint256 _value)`
* Approval
  * approve ãŒæˆåŠŸã—ãŸã¨ãã«ãƒˆãƒªã‚¬ã•ã‚Œã‚‹ï¼
  * `event Approval(address indexed _owner, address indexed _spender, uint256 _value)`

## ERC-20 ãƒˆãƒ¼ã‚¯ãƒ³ã®é€é‡‘ (transfer)

* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ï¼ˆkey,å€¤ï¼‰æ§‹é€ ã§ç®¡ç†ã•ã‚Œã‚‹
  * ä¸»ã‚­ãƒ¼ã¯ï¼Œæ‰€æœ‰è€…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
  * å€¤ã¯ï¼Œæ‰€æœ‰è€…ã”ã¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®æ®‹é«˜
* ãƒˆãƒ¼ã‚¯ãƒ³ã®é€é‡‘ã¯ï¼Œé€é‡‘è€…ã¨å—é ˜è€…ã®ä¿æœ‰æ®‹é«˜ã®æ›´æ–°
  * ETHã®ä¿æœ‰ã¯å½±éŸ¿ã—ãªã„ï¼ˆã‚¬ã‚¹ä»£ã¯å¿…è¦ï¼‰
  
## ERC-20 ã®ä»£ç†é€é‡‘ (approve/tranferFrom)

* ãƒˆãƒ¼ã‚¯ãƒ³ä¿æœ‰è€…ãŒè‡ªåˆ†ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®é€é‡‘æ¨©é™ã‚’åˆ¥ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç§»è­²ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
  * ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®è²©å£²ãªã©ã«åˆ©ç”¨ã•ã‚Œã‚‹
* æ‰¿èª (approve)ã®åˆ©ç”¨ä¾‹
  * ãƒˆãƒ¼ã‚¯ãƒ³ä¿æœ‰è€…ãŒæ‰¿èªè€…ã§
  * ãƒˆãƒ¼ã‚¯ãƒ³è²©å£²ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã®ä»£ç†é€é‡‘ã‚’æ‰¿èªã™ã‚‹
* ä»£ç†é€é‡‘ï¼ˆtranferFromï¼‰ã®ä¾‹
  * ãƒˆãƒ¼ã‚¯ãƒ³è²©å£²ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã« Eth ã§ãƒˆãƒ¼ã‚¯ãƒ³è³¼å…¥é‡‘é¡ãŒå…¥é‡‘ã•ã‚Œã‚‹ã¨
  * ãƒˆãƒ¼ã‚¯ãƒ³è²©å£²ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒè³¼å…¥è€…ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»£ç†é€é‡‘ã™ã‚‹


## OpenZeppelin ã®ERC20 ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

* OpenZeppelin ã®APIã‚µã‚¤ãƒˆ

[https://docs.openzeppelin.com/contracts/4.x/erc20](https://docs.openzeppelin.com/contracts/4.x/erc20)


## hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–

### OSã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

* ubuntu

```bash
sudo apt update
sudo apt upgrade -y
```
* MacOSX

```bash
brew update
brew upgrade
```

## hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸæ§‹æˆ

* ERC20 ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

```bash
cd ~/hardhat
mkdir erc20
cd erc20
```

* node.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ã¨ hardhat ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸè¨­å®š
npm init
// hardhat ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install --save-dev hardhat
```

###  hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–


```bash
npx hardhat init

888    888                      888 888               888
888    888                      888 888               888
888    888                      888 888               888
8888888888  8888b.  888d888 .d88888 88888b.   8888b.  888888
888    888     "88b 888P"  d88" 888 888 "88b     "88b 888
888    888 .d888888 888    888  888 888  888 .d888888 888
888    888 888  888 888    Y88b 888 888  888 888  888 Y88b.
888    888 "Y888888 888     "Y88888 888  888 "Y888888  "Y888

ğŸ‘· Welcome to Hardhat v2.22.15 ğŸ‘·â€

? What do you want to do? â€¦ 
â¯ Create a JavaScript project
  Create a TypeScript project
  Create a TypeScript project (with Viem)
  Create an empty hardhat.config.js
  Quit
```

* â–¶ Create a JavaScript project ã‚’é¸æŠï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®çŸ¢å°ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ï¼‰


```bash
âœ” What do you want to do? Â· Create a JavaScript project
âœ” Hardhat project root: Â· /Users/shigeichiroyamasaki/hardhat/erc20
âœ” Do you want to add a .gitignore? (Y/n) Â· y
âœ” Do you want to install this sample project's dependencies with npm (@nomicfoundation/hardhat-toolbox)? (Y/n) Â· y


npm install --save-dev "@nomicfoundation/hardhat-toolbox@^5.0.0"

...
```

* ç”Ÿæˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª

```bash
tree -L 1
.
â”œâ”€â”€ README.md
â”œâ”€â”€ contracts
â”œâ”€â”€ hardhat.config.js
â”œâ”€â”€ ignition
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â””â”€â”€ test
```

* ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‰Šé™¤

hardhat ãŒè‡ªå‹•çš„ã«ä½œæˆã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å‰Šé™¤ã™ã‚‹

```bash
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## hardhat ã¸ã®OpenZeppelin ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¦ã¸ã®OpenZeppelinã‚³ãƒ³ãƒˆã‚¿ã‚¯ãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install  --save-dev @openzeppelin/contracts
```

## ERC-20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ

* ã“ã“ã§ã¯ï¼Œä»®ã«ãƒˆãƒ¼ã‚¯ãƒ³å JPQ ã¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆåã‚’ JPYcoin ã¨ã—ã¾ã™ãŒï¼Œå¥½ããªåå‰ã«ã—ã¦ãã ã•ã„

```bash
nano contracts/JPYcoin.sol
```

ã“ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯ã€nameã€symbolã€initialSupplyï¼ˆåˆæœŸä¾›çµ¦é‡ï¼‰ã‚’å¼•æ•°ã«å–ã‚Šã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®å…¨é‡ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒŸãƒ³ãƒˆã—ã¾ã™ã€‚

* ä»¥ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯ï¼ŒOpenZeppelin ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ï¼

[https://docs.openzeppelin.com/contracts/4.x/erc20](https://docs.openzeppelin.com/contracts/4.x/erc20)

* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ç¶™æ‰¿ã¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®é–“æ¥çš„åˆæœŸåŒ–

  * OpenZeppelin ã® ERC20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ç¶™æ‰¿ã—ã¦å­ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™ï¼
  * ã“ã®å­ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã¯è¦ªã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®åˆæœŸåŒ–ã‚‚å¿…è¦ã«ãªã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract JPYcoin is ERC20 {
  // ERC20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å¼•æ•° (name, symbol,decimals)
    constructor(uint256 initialSupply) ERC20("JPYcoin", "JPQ") {
        _mint(msg.sender, initialSupply);
    }
}

```

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile

=>
Compiled 6 Solidity files successfully (evm target: paris).
```

* ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã®ç¢ºèª

```bash
tree artifacts -L 3

artifacts
â”œâ”€â”€ @openzeppelin
â”‚Â Â  â””â”€â”€ contracts
â”‚Â Â      â”œâ”€â”€ interfaces
â”‚Â Â      â”œâ”€â”€ token
â”‚Â Â      â””â”€â”€ utils
â”œâ”€â”€ build-info
â”‚Â Â  â””â”€â”€ 7d27c41fc48e3990cc6a895cbc040705.json
â””â”€â”€ contracts
    â””â”€â”€ JPYcoin.sol
        â”œâ”€â”€ JPYcoin.dbg.json
        â””â”€â”€ JPYcoin.json

9 directories, 3 files
```

## hardhat node ã®èµ·å‹•


* æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’èµ·å‹•ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•

```bash
cd ~/hardhat/erc20
```

### hardhatè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« hardhat.config.js ã®ä¿®æ­£

* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ hardhat networkã«ã™ã‚‹
* ãƒã‚§ã‚¤ãƒ³IDã‚’ 31337
* ãƒã‚¤ãƒ‹ãƒ³ã‚°ã®é–“éš”ã‚’10ç§’ã«è¨­å®š

```bash
nano hardhat.config.js
```

```js
require("@nomicfoundation/hardhat-toolbox");

/** @type import('hardhat/config').HardhatUserConfig */
module.exports = {
  solidity: "0.8.27",
  networks: {
    hardhat: {
      chainId: 31337,
      mining: {
        auto: false,
        interval: [10000, 11000]
      }
    },
  },
};
```

### Ethereum ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã®èµ·å‹•

* hardhat ãƒãƒ¼ãƒ‰ã®èµ·å‹•

```bash
npx hardhat node
```

### hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

* åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®æ“ä½œ
* scripts ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
* deploy ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ


```bash
nano ignition/modules/JPYcoin.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("JPYcoin", (m) => {
  const contract = m.contract("JPYcoin", [10**11]);
  return { contract };
});
```


### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npx hardhat ignition deploy ignition/modules/JPYcoin.js --network localhost

=>
Deploying [ JPYcoin ]

Batch #1
  Executed JPYcoin#JPYcoin

[ JPYcoin ] successfully deployed ğŸš€

Deployed Addresses

JPYcoin#JPYcoin - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

* ãƒ­ã‚°ã®ç¢ºèª

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹

```js
  Block: 0xc4de5fb0b9eb04e006170373dd7e400a9f4390d0953bfa3e7dab7cd76f715adf
    Base fee: 31060570
    Transaction:           0x282402d1d277ae6f84eec40e4969079009ebd534653bf040b23944659ed13723
      Contract deployment: JPYcoin
      Contract address:    0x5fbdb2315678afecb367f032d93f642f64180aa3
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            965817 of 965817
```
## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•

```bash
npx hardhat console --network localhost 
```

### ERC20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ“ä½œ

```js
> const JPYcoin = "0x5fbdb2315678afecb367f032d93f642f64180aa3"

> const JPYcoinFactory = await ethers.getContractFactory("JPYcoin")

// å½“è©²ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«æ¥ç¶šã™ã‚‹
> const JPQ = await JPYcoinFactory.attach(JPYcoin)

// EOAã®ã‚¢ãƒ‰ãƒ¬ã‚¹
> const [owner, addr1, addr2] = await ethers.getSigners();

// ãƒˆãƒ¼ã‚¯ãƒ³ã®ç·ä¾›çµ¦é‡
> await JPQ.totalSupply()
100000000000n
// owner ã®ãƒˆãƒ¼ã‚¯ãƒ³ä¿æœ‰é‡
> await JPQ.balanceOf(owner)
100000000000n
> await JPQ.name()
'JPYcoin'
> await JPQ.symbol()
'JPQ'
> await JPQ.decimals()
18n
```

* ãƒˆãƒ¼ã‚¯ãƒ³ã®é€ä»˜

```js
> await JPQ.transfer(addr1,8000000)
```

* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ä¿æœ‰æ®‹é«˜ã®ç¢ºèª

```js
> await JPQ.balanceOf(owner)
99992000000n

> await JPQ.balanceOf(addr1)
8000000n
```

* addr1 ã«ãƒˆãƒ¼ã‚¯ãƒ³é€é‡‘ã‚’æ‰¿èªã™ã‚‹

```js
> await JPQ.approve(addr1,1000)

ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
}
```

* addr1 ã«æ‰¿èªã•ã‚ŒãŸ owner ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®å¼•ãå‡ºã—å¯èƒ½é‡‘é¡

```js
> await JPQ.allowance(owner, addr1)
1000n
```

* addr1 ãŒ owner ã®ä»£ç†ã§ addr2 ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€é‡‘ã™ã‚‹

```js
> await JPQ.transferFrom(addr1,addr2,100)

ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
}
```

## ãƒ¡ã‚¿ãƒã‚¹ã‚¯

### ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

* `ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ`
* ç§˜å¯†éµã‚’å…¥åŠ›

### ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

* `+ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ` ã‚’ã‚¯ãƒªãƒƒã‚¯
* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
* ãƒˆãƒ¼ã‚¯ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

## Payable: Eth ã§æ”¯æ‰•ã„å¯èƒ½ãªã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ

1. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒ Eth ã‚’å—å–å¯èƒ½ã«ã™ã‚‹
2. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒæ‰€æœ‰ã™ã‚‹ Eth ã‚’å¼•ãå‡ºã—å¯èƒ½ã«ã™ã‚‹
 
### ä½œæˆ

* æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œ
* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•

```bash
cd ~/hardhat/erc20
```

### ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰

```bash
nano contracts/EthWallet.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EthWallet {
    address public owner;

    constructor() {
        owner = msg.sender; // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰€æœ‰è€…ã¨ã—ã¦è¨­å®š
    }

    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ETHã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®é–¢æ•°
    receive() external payable {
        // å—ã‘å–ã£ãŸETHã¯è‡ªå‹•çš„ã«ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ®‹é«˜ã«åŠ ç®—ã•ã‚Œã¾ã™
    }

    // æ‰€æœ‰è€…ã®ã¿ãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ETHã‚’å¼•ãå‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹é–¢æ•°
    function withdraw(uint256 amount) public {
        require(msg.sender == owner, "Only owner can withdraw");
        require(amount <= address(this).balance, "Insufficient balance");

        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰æŒ‡å®šã—ãŸé‡ã®ETHã‚’æ‰€æœ‰è€…ã«è»¢é€
        payable(owner).transfer(amount);
    }

    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ®‹é«˜ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
    function getBalance() public view returns (uint256) {
        return address(this).balance;
    }
}
```


### hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

```bash
nano ignition/modules/EthWallet.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("EthWallet", (m) => {
  const contract = m.contract("EthWallet", []);
  return { contract };
});
```

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npx hardhat ignition deploy ignition/modules/EthWallet.js --network localhost

=>
Batch #1
  Executed EthWallet#EthWallet

[ EthWallet ] successfully deployed ğŸš€

Deployed Addresses

JPYcoin#JPYcoin - 0x5FbDB2315678afecb367f032d93F642f64180aa3
EthWallet#EthWallet - 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
```

* ãƒ­ã‚°ã®ç¢ºèª

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹

```js
Mined block #4325
  Block: 0x588516f8eb933be9039f0e72b9f12b9aa5d722626d39f35231a1c3dceae58a01
    Base fee: 7
    Transaction:           0xf448d80102f4a75b6dad6cb0e7a3527f4d1f99f3196c1badbe93b8330ff198cb
      Contract deployment: EthWallet
      Contract address:    0xe7f1725e7734ce288f8367e1bb143e90bb3f0512
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            308401 of 308401
```

### ãƒ¡ã‚¿ãƒã‚¹ã‚¯ã§ EthWallet ã¸ Eth ã‚’é€é‡‘

* ãƒ¡ã‚¿ãƒã‚¹ã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã«æ¥ç¶šï¼‰ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ®‹é«˜ã‚’ç¢ºèª
* EthWallet ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å®›å…ˆã«ã—ã¦ 1 Eth ç¨‹åº¦é€é‡‘ã™ã‚‹
* ã€Œé€é‡‘ã€å¾Œã€Œç¢ºèªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Œäº†ã‚’å¾…ã¤

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

```js
> const EthWallet = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
undefined
> const EthWalletFactory = await ethers.getContractFactory("EthWallet")
undefined
> const EW =  await EthWalletFactory.attach(EthWallet)
undefined

// EthWallet ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä¿æœ‰æ®‹é«˜ã‚’è¡¨ç¤ºã™ã‚‹
> await EW.getBalance()
1000000000000000000n

> const [owner, addr1, addr2] = await ethers.getSigners();

// ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ‰€æŒé‡‘ã‚’å¼•ãå‡ºã™
> await EW.withdraw(100)

ContractTransactionResponse {
  provider: HardhatEthersProvider {
    _hardhatProvider: LazyInitializationProviderAdapter {

...
}

> await EW.getBalance()
999999999999999900n
```


## Faucet : ERC20ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Eth ã§è³¼å…¥ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ

###  Eth ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è²©å£²ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆæ‰‹é †

1. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒETHã‚’æ”¯æ‰•ã„å¯èƒ½
2. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒæ‰€æœ‰ã™ã‚‹ Eth ã‚’ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ãŒå¼•ãå‡ºã—å¯èƒ½
2. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã‚Šå¯èƒ½
2. ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒæ‰€æœ‰ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ transferFrom é–¢æ•°ã‚’ä½¿ã£ã¦è³¼å…¥è€…ã«é€ã‚‹ã€‚
3. ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã®ãƒ¬ãƒ¼ãƒˆã¯ 1ETH ã‚ãŸã‚Šã®ãƒˆãƒ¼ã‚¯ãƒ³é‡ã¨ã—ã¦æ±ºã‚ã‚‹

### ä½œæˆ

* æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œ
* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•

```bash
cd ~/hardhat/erc20
```

### ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰

```bash
nano contracts/JPYFaucet.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// OpenZeppelinã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract JPYFaucet {
    JPYcoin private token;
    address public owner;
    uint256 public rate; // 1ETH ã‚ãŸã‚Šã®ãƒˆãƒ¼ã‚¯ãƒ³

    constructor(JPYcoin _token, uint256 _rate) {
        token = _token;
        rate = _rate;
        owner = msg.sender; // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰€æœ‰è€…ã¨ã—ã¦è¨­å®š
    }

    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ETHã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®é–¢æ•°
    // ã“ã® ETH ã¯ãƒˆãƒ¼ã‚¯ãƒ³è³¼å…¥ã®ä»£é‡‘ã«ãªã‚‹ã®ã§ï¼ŒETHã‚’å—é ˜ã™ã‚‹ã¨è³¼å…¥è€…ã«JPYãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»£ç†é€é‡‘ã—ã¾ã™
    function buyTokens() public payable {
        require(msg.value > 0, "ETH must be greater than 0");
        // è³¼å…¥ãƒˆãƒ¼ã‚¯ãƒ³é‡ã®è¨ˆç®—
        uint256 tokenAmount = msg.value * rate;
        // å£²ã‚Šæ‰‹ã«ååˆ†ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
        require(token.balanceOf(owner) >= tokenAmount, "Seller does not have enough tokens");
        // å£²ã‚Šæ‰‹ã‹ã‚‰è³¼å…¥è€…ã¸ã®ãƒˆãƒ¼ã‚¯ãƒ³é€ä¿¡
        require(token.transferFrom(owner, msg.sender, tokenAmount), "Token transfer failed");
    }
    // å£²ã‚Šæ‰‹ãŒETHã‚’å¼•ãå‡ºã™ãŸã‚ã®é–¢æ•°
    function withdrawETH() public {
        require(msg.sender == owner, "Only owner can withdraw");
        payable(owner).transfer(address(this).balance);
    }
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ®‹é«˜ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
    function getBalance() public view returns (uint256) {
        return address(this).balance;
    }
}


```

* ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile
```


### hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

```bash
nano ignition/modules/JPYFaucet.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

const JPYcoin = "0x5fbdb2315678afecb367f032d93f642f64180aa3"

module.exports = buildModule("JPYFaucet", (m) => {
  const JPYFaucet = m.contract("JPYFaucet", [JPYcoin, 1000]);
  return { JPYFaucet };
});

```

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npx hardhat ignition deploy ignition/modules/JPYFaucet.js --network localhost

=>
Mined block #50
  Block: 0x277ca31e023da108c95774d21e7bff0a858eb6291e2fa3b0884af62097ae0dab
    Base fee: 1271687
    Transaction:           0x0c072e73b1668c603f58804c4c922bfbc96b1aa04ecb83edf9dbbfc433f14b35
      Contract deployment: <UnrecognizedContract>
      Contract address:    0xe7f1725e7734ce288f8367e1bb143e90bb3f0512
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            597738 of 597738
```
