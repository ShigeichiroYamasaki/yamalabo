# 4. ERC721 ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆã¨åˆ©ç”¨

2024/12/11
Shigeichiro Yamasaki

OpenZeppelin ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ãŸ ERC721 NFTã‚’å‡¦ç†ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ

## ERC-721ã®ä»•æ§˜

[ERC-721:Non-Fungible Token Standard](https://eips.ethereum.org/EIPS/eip-721)

### ERC-721 ã®ã‚¤ãƒ™ãƒ³ãƒˆ

* Transfer
  * NFTã®æ‰€æœ‰ã®ç§»è»¢ãŒç”Ÿã˜ãŸï¼Žæ–°è¦ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¨ãã«ã¯  _from ã‚¢ãƒ‰ãƒ¬ã‚¹ã« 0x0 ãŒã‚»ãƒƒãƒˆã•ã‚Œï¼Œæ¶ˆæ»…ã®ã¨ãã«ã¯ _to ã‚¢ãƒ‰ãƒ¬ã‚¹ã« 0x0 ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹
  * `event Transfer(address indexed _from, address indexed _to, uint256 indexed _tokenId)`
  
* Approval
  * ç‰¹å®šã®NFTã«å¯¾ã™ã‚‹å§”ä»»ãŒç”Ÿã˜ãŸ
  * `event Approval(address indexed _owner, address indexed _approved, uint256 indexed _tokenId);`
* ApprovalForAll
  * æ‰€æœ‰è€…ã®å…¨NFTã«å¯¾ã™ã‚‹å§”ä»»ãŒç”Ÿã˜ãŸ
  * `event ApprovalForAll(address indexed _owner, address indexed _operator, bool _approved);`

### ERC-721 ã®ãƒ¡ã‚½ãƒƒãƒ‰

* balanceOf 
  * æ‰€æœ‰è€…ãŒæŒã¤ã™ã¹ã¦ã®NFTã®æ•°
  * `function balanceOf(address _owner) external view returns (uint256);`
* ownerOf
  * NFTã®æ‰€æœ‰è€…
  * `function ownerOf(uint256 _tokenId) external view returns (address);`
* safeTransferFrom
  * NFTã®å®‰å…¨ãªæ‰€æœ‰ç§»è»¢
  * `function safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes data) external payable;`
  * ` function safeTransferFrom(address _from, address _to, uint256 _tokenId) `
* transferFrom
  * NFTã®æ‰€æœ‰ç§»è»¢
  * `function transferFrom(address _from, address _to, uint256 _tokenId) external payable;`
* approve
  * ç‰¹å®šã®NFTã«å¯¾ã™ã‚‹ç¬¬ä¸‰è€…å§”ä»»
  * `function approve(address _approved, uint256 _tokenId) external payable;`
* setApprovalForAll
  * æ‰€æœ‰ã™ã‚‹å…¨NFTã«å¯¾ã™ã‚‹ç¬¬ä¸‰è€…å§”ä»»
  * `function setApprovalForAll(address _operator, bool _approved) external;`
* getApproved
  * ç‰¹å®šã®NFTã®å§”ä»»å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹
  * `function getApproved(uint256 _tokenId) external view returns (address);`
* isApprovedForAll
  * å…¨NFTã«å¯¾ã™ã‚‹ç¬¬ä¸‰è€…å§”ä»»å…ˆã‹ï¼Ÿ
  * ` function isApprovedForAll(address _owner, address _operator) external view returns (bool);`

### ERC-721 ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

* name
  * NFTã®åç§°
* symbol
  * NFTã®ã‚·ãƒ³ãƒœãƒ«
* tokenURI
  * NFTãŒå‚ç…§ã™ã‚‹è³‡ç”£ã®URI

* ERC-721ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®JSONè¡¨ç¾ã®ä¾‹

```json
{
    "title": "Asset Metadata",
    "type": "object",
    "properties": {
        "name": {
            "type": "string",
            "description": "Identifies the asset to which this NFT represents"
        },
        "description": {
            "type": "string",
            "description": "Describes the asset to which this NFT represents"
        },
        "image": {
            "type": "string",
            "description": "A URI pointing to a resource with mime type image/* representing the asset to which this NFT represents. Consider making any images at a width between 320 and 1080 pixels and aspect ratio between 1.91:1 and 4:5 inclusive."
        }
    }
};

```

## ERC-721 NFT ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€ 

* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ï¼ˆkey,å€¤ï¼‰æ§‹é€ ã§ç®¡ç†ã•ã‚Œã‚‹
  * ä¸»ã‚­ãƒ¼ã¯ï¼Œãƒˆãƒ¼ã‚¯ãƒ³ID
  * å€¤ã¯ï¼Œæ‰€æœ‰è€…ã‚¢ãƒ‰ãƒ¬ã‚¹
* ãƒˆãƒ¼ã‚¯ãƒ³ã®é€é‡‘ã¯ï¼Œé€é‡‘è€…ã¨å—é ˜è€…ã®ä¿æœ‰æ®‹é«˜ã®æ›´æ–°

## ERC-721 NFTã®è»¢é€ (transfer)

* transferFrom
  * æŒ‡å®šã—ãŸ token ID ã®æ‰€æœ‰è€…ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’to ã«æ›¸ãæ›ãˆã‚‹
  * æ‰€æœ‰è€…ï¼å§”ä»»è€…ã§ãªã‘ã‚Œã°æ›¸ãæ›ãˆã¯è¡Œãˆãªã„
* safetransferFrom
  * æŒ‡å®šã—ãŸ token ID ã®æ‰€æœ‰è€…ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’toã«æ›¸ãæ›ãˆã‚‹
  * to ãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¨ã IERC721Receiver ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã¤ã„ã¦ã¯ [08. interface](./08.%20interface.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼‰
  * æ‰€æœ‰è€…ï¼å§”ä»»è€…ã§ãªã‘ã‚Œã°è»¢é€ã¯è¡Œãˆãªã„


## ERC-721 NFTã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã®å§”ä»» (approve/setApprovalForAll)

NFT ã‚’ãƒžãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ãƒ¼ã‚¹ãªã©ã«é è¨—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼Žã‚¹ãƒžãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ã‚ˆã‚‹NFTã®è²©å£²ãªã©ã«åˆ©ç”¨ã•ã‚Œã‚‹
  
* approve
  * æ‰€æœ‰ã™ã‚‹ç‰¹å®šã®NFTã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã®å§”ä»»
* setApprovalForAll 
  * è‡ªåˆ†ãŒæ‰€æœ‰ã™ã‚‹å…¨NFTã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã®å§”ä»»


## OpenZeppelin ã®ERC721 ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

* OpenZeppelin ã®APIã‚µã‚¤ãƒˆ

[https://docs.openzeppelin.com/contracts/4.x/erc721](https://docs.openzeppelin.com/contracts/4.x/erc721)


## hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```bash
cd ~/hardhat
mkdir erc721
cd erc721
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

//  Create a JavaScript project ã‚’é¸æŠž
```
```bash
// æ¶ˆã•ãªãã¦ã‚‚å®Ÿå®³ã¯ç„¡ã„ãŒæ¶ˆã—ã¦ãŠã
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## OpenZeppelinã® ERC721 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

* OpenZeppelin ã® ERC721 ãªã©ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¾ã™

```bash
yarn add --dev @openzeppelin/contracts
```

## ERC721 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ

* ã“ã“ã§ã¯ï¼Œä»®ã«ãƒˆãƒ¼ã‚¯ãƒ³å MFT ã¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆåã‚’ MusicNFT ã¨ã—ã¾ã™ï¼Ž
* éŸ³æ¥½ã®éŸ³æºãƒ‡ãƒ¼ã‚¿ã‚’NFTã¨ã—ã¦ç®¡ç†ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™

### NFTã®å±žæ€§

* Mintableï¼šéŸ³æº NFT ã‚’ç”Ÿæˆã§ãã‚‹
* NFTã®æ‰€æœ‰è€…ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å‚™ãˆã¾ã™
* URIã§å‚ç…§ã™ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§éŸ³æºãƒ‡ãƒ¼ã‚¿ã®å®Ÿä½“ã‚’ç®¡ç†ã—ã¾ã™

```bash
nano contracts/MusicNFT.sol
```

* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆåï¼šMusicNFT
* 

```js
// SPDX-License-Identifier: MIT
// Compatible with OpenZeppelin Contracts ^5.0.0
pragma solidity ^0.8.22;

import {ERC721} from "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import {ERC721URIStorage} from "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";

contract MusicNFT is ERC721, ERC721URIStorage, Ownable {
    uint256 private _nextTokenId;

    constructor(address initialOwner)
        ERC721("MusicNFT", "MFT")
        Ownable(initialOwner)
    {}

    function _baseURI() internal pure override returns (string memory) {
        return "https://music.example/";
    }

    function safeMint(address to, string memory uri) public onlyOwner {
        uint256 tokenId = _nextTokenId++;
        _safeMint(to, tokenId);
        _setTokenURI(tokenId, uri);
    }

    // The following functions are overrides required by Solidity.

    function tokenURI(uint256 tokenId)
        public
        view
        override(ERC721, ERC721URIStorage)
        returns (string memory)
    {
        return super.tokenURI(tokenId);
    }

    function supportsInterface(bytes4 interfaceId)
        public
        view
        override(ERC721, ERC721URIStorage)
        returns (bool)
    {
        return super.supportsInterface(interfaceId);
    }
}
```

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile
```

## ãƒ†ã‚¹ãƒˆã®ä½œæˆ

```bash
nano test/MusicNFT.js
```

```js
// hardhat tool box ã®åˆ©ç”¨
const {loadFixture} = require("@nomicfoundation/hardhat-toolbox/network-helpers");
// CHaiã®åˆ©ç”¨
const { expect } = require("chai");

describe("MusicNFTã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ", function () {
  async function deployMusicNFTFixture() {
    // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å–å¾—
    const [owner, addr1, addr2] = await ethers.getSigners();
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
    const MusicNFT = await ethers.deployContract("MusicNFT",[owner]);
    // MusicNFTãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
    return {MusicNFT, owner, addr1, addr2};
  }
  it("éŸ³æ¥½å®¶ addr1 ã®éŸ³æº music1 ã® MusicNFTã®ç”Ÿæˆ", async function () {
    // MusicNFTãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
    const {MusicNFT, owner, addr1, addr2} = await loadFixture(deployMusicNFTFixture);
    let uri1 = "https://music.example/music1.json";
    await MusicNFT.safeMint(addr1.address, uri1);
    expect(await MusicNFT.balanceOf(owner)).to.equal(0);
  });
});

```

### testã®å®Ÿè¡Œ

```bash
npx hardhat test 


  MusicNFTã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
    âœ” éŸ³æ¥½å®¶ addr1 ã®éŸ³æº MusicNFTã®ç”Ÿæˆ (425ms)


  1 passing (426ms)
```

## hardhat node ã®èµ·å‹•

```bash
npx hardhat node
```


## hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

* åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®æ“ä½œ

```bash
cd ~/hardhat/erc721
```

* deploy ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ


```bash
nano ignition/modules/MusicNFT.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å MusicNFT
module.exports = buildModule("MusicNFT", (m) => {
  const owner = "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266";
  // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå MusicNFT
  const contract = m.contract("MusicNFT", [owner]);
  return { contract };
});
```


### ãƒ­ãƒ¼ã‚«ãƒ«ãƒŽãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npx hardhat ignition deploy ignition/modules/MusicNFT.js --network localhost

=>
Hardhat Ignition ðŸš€

Deploying [ MusicNFT ]

Batch #1
  Executed MusicNFT#MusicNFT

[ MusicNFT ] successfully deployed ðŸš€

Deployed Addresses

MusicNFT#MusicNFT - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•

```bash
npx hardhat console --network localhost 
```

### ERC20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ“ä½œ

```js
> const MusicNFT_addr = "0x5FbDB2315678afecb367f032d93F642f64180aa3"
> const MusicNFT_Factory = await ethers.getContractFactory("MusicNFT")
> const MusicNFT = await MusicNFT_Factory.attach(MusicNFT_addr)

// ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
> const [owner, addr1, addr2] = await ethers.getSigners();
// æ–°ã—ã„éŸ³æºNFTã®æŽ¡æŽ˜
> await MusicNFT.safeMint(addr1, "https://music.example/music1.json")
// ID 1 ã®æ‰€æœ‰è€…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
> await MusicNFT.ownerOf(0)
=>
'0x70997970C51812dc3A010C7d01b50e0d17dc79C8'
// ID 1 ã®ãƒˆãƒ¼ã‚¯ãƒ³URI
> await MusicNFT.tokenURI(0)
=>
'https://music.example/https://music.example/music1.json'
```
