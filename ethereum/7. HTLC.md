# 7. ethereum でのHTLC

2024/11/26
Shigeichiro Yamasaki

## HTLC

* 受領者(receiver) は，ハッシュ値の_preimage を提示すれば資金を受け取れる
* 送金者(sender) は，timelock 時刻以降ならば，資金を回収できる

## hardhat プロジェクトの作成

```bash
cd ~/hardhat
mkdir htlc
cd htlc
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

// 消さなくても実害は無いが消しておく
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## Solidity プログラム

HTLCの solidity プログラム

* 受領者(receiver) は，ハッシュ値の _preimage を提示すれば資金を受け取れる
* 送金者(sender) は，timelock 時刻以降ならば，資金を回収できる
* amount は，デポジット資金
* hashlock は，sha256 ハッシュ値
* _preimage は，hashlock の原像
* timelock は，ロック時間
* withdraw(bytes32 _preimage) 関数は，receiver が _preimage を示してデポジット資金を受領する
* refund() 関数は，ロック時間経過後，senderが資金を回収する

```bash
nano contracts/htlc.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract HTLC {
    address payable public sender;
    address payable public receiver;
    uint256 public amount;
    bytes32 public hashlock;
    uint256 public timelock;
    bool public isWithdrawn;
// コンストラクタで受領者と送金者を確定し，ハッシュ値と時間で資金をデポジットする
    constructor(address payable _receiver,bytes32 _hashlock, uint256 _timelock) payable {
        sender = payable(msg.sender);
        receiver = _receiver;
        amount = msg.value;
        hashlock = _hashlock;
        timelock = _timelock;
        isWithdrawn = false;  // 引き出し済でない
    }
    // receiver が _preimage を示してデポジット資金を受領する
    function withdraw(bytes32 _preimage) public {
        require(msg.sender == receiver, "Only receiver can withdraw");
        require(!isWithdrawn, "Already withdrawn");
        require(sha256(abi.encodePacked(_preimage)) == hashlock, "Invalid preimage");
        isWithdrawn = true; // 引き出し済状態にする
        receiver.transfer(amount);
    }
    // ロック時間経過後，senderが資金を回収する
    function refund() public {
        require(msg.sender == sender, "Only sender can refund");
        require(!isWithdrawn, "Already withdrawn");
        require(block.timestamp >= timelock, "Timelock has not expired");
        isWithdrawn = true;  // 引き出し済状態にする
        sender.transfer(amount);
    }
}
```

###  コンパイル

```bash
npx hardhat compile
```

## hardhat network の起動

```bash
npx hardhat node
```

### hardhat ignition によるデプロイモジュールの作成

* 別のターミナルのプロジェクトルートからの操作

```bash
cd ~/hardhat/htlc
```

* deploy スクリプトを作成


```bash
nano ignition/modules/htlc.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

// モジュール名 HTLC
module.exports = buildModule("HTLC", (m) => {
  // 受領者アドレス
  const receiver = "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC";
  // プリイメージ "secret" のハッシュ値
  const hashlock = ethers.sha256(ethers.toUtf8Bytes("secret"));
  // ロック時間を10分にする
  const unlockTime = Math.floor(Date.now() / 1000) + 600;
  // コントラクト名 HTLC
  const contract = m.contract("HTLC", [receiver, hashlock, unlockTime]);
  return { contract };
});
```


### ローカルノードへのデプロイ

```bash
npx hardhat ignition deploy ignition/modules/htlc.js --network localhost

=>
Deploying [ MusicNFT ]

Batch #1
  Executed MusicNFT#MusicNFT

[ MusicNFT ] successfully deployed 🚀

Deployed Addresses

MusicNFT#MusicNFT - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

## コンソールからの操作

### コンソールの起動

```bash
npx hardhat console --network localhost 
```






















## Hardhat Ignition

#### hardhat Ignition モジュール プラグインのインストール

プロジェクトルートで実行

```bash
npm install --save-dev @nomicfoundation/hardhat-ignition-ethers
```

### hardhat Ignition モジュールの作成

`./ignition/modules` ディレクトリの `Lock.js` を `HTLC.js` に変更します

```bash
mv ignition/module/Lock.js ignition/module/HTLC.js
```

ファイルを編集します

```bash
nano ignition/modules/HTLC.js
```

```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("HTLCModule", (m) => {
  // 受領者アドレス
  const [sender, receiver] = await ethers.getSigners();
  // ロック時間を１時間にする
  const unlockTime = Math.floor(Date.now() / 1000) + 3600;
  // プリイメージのハッシュ
  const hashlock = ethers.sha256(ethers.toUtf8Bytes("secret"));
  // HTLCコントラクト
  const htlc = m.contract("HTLC", [receiver.address, hashlock, unlockTime], {});
  return { htlc };}
 );



```

##  Hardhat Network へのデプロイ

ignition コマンドでデプロイすることができます．

デプロイした結果，デプロイしたスマートコントラクトのコントラクトアカウントのアドレスが返ってきます

```bash
npx hardhat ignition deploy ./ignition/modules/HTLC.js --network localhost

=>
Hardhat Ignition 🚀

Deploying [ HTLCModule ]

Batch #1
  Executed HTLCModule#HTLC

[ HTLCModule ] successfully deployed 🚀

Deployed Addresses

HTLCModule#HTLC - 0x5FbDB2315678afecb367f032d93F642f64180aa3

```


## コンソールの起動

```bash
npx hardhat console --network localhost 
```
