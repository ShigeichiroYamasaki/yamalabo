# 7. ethereum ã§ã®HTLC

2024/11/26
Shigeichiro Yamasaki

## HTLC

* å—é ˜è€…(receiver) ã¯ï¼Œãƒãƒƒã‚·ãƒ¥å€¤ã®_preimage ã‚’æç¤ºã™ã‚Œã°è³‡é‡‘ã‚’å—ã‘å–ã‚Œã‚‹
* é€é‡‘è€…(sender) ã¯ï¼Œtimelock æ™‚åˆ»ä»¥é™ãªã‚‰ã°ï¼Œè³‡é‡‘ã‚’å›åã§ãã‚‹

## hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```bash
cd ~/hardhat
mkdir htlc
cd htlc
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

// æ¶ˆã•ãªãã¦ã‚‚å®Ÿå®³ã¯ç„¡ã„ãŒæ¶ˆã—ã¦ãŠã
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## Solidity ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

HTLCã® solidity ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

* å—é ˜è€…(receiver) ã¯ï¼Œãƒãƒƒã‚·ãƒ¥å€¤ã® _preimage ã‚’æç¤ºã™ã‚Œã°è³‡é‡‘ã‚’å—ã‘å–ã‚Œã‚‹
* é€é‡‘è€…(sender) ã¯ï¼Œtimelock æ™‚åˆ»ä»¥é™ãªã‚‰ã°ï¼Œè³‡é‡‘ã‚’å›åã§ãã‚‹
* amount ã¯ï¼Œãƒ‡ãƒã‚¸ãƒƒãƒˆè³‡é‡‘
* hashlock ã¯ï¼Œsha256 ãƒãƒƒã‚·ãƒ¥å€¤
* _preimage ã¯ï¼Œhashlock ã®åŸåƒ
* timelock ã¯ï¼Œãƒ­ãƒƒã‚¯æ™‚é–“
* withdraw(bytes32 _preimage) é–¢æ•°ã¯ï¼Œreceiver ãŒ _preimage ã‚’ç¤ºã—ã¦ãƒ‡ãƒã‚¸ãƒƒãƒˆè³‡é‡‘ã‚’å—é ˜ã™ã‚‹
* refund() é–¢æ•°ã¯ï¼Œãƒ­ãƒƒã‚¯æ™‚é–“çµŒéå¾Œï¼ŒsenderãŒè³‡é‡‘ã‚’å›åã™ã‚‹

```bash
nano contracts/htlc.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract HTLC {
    address payable public sender;
    address payable public receiver;
    uint256 public amount;
    bytes32 public hashlock;
    uint256 public timelock;
    bool public isWithdrawn;
// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å—é ˜è€…ã¨é€é‡‘è€…ã‚’ç¢ºå®šã—ï¼Œãƒãƒƒã‚·ãƒ¥å€¤ã¨æ™‚é–“ã§è³‡é‡‘ã‚’ãƒ‡ãƒã‚¸ãƒƒãƒˆã™ã‚‹
    constructor(address payable _receiver,bytes32 _hashlock, uint256 _timelock) payable {
        sender = payable(msg.sender);
        receiver = _receiver;
        amount = msg.value;
        hashlock = _hashlock;
        timelock = _timelock;
        isWithdrawn = false;  // å¼•ãå‡ºã—æ¸ˆã§ãªã„
    }
    // receiver ãŒ _preimage ã‚’ç¤ºã—ã¦ãƒ‡ãƒã‚¸ãƒƒãƒˆè³‡é‡‘ã‚’å—é ˜ã™ã‚‹
    function withdraw(bytes32 _preimage) public {
        require(msg.sender == receiver, "Only receiver can withdraw");
        require(!isWithdrawn, "Already withdrawn");
        require(sha256(abi.encodePacked(_preimage)) == hashlock, "Invalid preimage");
        isWithdrawn = true; // å¼•ãå‡ºã—æ¸ˆçŠ¶æ…‹ã«ã™ã‚‹
        receiver.transfer(amount);
    }
    // ãƒ­ãƒƒã‚¯æ™‚é–“çµŒéå¾Œï¼ŒsenderãŒè³‡é‡‘ã‚’å›åã™ã‚‹
    function refund() public {
        require(msg.sender == sender, "Only sender can refund");
        require(!isWithdrawn, "Already withdrawn");
        require(block.timestamp >= timelock, "Timelock has not expired");
        isWithdrawn = true;  // å¼•ãå‡ºã—æ¸ˆçŠ¶æ…‹ã«ã™ã‚‹
        sender.transfer(amount);
    }
}
```

###  ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile
```

## hardhat network ã®èµ·å‹•

```bash
npx hardhat node
```

### hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

* åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®æ“ä½œ

```bash
cd ~/hardhat/htlc
```

* deploy ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ


```bash
nano ignition/modules/htlc.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å HTLC
module.exports = buildModule("HTLC", (m) => {
  // å—é ˜è€…ã‚¢ãƒ‰ãƒ¬ã‚¹
  const receiver = "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC";
  // ãƒ—ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸ "secret" ã®ãƒãƒƒã‚·ãƒ¥å€¤
  const hashlock = ethers.sha256(ethers.toUtf8Bytes("secret"));
  // ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’10åˆ†ã«ã™ã‚‹
  const unlockTime = Math.floor(Date.now() / 1000) + 600;
  // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå HTLC
  const contract = m.contract("HTLC", [receiver, hashlock, unlockTime]);
  return { contract };
});
```


### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npx hardhat ignition deploy ignition/modules/htlc.js --network localhost

=>
Deploying [ MusicNFT ]

Batch #1
  Executed MusicNFT#MusicNFT

[ MusicNFT ] successfully deployed ğŸš€

Deployed Addresses

MusicNFT#MusicNFT - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•

```bash
npx hardhat console --network localhost 
```






















## Hardhat Ignition

#### hardhat Ignition ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œ

```bash
npm install --save-dev @nomicfoundation/hardhat-ignition-ethers
```

### hardhat Ignition ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`./ignition/modules` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® `Lock.js` ã‚’ `HTLC.js` ã«å¤‰æ›´ã—ã¾ã™

```bash
mv ignition/module/Lock.js ignition/module/HTLC.js
```

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™

```bash
nano ignition/modules/HTLC.js
```

```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("HTLCModule", (m) => {
  // å—é ˜è€…ã‚¢ãƒ‰ãƒ¬ã‚¹
  const [sender, receiver] = await ethers.getSigners();
  // ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’ï¼‘æ™‚é–“ã«ã™ã‚‹
  const unlockTime = Math.floor(Date.now() / 1000) + 3600;
  // ãƒ—ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒƒã‚·ãƒ¥
  const hashlock = ethers.sha256(ethers.toUtf8Bytes("secret"));
  // HTLCã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
  const htlc = m.contract("HTLC", [receiver.address, hashlock, unlockTime], {});
  return { htlc };}
 );



```

##  Hardhat Network ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ignition ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸçµæœï¼Œãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã£ã¦ãã¾ã™

```bash
npx hardhat ignition deploy ./ignition/modules/HTLC.js --network localhost

=>
Hardhat Ignition ğŸš€

Deploying [ HTLCModule ]

Batch #1
  Executed HTLCModule#HTLC

[ HTLCModule ] successfully deployed ğŸš€

Deployed Addresses

HTLCModule#HTLC - 0x5FbDB2315678afecb367f032d93F642f64180aa3

```


## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•

```bash
npx hardhat console --network localhost 
```
