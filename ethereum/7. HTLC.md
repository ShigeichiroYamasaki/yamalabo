# 7. ethereum ã§ã®HTLC

2024/11/26
Shigeichiro Yamasaki

## HTLC

* å—é ˜è€…(receiver) ã¯ï¼Œãƒãƒƒã‚·ãƒ¥å€¤ã®_preimage ã‚’æç¤ºã™ã‚Œã°è³‡é‡‘ã‚’å—ã‘å–ã‚Œã‚‹
* é€é‡‘è€…(sender) ã¯ï¼Œtimelock æ™‚åˆ»ä»¥é™ãªã‚‰ã°ï¼Œè³‡é‡‘ã‚’å›žåŽã§ãã‚‹

## hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```bash
cd ~/hardhat
mkdir htlc
cd htlc
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

// æ¶ˆã•ãªãã¦ã‚‚å®Ÿå®³ã¯ç„¡ã„ãŒæ¶ˆã—ã¦ãŠã
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## Solidity ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

HTLCã® solidity ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

* å—é ˜è€…(receiver) ã¯ï¼Œãƒãƒƒã‚·ãƒ¥å€¤ã® _preimage ã‚’æç¤ºã™ã‚Œã°è³‡é‡‘ã‚’å—ã‘å–ã‚Œã‚‹
* é€é‡‘è€…(sender) ã¯ï¼Œtimelock æ™‚åˆ»ä»¥é™ãªã‚‰ã°ï¼Œè³‡é‡‘ã‚’å›žåŽã§ãã‚‹
* amount ã¯ï¼Œãƒ‡ãƒã‚¸ãƒƒãƒˆè³‡é‡‘
* hashlock ã¯ï¼Œsha256 ãƒãƒƒã‚·ãƒ¥å€¤
* _preimage ã¯ï¼Œhashlock ã®åŽŸåƒ
* timelock ã¯ï¼Œãƒ­ãƒƒã‚¯æ™‚é–“
* withdraw(bytes32 _preimage) é–¢æ•°ã¯ï¼Œreceiver ãŒ _preimage ã‚’ç¤ºã—ã¦ãƒ‡ãƒã‚¸ãƒƒãƒˆè³‡é‡‘ã‚’å—é ˜ã™ã‚‹
* refund() é–¢æ•°ã¯ï¼Œãƒ­ãƒƒã‚¯æ™‚é–“çµŒéŽå¾Œï¼ŒsenderãŒè³‡é‡‘ã‚’å›žåŽã™ã‚‹

```bash
nano contracts/htlc.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract HTLC {
    address payable public sender;
    address payable public receiver;
    uint256 public amount;
    bytes32 public hashlock;
    uint256 public timelock;
    bool public isWithdrawn;
    bool public isRefunded;

    constructor(
        address payable _receiver,
        bytes32 _hashlock,
        uint256 _timelock
    ) payable {
        sender = payable(msg.sender);
        receiver = _receiver;
        amount = msg.value;
        hashlock = _hashlock;
        timelock = _timelock;
        isWithdrawn = false;
        isRefunded = false;
    }
    // receiver ãŒ _preimage ã‚’ç¤ºã—ã¦ãƒ‡ãƒã‚¸ãƒƒãƒˆè³‡é‡‘ã‚’å—é ˜ã™ã‚‹
    function withdraw(bytes32 _preimage) public {
        require(msg.sender == receiver, "Only receiver can withdraw");
        require(!isWithdrawn, "Already withdrawn");
        require(sha256(abi.encodePacked(_preimage)) == hashlock, "Invalid preimage");
        isWithdrawn = true;
        receiver.transfer(amount);
    }
    // ãƒ­ãƒƒã‚¯æ™‚é–“çµŒéŽå¾Œï¼ŒsenderãŒè³‡é‡‘ã‚’å›žåŽã™ã‚‹
    function refund() public {
        require(msg.sender == sender, "Only sender can refund");
        require(!isWithdrawn, "Already withdrawn");
        require(block.timestamp >= timelock, "Timelock has not expired");
        isRefunded = true;
        sender.transfer(amount);
    }
}
```

###  ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile

=>
Compiled 1 Solidity files successfully (evm target: paris).
```

## test ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

```bash
nano test/htlc.js
```

```js
// hardhat tool box ã®åˆ©ç”¨
const {loadFixture} = require("@nomicfoundation/hardhat-toolbox/network-helpers");
// CHaiã®åˆ©ç”¨
const { expect } = require("chai");

describe("HTLCã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ", function () {
  async function deployHtlcFixture() {
    // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å–å¾—
    const [sender, receiver] = await ethers.getSigners();
    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
    const hardhatHTLC = await ethers.deployContract("HTLC");
    // ãƒ†ã‚¹ãƒˆã«æœ‰ç”¨ãªãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
    return { hardhatHTLC, sender, receiver };
  }

  it("HTLCã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹", async function () {
    const hashlock = ethers.sha256(ethers.toUtf8Bytes("secret")); // ãƒ—ãƒ¬ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒƒã‚·ãƒ¥
    const timelock = Math.floor(Date.now() / 1000) + 3600; // 1æ™‚é–“å¾Œã®ã‚¿ã‚¤ãƒ ãƒ­ãƒƒã‚¯
    // ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
    const { hardhatHTLC, sender, receiver } = await loadFixture(deployHtlcFixture);
    // senderã®æ‰€æŒé‡‘é¡
    const senderBalance = await hardhatHTLC.balanceOf(sender.address);
  });

});
```

## hardhat network ã®èµ·å‹•

```bash
npx hardhat node
```

ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯ãã®ã¾ã¾ã«ã—ã¦ãŠãï¼Œåˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥é™ã®ä½œæ¥­ã‚’è¡Œã†ï¼Ž

## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•

```bash
npx hardhat console --network localhost 


=>
Welcome to Node.js v20.16.0.
Type ".help" for more information.
> 
```


### ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
npx hardhat test 
```


## Hardhat Ignition

#### hardhat Ignition ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œ

```bash
npm install --save-dev @nomicfoundation/hardhat-ignition-ethers
```

### hardhat Ignition ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

`./ignition/modules` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® `Lock.js` ã‚’ `HTLC.js` ã«å¤‰æ›´ã—ã¾ã™

```bash
mv ignition/module/Lock.js ignition/module/HTLC.js
```

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™

```bash
nano ignition/modules/HTLC.js
```

```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("HTLCModule", (m) => {
  // å—é ˜è€…ã‚¢ãƒ‰ãƒ¬ã‚¹
  const [receiver] = await ethers.getSigners();
  // ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’ï¼‘æ™‚é–“ã«ã™ã‚‹
  const unlockTime = Math.floor(Date.now() / 1000) + 3600;
  // ãƒ—ãƒªã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒƒã‚·ãƒ¥
  const hashlock = ethers.sha256(ethers.toUtf8Bytes("secret"));
  // HTLCã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
  const htlc = m.contract("HTLC", [receiver, hashlock, unlockTime], {});
  return { htlc };}
 );



```

##  Hardhat Network ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ignition ã‚³ãƒžãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼Ž

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸçµæžœï¼Œãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¹ãƒžãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã£ã¦ãã¾ã™

```bash
npx hardhat ignition deploy ./ignition/modules/HTLC.js --network localhost

=>
Hardhat Ignition ðŸš€

Deploying [ HTLCModule ]

Batch #1
  Executed HTLCModule#HTLC

[ HTLCModule ] successfully deployed ðŸš€

Deployed Addresses

HTLCModule#HTLC - 0x5FbDB2315678afecb367f032d93F642f64180aa3

```


