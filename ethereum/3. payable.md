# 3. Eth を所有可能なコントラクトの作成

2024/11/18
Shigeichiro Yamasaki

## コントラクトアドレスへのEth 送金を可能にする方法

1. コントラクトが ETH を受取可能にする（関数に payable修飾子をつける）
2. 永久にETHを所有したままにしないために，コントラクトが所有する Eth を引き出し可能にしなければならない
 
### コントラクトのコードの作成

* プロジェクトルートに移動して solidity プログラムを作成

```bash
nano contracts/EthWallet.sol
```

* コメントをよく読んでください
  
```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract EthWallet {
    address public owner;

    constructor() {
      // コントラクトをデプロイしたアドレスを所有者として設定
        owner = msg.sender; 
    }

    // コントラクトにETHを送信するための関数
    receive() external payable {
        // 受け取ったETHは自動的にコントラクトの残高に加算されます
    }

    // コントラクトへ ETHを預金する deposit はpayable 関数
    function deposit() public payable {
    }

    // 所有者のみがコントラクトのETHを引き出せるようにする関数
    function withdraw(uint256 amount) public {
        require(msg.sender == owner, "only owner can withdraw");
        require(amount <= address(this).balance, "not enough Eth");
        // コントラクトが所有する ETH から指定した量のETHを所有者に転送
        payable(owner).transfer(amount);
    }

    // コントラクトの残高を確認する関数
    function getBalance() public returns (uint256) {
        return address(this).balance;
    }
}
```

### コントラクトのコンパイル

```bash
npx hardhat compile

=>
Compiled 1 Solidity file successfully (evm target: paris).
```


### hardhat ignition によるデプロイモジュールの作成

```bash
nano ignition/modules/EthWallet.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

module.exports = buildModule("EthWallet", (m) => {
  const contract = m.contract("EthWallet", []);
  return { contract };
});
```

### ローカルノードへのデプロイ

```bash
npx hardhat ignition deploy ignition/modules/EthWallet.js --network localhost

=>
Batch #1
  Executed EthWallet#EthWallet

[ EthWallet ] successfully deployed 🚀

Deployed Addresses

JPYcoin#JPYcoin - 0x5FbDB2315678afecb367f032d93F642f64180aa3
EthWallet#EthWallet - 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
```

* ログの確認

コントラクトアドレスを確認する

```js
Mined block #1
  Block: 0x5fa6ea8f00f6a259c9abc4cf13c54590e3dc8b69a8b57ac6ca90a9ceff2fc2cd
    Base fee: 875000000
    Transaction:           0x25c5989fe41a0cee41a35b49700339a287da041490a29af6514157572de83fd9
      Contract deployment: EthWallet
      Contract address:    0x5fbdb2315678afecb367f032d93f642f64180aa3
      From:                0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
      Value:               0 ETH
      Gas used:            313341 of 313341
```


### コンソールからの操作

```bash
npx hardhat console
```

* コントラクトへの接続

```js
> const EthWallet_addr = "0x5FbDB2315678afecb367f032d93F642f64180aa3"
undefined
> const EthWallet_Factory = await ethers.getContractFactory("EthWallet")
undefined
> const EthWallet =  await EthWallet_Factory.attach(EthWallet_addr)
undefined
```

* テスト用アカウント

```js
> const [owner, addr1, addr2] = await ethers.getSigners();
```

* sendTransaction メソッドを使った ETH の送金

```js
// EthWallet へ ETH を送金する (10000000 wei)
> await owner.sendTransaction({to: EthWallet_addr, value: 10000000})

```

* getBalance 関数

```js
// EthWallet コントラクトの保有残高を表示する
> await EthWallet.getBalance()
10000000n


// コントラクトの所持金を引き出す
> await EthWallet.withdraw(100000)

=>
ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
}

> await EthWallet.getBalance()
9900000n
```

* deposit 関数（payable）を利用したETHの送金

```js
> await EthWallet.deposit({value: 30000});

=>
ContractTransactionResponse {
  provider: HardhatEthersProvider {

...
 }

> await EthWallet.getBalance()
9930000n
```

