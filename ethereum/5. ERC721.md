# 4. ERC721 ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆã¨åˆ©ç”¨

2024/11/26
Shigeichiro Yamasaki

OpenZeppelin ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ãŸ ERC721 NFTã‚’å‡¦ç†ã™ã‚‹ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ

## ERC-721ã®ä»•æ§˜

[ERC-721:Non-Fungible Token Standard](https://eips.ethereum.org/EIPS/eip-721)

### ERC-721 ã®ã‚¤ãƒ™ãƒ³ãƒˆ

* Transfer
  * NFTã®æ‰€æœ‰ã®ç§»è»¢ãŒç”Ÿã˜ãŸï¼Žæ–°è¦ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¨ãã«ã¯  _from ã‚¢ãƒ‰ãƒ¬ã‚¹ã« 0x0 ãŒã‚»ãƒƒãƒˆã•ã‚Œï¼Œæ¶ˆæ»…ã®ã¨ãã«ã¯ _to ã‚¢ãƒ‰ãƒ¬ã‚¹ã« 0x0 ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹
  * `event Transfer(address indexed _from, address indexed _to, uint256 indexed _tokenId)`
  
* Approval
  * ç‰¹å®šã®NFTã«å¯¾ã™ã‚‹å§”ä»»ãŒç”Ÿã˜ãŸ
  * `event Approval(address indexed _owner, address indexed _approved, uint256 indexed _tokenId);`
* ApprovalForAll
  * æ‰€æœ‰è€…ã®å…¨NFTã«å¯¾ã™ã‚‹å§”ä»»ãŒç”Ÿã˜ãŸ
  * `event ApprovalForAll(address indexed _owner, address indexed _operator, bool _approved);`

### ERC-721 ã®ãƒ¡ã‚½ãƒƒãƒ‰

* balanceOf 
  * æ‰€æœ‰è€…ãŒæŒã¤ã™ã¹ã¦ã®NFTã®æ•°
  * `function balanceOf(address _owner) external view returns (uint256);`
* ownerOf
  * NFTã®æ‰€æœ‰è€…
  * `function ownerOf(uint256 _tokenId) external view returns (address);`
* safeTransferFrom
  * NFTã®å®‰å…¨ãªä»£ç†æ‰€æœ‰ç§»è»¢
  * `function safeTransferFrom(address _from, address _to, uint256 _tokenId, bytes data) external payable;`
  * ` function safeTransferFrom(address _from, address _to, uint256 _tokenId) `
* transferFrom
  * NFTã®ä»£ç†æ‰€æœ‰ç§»è»¢
  * `function totalSupply() public view returns (uint256)`
* approve
  * ç‰¹å®šã®NFTã«å¯¾ã™ã‚‹ç¬¬ä¸‰è€…å§”ä»»
  * `function approve(address _approved, uint256 _tokenId) external payable;`
* setApprovalForAll
  * æ‰€æœ‰ã™ã‚‹å…¨NFTã«å¯¾ã™ã‚‹ç¬¬ä¸‰è€…å§”ä»»
  * `function setApprovalForAll(address _operator, bool _approved) external;`
* getApproved
  * ç‰¹å®šã®NFTã®å§”ä»»å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹
  * `function getApproved(uint256 _tokenId) external view returns (address);`
* isApprovedForAll
  * å…¨NFTã«å¯¾ã™ã‚‹ç¬¬ä¸‰è€…å§”ä»»å…ˆã‹ï¼Ÿ
  * ` function isApprovedForAll(address _owner, address _operator) external view returns (bool);`

### ERC-721 ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

* name
  * NFTã®åç§°
* symbol
  * NFTã®ã‚·ãƒ³ãƒœãƒ«
* tokenURI
  * NFTãŒå‚ç…§ã™ã‚‹è³‡ç”£ã®URI

* ERC-721ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®JSONè¡¨ç¾ã®ä¾‹

```json
{
    "title": "Asset Metadata",
    "type": "object",
    "properties": {
        "name": {
            "type": "string",
            "description": "Identifies the asset to which this NFT represents"
        },
        "description": {
            "type": "string",
            "description": "Describes the asset to which this NFT represents"
        },
        "image": {
            "type": "string",
            "description": "A URI pointing to a resource with mime type image/* representing the asset to which this NFT represents. Consider making any images at a width between 320 and 1080 pixels and aspect ratio between 1.91:1 and 4:5 inclusive."
        }
    }
};

```

## ERC-721 NFT ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹é€ 

* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ï¼ˆkey,å€¤ï¼‰æ§‹é€ ã§ç®¡ç†ã•ã‚Œã‚‹
  * ä¸»ã‚­ãƒ¼ã¯ï¼Œãƒˆãƒ¼ã‚¯ãƒ³ID
  * å€¤ã¯ï¼Œæ‰€æœ‰è€…ã‚¢ãƒ‰ãƒ¬ã‚¹
* ãƒˆãƒ¼ã‚¯ãƒ³ã®é€é‡‘ã¯ï¼Œé€é‡‘è€…ã¨å—é ˜è€…ã®ä¿æœ‰æ®‹é«˜ã®æ›´æ–°

## ERC-721 NFTã®é€é‡‘ (transfer)

* transferFrom
  * æŒ‡å®šã—ãŸ token ID ã®æ‰€æœ‰è€…ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’to ã«æ›¸ãæ›ãˆã‚‹
  * æ‰€æœ‰è€…ï¼å§”ä»»è€…ã§ãªã‘ã‚Œã°æ›¸ãæ›ãˆã¯è¡Œãˆãªã„
* safetransferFrom
  * æŒ‡å®šã—ãŸ token ID ã®æ‰€æœ‰è€…ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’toã«æ›¸ãæ›ãˆã‚‹
to ãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¨ãã¯NFTç§»è»¢æ©Ÿèƒ½ã‚’æ¤œæŸ»ã™ã‚‹
æ‰€æœ‰è€…ï¼å§”ä»»è€…ã§ãªã‘ã‚Œã°æ›¸ãæ›ãˆã¯è¡Œãˆãªã„



## ERC-721 NFTã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã®å§”ä»» (approve/setApprovalForAll)

NFT ã‚’ãƒžãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ãƒ¼ã‚¹ãªã©ã«é è¨—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ï¼Žã‚¹ãƒžãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ã‚ˆã‚‹NFTã®è²©å£²ãªã©ã«åˆ©ç”¨ã•ã‚Œã‚‹
  
* approve
  * æ‰€æœ‰ã™ã‚‹ç‰¹å®šã®NFTã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã®å§”ä»»
* setApprovalForAll 
  * è‡ªåˆ†ãŒæ‰€æœ‰ã™ã‚‹å…¨NFTã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã®å§”ä»»


## OpenZeppelin ã®ERC721 ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

* OpenZeppelin ã®APIã‚µã‚¤ãƒˆ

[https://docs.openzeppelin.com/contracts/4.x/erc721](https://docs.openzeppelin.com/contracts/4.x/erc721)


## hardhat ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```bash
cd ~/hardhat
mkdir erc721
cd erc721
```

```bash
yarn init -y
yarn add --dev hardhat
npx hardhat init

// æ¶ˆã•ãªãã¦ã‚‚å®Ÿå®³ã¯ç„¡ã„ãŒæ¶ˆã—ã¦ãŠã
rm contracts/Lock.sol
rm test/Lock.js
rm ignition/modules/Lock.js
```

## OpenZeppelinã® ERC721 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

* OpenZeppelin ã® ERC721 ãªã©ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¾ã™

```bash
yarn add --dev @openzeppelin/contracts
```

## ERC20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ

* ã“ã“ã§ã¯ï¼Œä»®ã«ãƒˆãƒ¼ã‚¯ãƒ³å MFT ã¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆåã‚’ MusicNFT ã¨ã—ã¾ã™ãŒï¼Œå¥½ããªåå‰ã«ã—ã¦ãã ã•ã„

```bash
nano contracts/MusicNFT.sol
```

```js
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {ERC721URIStorage, ERC721} from "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";

contract MusicNFT is ERC721URIStorage {
    uint256 private _nextMusicId;

    constructor() ERC721("MusicNFT", "MFT") {}

    function awardMusic(address musician, string memory musicURI) public returns (uint256) {
        uint256 musicId = _nextMusicId++;
        _mint(musician, musicId);
        _setTokenURI(musicId, musicURI);

        return musicId;
    }
}
```

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

```bash
npx hardhat compile
```

## hardhat node ã®èµ·å‹•

```bash
npx hardhat node
```

## hardhat ignition ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

* åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®æ“ä½œ

```bash
cd ~/hardhat/erc721
```

* deploy ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ


```bash
nano ignition/modules/MusicNFT.js
```


```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å MusicNFT
module.exports = buildModule("MusicNFT", (m) => {
  // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå MusicNFT
  const contract = m.contract("MusicNFT", []);
  return { contract };
});
```


### ãƒ­ãƒ¼ã‚«ãƒ«ãƒŽãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npx hardhat ignition deploy ignition/modules/MusicNFT.js --network localhost

=>
Deploying [ MusicNFT ]

Batch #1
  Executed MusicNFT#MusicNFT

[ MusicNFT ] successfully deployed ðŸš€

Deployed Addresses

MusicNFT#MusicNFT - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•

```bash
npx hardhat console --network localhost 
```

### ERC20 ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ“ä½œ

```js
> const MusicNFT_addr = "0x5FbDB2315678afecb367f032d93F642f64180aa3"
> const MusicNFT_Factory = await ethers.getContractFactory("MusicNFT")
> const MusicNFT = await MusicNFT_Factory.attach(MusicNFT_addr)

// ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
> const [owner, addr1, addr2] = await ethers.getSigners();
// æ–°ã—ã„éŸ³æ¥½NFTã®æŽ¡æŽ˜
> await MusicNFT.awardMusic(owner.address, "https://music.example/music.json")
// ID 1 ã®æ‰€æœ‰è€…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
> await MusicNFT.ownerOf(1)
=>
'0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266'
// ID 1 ã®ãƒˆãƒ¼ã‚¯ãƒ³URI
> await MusicNFT.tokenURI(1)
=>
'https://music.example/music.json'
```
* ABIã®ç¢ºèª

```js
> const {bytecode,abi}=await hre.artifacts.readArtifact('MusicNFT')
> abi
=>
[
  ...
]
```

### ABIã«ã‚ã‚‹é–¢æ•°ã®å®Ÿè¡Œ

* NFTã®æ‰€æœ‰ã®ç§»è»¢

```js
> await MusicNFT.safeTransferFrom(owner.address, addr1.address, 1)

> await MusicNFT.ownerOf(1)
=>
'0x70997970C51812dc3A010C7d01b50e0d17dc79C8'
```

* æ–°ã—ã„NFTã®æŽ¡æŽ˜

```js
> await MusicNFT.awardMusic(addr2.address, "https://music.example/music2.json")
> await MusicNFT.awardMusic(addr2.address, "https://music.example/music3.json")
```

* NFTã®ä¿æœ‰æ•°ã®ç¢ºèª

```js
> await MusicNFT.balanceOf(addr2.address)
=>
2n
```
