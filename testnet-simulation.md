# testnet ネットワーク構造のシミュレーション


## 単純なシミュレーション

nノードに対して43ノードから8ノードずつランダムに接続してみる

```ruby
def test(n)
  nodes=[*1..n]
  o=[*1..43]
  c=o.map{|x|nodes.shuffle[0..7]}
  c.flatten.uniq.size
end

def try(n)
  (1..100).map{test(n)}.sum/100.0
end
```
 
### シミューレーション１
 
 ```
# 実験　100ノードから2000ノード
(1..20).map{|x|try(100*x)}

 => [97.01, 165.64, 206.06, 232.04, 249.05, 262.71, 273.18, 280.41, 286.45, 291.7, 296.26, 300.06, 302.98, 306.58, 308.95, 310.46, 312.5, 314.42, 315.64, 316.84]
 ```

### シミュレーション２

 ```
# 実験　100ノードから2000ノード
(10..200).map{|x|try(10*x)}

=> [97.04, 105.67, 113.63, 121.28, 128.96, 135.51, 142.17, 149.23, 155.12, 160.54, 165.44, 170.53, 175.23, 180.1, 183.28, 189.04, 191.79, 195.6, 199.68, 202.32, 206.56, 208.5, 213.07, 215.44, 217.81, 220.7, 222.7, 224.96, 227.02, 230.06, 232.14, 234.35, 236.31, 237.2, 240.13, 241.68, 243.41, 246.12, 248.49, 248.37, 250.94, 251.55, 252.94, 254.55, 254.64, 256.71, 259.33, 260.29, 261.05, 262.37, 263.33, 264.1, 266.4, 267.09, 267.21, 269.36, 269.47, 270.89, 271.14, 271.53, 272.62, 274.06, 275.38, 275.47, 276.16, 277.63, 277.31, 277.58, 278.51, 279.85, 281.46, 280.92, 282.23, 282.54, 283.02, 284.56, 283.99, 285.56, 286.62, 287.48, 287.36, 285.9, 287.54, 288.72, 289.32, 290.22, 289.83, 291.35, 290.96, 291.9, 292.99, 291.75, 292.87, 293.79, 294.06, 293.93, 294.8, 294.99, 296.18, 295.41, 295.03, 297.11, 297.32, 298.34, 297.84, 298.47, 298.12, 299.66, 299.04, 299.39, 299.62, 299.98, 300.81, 300.2, 301.03, 302.11, 301.75, 301.75, 301.81, 302.77, 302.37, 304.48, 304.82, 304.3, 304.5, 304.87, 304.57, 304.69, 305.35, 305.37, 305.26, 306.92, 306.08, 306.34, 306.55, 305.79, 307.23, 307.54, 307.08, 308.02, 307.05, 308.03, 309.01, 308.87, 309.7, 308.74, 308.63, 310.24, 308.97, 310.4, 310.11, 310.15, 310.42, 310.71, 311.28, 310.88, 311.84, 310.31, 311.56, 312.07, 311.51, 312.2, 312.84, 312.45, 312.82, 313.01, 312.13, 313.42, 312.82, 313.04, 313.98, 313.65, 314.49, 313.37, 314.4, 314.94, 315.37, 314.32, 315.09, 315.11, 314.84, 314.57, 315.81, 315.27, 316.13, 316.19, 315.16, 315.65, 316.02, 315.7, 316.8]
 ```
 

## 実験結果

```ruby
e=[["1.156", "52.78.60.35", "116.203.143.226", "18.224.152.252", "157.13.61.140", "159.65.101.164", "54.38.177.175", "157.13.61.157", "34.87.33.25", "157.13.61.149"], ["157.13.61.147", "52.53.72.136", "185.36.237.188", "43.247.89.19", "193.59.41.11", "46.101.133.8", "82.119.233.36", "206.189.102.208", "162.243.169.247"], ["157.13.61.146", "34.229.185.163", "89.39.107.219", "157.13.61.141", "54.39.181.250", "52.77.209.135", "142.93.64.94", "52.195.5.184", "3.0.150.229"], ["157.13.61.145", "51.15.10.126", "34.229.185.163", "54.202.87.10", "34.87.33.25", "18.140.72.194", "138.201.214.71", "163.172.85.68", "157.13.61.144", "63.141.242.58"], ["157.13.61.144", "141.223.85.141", "108.61.190.74", "178.128.59.107", "54.179.158.195", "92.13.134.33", "165.22.154.165", "198.13.56.21", "103.80.133.42"], ["157.13.61.143", "5.188.62.33", "103.76.36.113", "104.248.8.207", "204.48.29.10", "68.183.231.167", "72.36.89.11", "3.17.246.73", "195.154.221.136"], ["157.13.61.142", "62.210.66.227", "144.76.100.245", "104.237.131.138", "185.106.122.212", "94.130.47.134", "185.153.197.24", "49.50.95.39", "116.203.72.215"], ["157.13.61.141", "92.53.89.123", "35.220.186.22", "3.16.55.121", "113.52.135.100", "51.89.6.57", "141.223.85.149", "195.201.62.76", "212.24.99.208"], ["157.13.61.156", "162.255.136.93", "148.251.8.44", "157.13.61.147", "198.199.124.236", "79.98.159.7", "94.230.153.108", "107.172.253.20", "95.217.67.120"], ["157.13.61.166", "141.223.85.144", "118.25.4.70", "116.203.38.100", "79.205.51.115", "104.218.150.185", "159.69.40.240", "106.10.50.78", "144.76.203.216"], ["157.13.61.165", "139.180.203.53", "66.206.10.35", "192.30.89.15", "64.151.71.52", "5.9.150.112", "199.188.203.190", "54.65.170.135", "206.189.198.136"], ["157.13.61.163", "198.199.125.161", "121.199.59.128", "18.185.58.40", "109.236.91.15", "94.254.2.155", "13.251.47.174", "62.60.210.17", "202.143.111.123"], ["157.13.61.140", "193.35.108.106", "46.101.225.186", "62.16.245.222", "50.208.131.62", "134.209.108.67", "109.236.81.210", "54.65.170.135", "94.130.8.24", "157.13.61.176", "157.13.61.173"], ["157.13.61.157", "47.98.224.31", "142.44.176.163", "157.230.122.246", "52.4.35.0", "54.65.170.135", "64.151.71.52", "144.76.203.216", "51.79.130.84"], ["157.13.61.150", "45.115.178.92", "116.203.38.100", "165.227.30.200", "69.59.18.23", "93.190.142.127", "85.145.238.93", "104.131.26.124", "185.36.237.188"], ["157.13.61.162", "45.204.3.103", "68.183.211.245", "18.204.135.109", "178.63.16.7", "5.9.17.153", "89.46.156.4", "5.188.62.33", "190.85.201.38", "157.13.61.145"], ["157.13.61.167", "193.59.41.11", "103.76.36.113", "52.197.103.92", "13.231.104.6", "204.48.29.10", "190.85.201.38", "81.169.195.32", "169.50.138.170"], ["157.13.61.158", "84.73.100.136", "40.65.118.254", "173.212.239.152", "54.67.76.143", "144.91.83.223", "118.163.122.207", "148.251.191.74", "157.230.239.57"], ["157.13.61.161", "157.230.216.49", "54.37.77.40", "207.246.91.93", "141.223.85.141", "69.197.185.106", "52.78.163.216", "23.254.176.26", "195.201.141.150"], ["157.13.61.159", "157.13.61.153", "5.9.142.219", "66.206.10.163", "99.79.40.250", "185.75.76.62", "74.220.255.190", "116.203.61.61", "144.76.9.101"], ["157.13.61.160", "188.165.235.124", "62.251.54.163", "157.13.61.147", "69.59.18.207", "51.158.170.86", "167.71.203.100", "138.68.253.188", "78.46.41.166"], ["157.13.61.168", "116.203.57.246", "94.75.250.71", "35.228.231.39", "14.98.160.145", "78.47.31.66", "167.99.177.70", "173.212.202.187", "188.166.41.112"], ["157.13.61.170", "190.85.201.38", "142.245.72.12", "198.251.83.19", "178.128.85.252", "111.231.108.46", "185.106.122.212", "116.203.92.131", "46.28.204.21"], ["157.13.61.174", "176.9.71.156", "94.75.250.71", "38.143.66.107", "107.172.253.20", "192.81.210.14", "80.100.203.151", "157.230.251.234", "130.255.187.86"], ["157.13.61.173", "195.201.62.76", "34.242.11.182", "13.231.104.6", "193.70.40.206", "106.10.50.78", "18.191.150.46", "157.13.61.140", "103.80.133.42"], ["157.13.61.175", "104.248.154.26", "69.59.18.207\t", "94.230.153.108", "34.68.60.54", "185.198.56.163", "94.79.55.28", "63.143.32.126", "104.225.218.208"], ["157.13.61.176", "54.202.87.10", "52.221.246.188", "46.101.199.114", "52.231.74.79", "157.13.61.164", "54.197.53.132", "35.195.74.16", "176.223.134.130"], ["157.13.61.172", "62.251.54.163", "13.115.134.109", "52.198.75.194", "116.203.92.131", "89.46.156.4", "88.99.70.24", "89.47.163.26", "202.239.42.192"], ["157.13.61.169", "212.24.99.208", "198.251.83.19", "51.89.6.57", "89.47.163.26", "54.250.226.223", "188.165.228.25", "62.60.210.17", "54.202.87.10"], ["157.13.61.178", "184.74.240.157", "52.213.124.148", "195.201.241.90", "176.9.158.59", "141.223.85.145", "54.218.51.65", "52.77.246.169", "47.104.65.133"], ["157.13.61.179", "159.65.131.43", "176.9.158.59", "72.36.89.11", "46.28.204.21", "173.212.202.187", "184.74.240.157", "93.55.242.131", "45.76.85.12"], ["157.13.61.180", "104.131.26.124", "198.58.102.18", "159.69.40.240", "27.255.83.134", "116.203.61.61", "18.136.144.35", "35.220.174.55", "54.39.237.72"], ["157.13.61.181", "72.183.148.146", "62.251.54.163", "5.188.62.33", "82.94.216.148", "47.56.6.26", "52.221.246.188", "54.250.226.223", "54.202.87.10"], ["157.13.61.182\t", "193.35.108.106", "138.201.105.18", "52.77.246.169", "3.15.214.179", "34.229.185.163", "195.154.163.75", "178.128.59.107", "94.230.153.108"], ["157.13.61.183", "54.250.226.223", "18.231.67.137", "159.65.70.143", "46.101.199.114", "95.216.72.174", "52.209.118.89", "108.44.249.86", "94.230.153.108"]]
```

```ruby
e.map{|x|x[1..-1]}.flatten.uniq.size
=> 229
```

## より正確なシミューレーション

### ランダム・ネットワークを生成する

```ruby
n=500
nodes=[*1..n]
links=nodes.reduce({}){|m,x|m[x]=[];m}

def generate(links,nodes,m,n)
  nodes.each do |a|
    ns=nodes-[a]
    m.times do |b|
      begin
        c=(ns-[b])[rand(n-2)]
      end while links[c].member?(a)
      	links[a]<<c
    end
  end
  links
end
generate(links,nodes,8,n)
```

## ノードをランダムに50選択して調査する

```ruby
sample=nodes.shuffle[1..50]
p=sample.reduce([]){|m,x|m+=links[x].map{|y|[x,y]}}
```

### 逆リンクの数を調べる

```ruby
rl=p.reduce({}){|r,x| r[x[1]]=[];r}
p.each{|x|rl[x[1]]<<x[0]}
rl.map{|k|rl[k].size}
```

## APIの利用
https://api.bitaps.com/bitcoin/testnet/v1/nodes/list 
https://api.bitaps.com/
